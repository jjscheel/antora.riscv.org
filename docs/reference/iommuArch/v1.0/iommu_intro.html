<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: RISC-V Ratified Specifications Library</title>
    <link rel="prev" href="iommu_preface.html">
    <link rel="next" href="iommu_data_structures.html">
    <meta name="generator" content="Antora 3.1.12">
    <script>
!function (theme, navWidth) {
  if (theme === 'dark') document.documentElement.classList.add('dark-theme')
  if (navWidth) document.documentElement.style.setProperty('--nav-width', `${navWidth}px`)
}(localStorage && localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme: dark)')?.matches && 'dark'),
  localStorage && localStorage.getItem('nav-width'))
    </script>
    <link rel="stylesheet" href="../../_/css/site.css">
    <link rel="stylesheet" href="../../_/css/vendor/search.css">
    <link rel="stylesheet" href="../../_/css/vendor/page-search.css">
    <link rel="stylesheet" href="../../_/css/vendor/spring-tabs.css">

    <meta name="antora-ui-version" content="3f4ce2c51445edcfc62ee1f59ab97fffc218fb79"> 
    <meta name="version" content="v1.0">
    <meta name="component" content="iommuArch">
    <meta name="latest-version" content="false">
    <link rel="icon" href="../../_/img/favicon.ico" type="image/vnd.microsoft.icon">
  </head>
  <body class="article">
<link rel="stylesheet" type="text/css" href="/styles.css">

<header class="header" id="antora-header">
    <nav class="navbar">
        <head>
            <link data-rh="true" rel="icon" href="/img/favicon.ico">
            <link data-rh="true" rel="canonical" href="https://developer.riscv.org/ref">
            <link data-rh="true" rel="alternate" href="https://developer.riscv.org/ref" hreflang="en">
            <link data-rh="true" rel="alternate" href="https://developer.riscv.org/ref" hreflang="x-default">
            <link data-rh="true" rel="preconnect" href="https://MGVPU7BN22-dsn.algolia.net" crossorigin="anonymous">
            <link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="RISC-V Developer Portal RSS Feed">
            <link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="RISC-V Developer Portal Atom Feed">

            <link rel="search" type="application/opensearchdescription+xml" title="RISC-V Developer Portal" href="/opensearch.xml">
            <link rel="stylesheet" href="/assets/css/styles.2a6e33aa.css">
            <script src="/assets/js/runtime~main.1f8bbb5b.js" defer="defer"></script>
            <script src="/assets/js/main.0e5d05c8.js" defer="defer"></script>
        </head>
        <script>
            !function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const a=new URLSearchParams(window.location.search).entries();for(var[t,e]of a)if(t.startsWith("docusaurus-data-")){var n=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(n,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())
        </script>
            <link rel="preload" as="image" href="/img/logo.svg">
            <div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div>
            <div class="announcementBar_mb4j" role="banner">
                <div class="announcementBarPlaceholder_vyr4"></div>
                <div class="content_knG7 announcementBarContent_xLdY">congratulations, you found the RISC-V Developer Portal! ðŸŽ‰ . This site is under active development and not meant for public consumption yet.</div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div>
            <nav aria-label="Main" class="navbar ">
                <div class="navbar__inner">
                    <div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button>
                        <a class="navbar__brand" href="/">
                            <div class="navbar__logo"><img src="/img/logo.svg" alt="RISC-V Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="RISC-V Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Home</b></a>
                        <div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Specifications</a>
                            <ul class="dropdown__menu">
                                <li><a class="dropdown__link" href="/docs/spec/isa">ISA</a></li>
                                <li><a class="dropdown__link" href="/docs/spec/profiles">Profiles</a></li>
                                <li><a class="dropdown__link" docid="spec/non-isa" href="/docs/spec/non-isa">Non-ISA</a></li>
                            </ul>
                        </div>
                        <div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Developers</a>
                            <ul class="dropdown__menu">
                                <li><a class="dropdown__link" href="/docs/spec/intro">Specification Developers</a></li>
                                <li><a class="dropdown__link" href="/docs/hardware/overview">Hardware Developers</a></li>
                                <li><a class="dropdown__link" href="/docs/software/overview">Software Developers</a></li>
                            </ul>
                        </div><a class="navbar__item navbar__link" href="/blog">Blog</a><a href="https://riscv.org/community/calendar/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Events<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div>
                    <div class="navbar__items navbar__items--right">
                        <div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div>
                        <div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div>
                    </div>
                </div>
                <div role="presentation" class="navbar-sidebar__backdrop"></div>
            </nav>
            <div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper__tJE"></div>
        

    </nav>
</header><div class="body">
<div class="nav-container" data-component="iommuArch" data-version="v1.0">
  <aside class="nav">
    <div class="panels">
      <div class="nav-panel-menu is-active" data-panel="menu">
        <nav class="nav-menu">
<div class="context">
  <span class="title">IOMMU Architecture</span>
  <span class="version">v1.0</span>
  <button class="browse-version" id="browse-version">
    <svg
      height="24px"
      id="Layer_1"
      style="enable-background:new 0 0 512 512;"
      version="1.1"
      viewBox="0 0 512 512"
      width="24px"
      xml:space="preserve"
    ><g><path
          d="M256,224c-17.7,0-32,14.3-32,32s14.3,32,32,32c17.7,0,32-14.3,32-32S273.7,224,256,224L256,224z"
        ></path><path
          d="M128.4,224c-17.7,0-32,14.3-32,32s14.3,32,32,32c17.7,0,32-14.3,32-32S146,224,128.4,224L128.4,224z"
        ></path><path
          d="M384,224c-17.7,0-32,14.3-32,32s14.3,32,32,32s32-14.3,32-32S401.7,224,384,224L384,224z"
        ></path></g></svg>
  </button>
  </div><ul class="nav-list">
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">IOMMU Architecture</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link"  href="contributors.html">Contributors</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link"  href="iommu_preface.html">Preface</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link"  href="iommu_intro.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link"  href="iommu_data_structures.html">Data Structures</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link"  href="iommu_in_memory_queues.html">In-memory queue interface</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link"  href="iommu_debug.html">Debug support</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link"  href="iommu_registers.html">Memory-mapped register interface</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link"  href="iommu_sw_guidelines.html">Software guidelines</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link"  href="iommu_hw_guidelines.html">Hardware guidelines</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link"  href="iommu_extensions.html">IOMMU Extensions</a>
  </li>
</ul>
  </li>
</ul>
          <div class="toggle-sm">
            <button id="nav-toggle-2" class="nav-toggle"></button>
          </div>
        </nav>
      </div>
      <div class="nav-collapse">
        <button id="nav-collapse-toggle"><span></span></button>        
      </div>
    </div>
    <div class="nav-resize"></div>
  </aside>
</div>
<script>
!function (sidebar) {
  if (sidebar) {
    document.body.classList.add('nav-sm')
  }
}(localStorage && localStorage.getItem('sidebar') === 'close')
</script><main class="article">
<div class="toolbar" role="navigation">
  <button id="nav-toggle-1" class="nav-toggle"></button>
</div>
  <div class="content">
<aside class="sidebar">
  <div class="content">
    <div
      class="toc"
      data-title=""
      data-levels="2"
    >
      <div class="toc-menu"></div>
    </div>
    <div class="sidebar-links">
        <a href="https://github.com/riscv-non-isa/riscv-iommu/edit/antora-refactor/modules/ROOT/pages/iommu_intro.adoc">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            height="24"
            viewBox="0 0 24 24"
            width="24"
          ><path
              d="m16 2.012 3 3L16.713 7.3l-3-3zM4 14v3h3l8.299-8.287-3-3zm0 6h16v2H4z"
            ></path></svg>
          Edit this Page
        </a>
              <a href="https://github.com/riscv-non-isa/riscv-iommu" title="GitHub">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            height="512px"
            id="Layer_1"
            version="1.1"
            viewBox="0 0 512 512"
            width="512px"
          ><style type="text/css"><
              .st0{fill-rule:evenodd;clip-rule:evenodd;} ]]></style><g><path
                class="st0"
                d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"
              ></path></g></svg>
          GitHub Project
        </a>

      <a href="" title="PDF">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            height="512px"
            id="Layer_1"
            version="1.1"
            viewBox="0 0 512 512"
            width="512px"
          ><style type="text/css"><
              .st0{fill-rule:evenodd;clip-rule:evenodd;} ]]></style><g><path
                class="st0"
                d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"
              ></path></g></svg>
          Download PDF
        </a>
    </div>
  </div>
</aside>
<article class="doc">
<div class="breadcrumbs-container">
  <nav class="breadcrumbs" aria-label="breadcrumbs">
    <ul>
      <li>IOMMU Architecture</li>
      <li><a href="iommu_intro.html">Introduction</a></li>
    </ul>
  </nav>
</div><div class="sect1">
<h2 id="intro"><a class="anchor" href="#intro"></a>Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Input-Output Memory Management Unit (IOMMU), sometimes referred to as a
System MMU (SMMU), is a system-level Memory Management Unit (MMU) that connects
direct-memory-access-capable Input/Output (I/O) devices to system memory.</p>
</div>
<div class="paragraph">
<p>For each I/O device connected to the system through an IOMMU, software can
configure at the IOMMU a device context, which associates with the device a
specific virtual address space and other per-device parameters. By giving
each device its own separate device context at an IOMMU, each device can be
individually configured for a separate operating system, which may be a guest OS
or the main (host) OS. On every memory access initiated by a device, the IOMMU
identifies the originating device by some form of unique device
identifier, which the IOMMU then uses to locate the appropriate device context
within data structures supplied by software. For PCIe cite:[PCI], for example,
the originating device may be identified by the unique 16-bit triplet of PCI bus
number (8-bit), device number (5-bit), and function number (3-bit) (collectively
known as routing identifier or RID) and optionally up to 8-bit segment number
when the IOMMU supports multiple Hierarchies. This specification refers to such
unique device identifier as <code>device_id</code> and supports up to 24-bit wide
identifiers.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A Hierarchy is a PCI Express I/O interconnect topology, wherein the
Configuration Space addresses, referred to as the tuple of Bus/Device/Function
Numbers, are unique. In some contexts, a Hierarchy is also called a Segment, and
in Flit Mode, the Segment number is sometimes included in the ID of a Function.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Some devices may support shared virtual addressing which is the ability to
share process address spaces with devices. Sharing process address spaces with
devices allows to rely on core kernel memory management for DMA, removing some
complexity from application and device drivers. After binding to a device,
applications can instruct it to perform DMA on statically or dynamically
allocated buffers. To support such addressing, software can configure one or
more process contexts into the device context. Every memory access initiated
by such a device is accompanied by a unique process identifier, which the IOMMU
uses in conjunction with the unique device identifier to locate the appropriate
process context configured by software in the device context. For PCIe, for
example, the process context may be identified by the unique 20-bit process
address space identifier (PASID). This specification refers to such unique
process identifiers as <code>process_id</code> and supports up to 20-bit wide identifiers.</p>
</div>
<div class="paragraph">
<p>The IOMMU employs a two-stage address translation process to translate the IOVA
to an SPA and to enforce memory protections for the DMA. To perform address
translation and memory protection the IOMMU uses same page table formats as used
by the CPU&#8217;s MMU for the first-stage and second-stage address translation. Using
the same page table formats as the CPUâ€™s MMU removes some of the memory
management complexity for DMA. Use of an identical format also allows the same
page tables to be used simultaneously by both the CPU MMU and the IOMMU.</p>
</div>
<div class="paragraph">
<p>Although there is no option to disable two-stage address translation, either
stage may be effectively disabled by configuring the virtual memory scheme for
that stage to be <code>Bare</code> i.e. perform no address translation or memory protection.</p>
</div>
<div class="paragraph">
<p>The virtual memory scheme employed by the IOMMU may be configured individually
per device in the IOMMU. Devices perform DMA using an I/O virtual address (IOVA).
Depending on the virtual memory scheme selected for a device, the IOVA used by
the device may be a supervisor physical address (SPA), guest physical address
(GPA), or a virtual address (VA).</p>
</div>
<div class="paragraph">
<p>If the virtual memory scheme selected for both stages is <code>Bare</code> then the IOVA is
a SPA. There is no address translation or protection performed by the IOMMU.</p>
</div>
<div class="paragraph">
<p>If the virtual memory scheme selected for first-stage is <code>Bare</code> but the scheme
for the second-stage is not <code>Bare</code> then the IOVA is a GPA. The first-stage is
effectively disabled. The second-stage translates the GPA to SPA and enforces the configured
memory protections. Such a configuration would be typically employed when the
device control is passed through to a virtual machine but the Guest OS in the VM
does not use first-stage address translation to further constrain memory accesses
from such devices. Comparing to a RISC-V hart, this configuration is analogous
to two-stage address translation being in effect on a RISC-V hart with the
G-stage active and the VS-stage set to Bare.</p>
</div>
<div class="paragraph">
<p>If the virtual memory scheme selected for first-stage is not <code>Bare</code> but the
scheme for the second-stage is <code>Bare</code> then IOVA is a VA. The second-stage is
effectively disabled. The first-stage translates the VA to a SPA and enforces the configured
memory protections. This configuration would be typically employed when the
IOMMU is used by a native OS or when the control of the device is retained by
the hypervisor itself. Comparing to a RISC-V hart, this configuration is
analogous to single-stage address translation being in effect on a RISC-V hart.</p>
</div>
<div class="paragraph">
<p>If the virtual memory scheme selected for neither stage is <code>Bare</code> then the IOVA
is a VA. Two-stage address translation is in effect. The first-stage translates
the VA to a GPA and the second-stage translates the GPA to a SPA. Each stage
enforces the configured memory protections. Such a configuration would be
typically be employed when the device control is passed-through to a virtual
machine and the Guest OS in the VM uses the first-stage address translation to
further constrain the memory accessed by such devices and associated privileges
and memory protections. Comparing to a RISC-V hart, this configuration is
analogous to two-stage address translation being in effect on a RISC-V hart with
both G-stage and VS-stage active (not Bare).</p>
</div>
<div class="paragraph">
<p>DMA address translation in the IOMMU has certain performance implications for
DMA accesses as the access time may be lengthened by the time required to
determine the SPA using the software provided data structures.
Similar overheads in the CPU MMU are mitigated typically through the use of a
translation look-aside buffer (TLB) to cache these address translations such
that they may be re-used to reduce the translation overhead on subsequent
accesses. The IOMMU may employ similar address translation caches, referred as
IOMMU Address Translation Cache (IOATC). The IOMMU provides mechanisms for
software to synchronize the IOATC with the memory resident data structures used
for address translation when they are modified. Software may configure the
device context with a software defined context identifier called guest
soft-context identifier (<code>GSCID</code>) to indicate that a collection of devices are
assigned to the same VM and thus access a common virtual address space.
Software may configure the process context with a software defined context
identifier called process soft-context identifier (<code>PSCID</code>) to identify a
collection of processes that share a common virtual address space.
The IOMMU may use the <code>GSCID</code> and <code>PSCID</code> to tag entries in the IOATC to avoid
duplication and simplify invalidation operations.</p>
</div>
<div class="paragraph">
<p>Some devices may participate in the translation process and provide a device
side ATC (DevATC) for its own memory accesses. By providing a DevATC, the
device shares the translation caching responsibility and thereby reduce
probability of "thrashing" in the IOATC. The DevATC may be sized by the device
to suit its unique performance requirements and may also be used by the device
to optimize DMA latency by prefetching translations. Such mechanisms require
close cooperation of the device and the IOMMU using a protocol. For PCIe, for
example, the Address Translation Services (ATS) protocol may be used by the
device to request translations to cache in the DevATC and to synchronize it
with updates made by software address translation data structures. The
device participating in the address translation process also enables the use
of I/O page faults to avoid the core kernel memory manager from having to make
all physical memory that may be accessed by the device resident at all times.
For PCIe, for example, the device may implement the Page Request Interface (PRI)
to dynamically request the memory manager to make a page resident if it
discovers the page for which it requested a translation was not available. An
IOMMU may support specialized software interfaces and protocols with the device
to enable services such as PCIe ATS and PCIe PRI cite:[PCI].</p>
</div>
<div class="paragraph">
<p>In systems built with an Incoming Message-Signaled Interrupt Controller (IMSIC),
the IOMMU may be programmed by the hypervisor to direct message-signaled
interrupts (MSI) from devices controlled by the guest OS to a guest interrupt
file in an IMSIC. Because MSIs from devices are simply memory writes, they
would naturally be subject to the same address translation that an IOMMU
applies to other memory writes. However, the RISC-V Advanced Interrupt
Architecture cite:[AIA] requires that IOMMUs treat MSIs directed to virtual
machines specially, in part to simplify software, and in part to allow optional
support for memory-resident interrupt files. The device context is configured by
software with parameters to identify memory accesses to a virtual interrupt file
and to be translated using a MSI address translation table configured by software
in the device context.</p>
</div>
<div class="sect2">
<h3 id="glossary"><a class="anchor" href="#glossary"></a>Glossary</h3>
<table class="tableblock frame-all grid-all" style="width: 90%;">
<caption class="title">Table 1. Terms and definitions</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Term</th>
<th class="tableblock halign-center valign-top">Definition</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AIA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RISC-V Advanced Interrupt Architecture cite:[AIA].</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ATS / PCIe ATS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Address Translation Services: A PCIe protocol to support
                    DevATC cite:[PCI].</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CXL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compute Express Link bus standard.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DC /
  Device Context</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A hardware representation of state that identifies a
                    device and the VM to which the device is assigned.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DDT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Device-directory-table: A radix-tree structure traversed
                    using the unique device identifier to locate the Device
                    Context structure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DDI</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Device-directory-index: A sub-field of the unique device
                    identifier used as a index into a leaf or non-leaf DDT
                    structure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Device ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An identification number that is up to 24-bits to identify
                    the source of a DMA or interrupt request. For PCIe devices
                    this is the routing identifier (RID) cite:[PCI].</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DevATC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An address translation cache at the device.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DMA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Direct Memory Access.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GPA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Guest Physical Address: An address in the virtualized
                    physical memory space of a virtual machine.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GSCID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Guest soft-context identifier: An identification number used
                    by software to uniquely identify a collection of devices
                    assigned to a virtual machine. An IOMMU may tag IOATC
                    entries with the GSCID. Device contexts programmed with the
                    same GSCID must also be programmed with identical
                    second-stage page tables.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Guest</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Software in a virtual machine.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HPM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hardware Performance Monitor.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hypervisor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Software entity that controls virtualization.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Identifier.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IMSIC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Incoming Message-signaled Interrupt Controller.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IOATC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IOMMU Address Translation Cache: cache in IOMMU that caches
                    data structures used for address translations.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IOVA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I/O Virtual Address: Virtual address for DMA by devices.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MSI</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message Signaled Interrupts.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Operating System.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PASID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Process Address Space Identifier: It identifies the
                    address space of a process. The PASID value is provided in
                    the PASID TLP prefix of the request.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PBMT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Page-Based Memory Types.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Process Context.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PCIe</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Peripheral Component Interconnect Express bus standard
                    cite:[PCI].</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PDI</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Process-directory-index: a sub field of the unique process
                    identifier used to index into a leaf or non-leaf PDT
                    structure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PDT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Process-directory-table: A radix tree data structure
                    traversed using the unique Process identifier to locate the
                    process context structure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PMA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Physical Memory Attributes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PMP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Physical Memory Protection.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PPN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Physical Page Number.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PRI</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Page Request Interface - a PCIe protocol cite:[PCI] that enables
                    devices to request OS memory manager services to make pages
                    resident.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Process ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An identification number that is up to 20-bits to identify
                    a process context. For PCIe devices this is the PASID
                    cite:[PCI].</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PSCID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Process soft-context identifier: An identification number
                    used by software to identify a unique address space. The
                    IOMMU may tag IOATC entries with PSCID.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Page Table.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PTE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Page Table Entry. A leaf or non-leaf entry in a page table.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reserved</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A register or data structure field reserved for future use.
                    Reserved fields in data structures must be set to 0 by
                    software. Software must ignore reserved fields in registers
                    and preserve the value held in these fields when writing
                    values to other fields in the same register.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RID / PCIe RID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PCIe routing identifier cite:[PCI].</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RO</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read-only - Register bits are read-only and cannot be altered
                    by software. Where explicitly defined, these bits are used
                    to reflect changing hardware state, and as a result bit
                    values can be observed to change at run time.<br>
                    If the optional feature that would Set the bits is not
                    implemented, the bits must be hardwired to Zero</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RW</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read-Write - Register bits are read-write and are permitted
                    to be either Set or Cleared by software to the desired
                    state.<br>
                    If the optional feature that is associated with the bits is
                    not implemented, the bits are permitted to be hardwired to
                    Zero.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RW1C</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Write-1-to-clear status - Register bits indicate status when
                    read. A Set bit indicates a status event which is Cleared by
                    writing a 1b. Writing a 0b to RW1C bits has no effect.<br>
                    If the optional feature that would Set the bit is not
                    implemented, the bit must be read-only and hardwired to Zero</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RW1S</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read-Write-1-to-set - register bits indicate status when
                    read. The bit may be Set by writing 1b. Writing a 0b to RW1S
                    bits has no effect.<br>
                    If the optional feature that introduces the bit is not
                    implemented, the bit must be read-only and hardwired to Zero</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SOC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">System on a chip, also referred as system-on-a-chip and
                    system-on-chip.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SPA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Supervisor Physical Address: Physical address used to
                    to access memory and memory-mapped resources.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TLP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transaction Layer Packet.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">VA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Virtual Address.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">VM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Virtual Machine: An efficient, isolated duplicate of a real
                    computer system. In this specification it refers to the
                    collection of resources and state that is accessible when
                    a RISC-V hart supporting the hypervisor extension executes
                    with the virtualization mode set to 1.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">VMM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Virtual Machine Monitor. Also referred to as hypervisor.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">VS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Virtual Supervisor: Supervisor privilege in virtualization
                    mode.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WARL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Write Any values, Reads Legal values: Attribute of a
                    register field that is only defined for a subset of bit
                    encodings, but allow any value to be written while
                    guaranteeing to return a legal value whenever read.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WPRI</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Writes Preserve values, Reads Ignore values:
                    Attribute of a register field that is reserved for future
                    use.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="usage-models"><a class="anchor" href="#usage-models"></a>Usage models</h3>
<div class="sect3">
<h4 id="non-virtualized-os"><a class="anchor" href="#non-virtualized-os"></a>Non-virtualized OS</h4>
<div class="paragraph">
<p>A non-virtualized OS may use the IOMMU for the following significant system-level
functionalities:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Protect the operating system from bad memory accesses from errant devices</p>
</li>
<li>
<p>Support 32-bit devices in 64-bit environment (avoidance of bounce buffers)</p>
</li>
<li>
<p>Support mapping of contiguous virtual addresses to an underlying fragmented
physical addresses (avoidance of scatter/gather lists)</p>
</li>
<li>
<p>Support shared virtual addressing</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In the absence of an IOMMU a device could access any memory, such as privileged
memory, and cause malicious or unintended corruptions. This may be due to
hardware bugs, device driver bugs, or due to malicious software/hardware.</p>
</div>
<div class="paragraph">
<p>The IOMMU offers a mechanism for the OS to defend against such unintended
corruptions by limiting the memory that can be accessed by devices.  As depicted
in <a href="#fig:device-isolation">Device isolation in non-virtualized OS</a> the OS may configure the IOMMU with a page table to
translate the IOVA and thereby limit the addresses that may be accessed to those
allowed by the page table.</p>
</div>
<div id="fig:device-isolation" class="imageblock text-center">
<div class="content">
<img src="_images/non-virt-OS.svg" alt="non virt OS" width="300" height="300">
</div>
<div class="title">Figure 1. Device isolation in non-virtualized OS</div>
</div>
<div class="paragraph">
<p>Legacy 32-bit devices cannot access the memory above 4 GiB. The IOMMU, through
its address remapping capability, offers a simple mechanism for the device to
directly access any address in the system (with appropriate access permission).
Without an IOMMU, the OS must resort to copying data through buffers (also
known as bounce buffers) allocated in memory below 4 GiB. In this scenario the
IOMMU improves the system performance.</p>
</div>
<div class="paragraph">
<p>The IOMMU can be useful to perform scatter/gather DMA as it permits to allocate
large regions of memory for I/O without the need for all of the memory to be
contiguous. A contiguous virtual address range can map to such fragmented
physical addresses and the device programmed with the virtual address range.</p>
</div>
<div class="paragraph">
<p>The IOMMU can be used to support shared virtual addressing which is the ability
to share a process address space with devices. The virtual addresses used for
DMA are then translated by the IOMMU to an SPA.</p>
</div>
<div class="paragraph">
<p>When the IOMMU is used by a non-virtualized OS, the first-stage suffices to
provide the required address translation and protection function and the
second-stage may be set to Bare.</p>
</div>
</div>
<div class="sect3">
<h4 id="hypervisor"><a class="anchor" href="#hypervisor"></a>Hypervisor</h4>
<div class="paragraph">
<p>IOMMU makes it possible for a guest operating system, running in a virtual
machine, to be given direct control of an I/O device with only minimal
hypervisor intervention.</p>
</div>
<div class="paragraph">
<p>A guest OS with direct control of a device will program the device with guest
physical addresses, because that is all the OS knows. When the device then
performs memory accesses using those addresses, an IOMMU is responsible for
translating those guest physical addresses into supervisor physical addresses,
referencing address-translation data structures supplied by the hypervisor.</p>
</div>
<div class="paragraph">
<p><a href="#fig:dma-translation-direct-device-assignment">DMA translation to enable direct device assignment</a> illustrates the concept.
The device D1 is directly assigned to VM-1 and device D2 is directly assigned
to VM-2. The VMM configures a second-stage page table to be used for each device
and restricts the memory that can be accessed by D1 to VM-1 associated memory
and from D2 to VM-2 associated memory.</p>
</div>
<div id="fig:dma-translation-direct-device-assignment" class="imageblock text-center">
<div class="content">
<img src="_images/hypervisor.svg" alt="hypervisor" width="300" height="300">
</div>
<div class="title">Figure 2. DMA translation to enable direct device assignment</div>
</div>
<div class="paragraph">
<p>To handle MSIs from a device controlled by a guest OS, the hypervisor configures
an IOMMU to redirect those MSIs to a guest interrupt file in an IMSIC
(see <a href="#MSI_REDIR">MSI address translation to direct guest programmed MSI to IMSIC guest interrupt files</a>) or to a memory-resident interrupt file. The IOMMU is
responsible to use the MSI address-translation data structures supplied by the
hypervisor to perform the MSI redirection. Because every interrupt file, real or
virtual, occupies a naturally aligned 4-KiB page of address space, the required
address translation is from a virtual (guest) page address to a physical page
address, the same as supported by regular RISC-V page-based address translation.</p>
</div>
<div id="MSI_REDIR" class="imageblock text-center">
<div class="content">
<img src="_images/msi-imsic.svg" alt="msi imsic" width="500" height="400">
</div>
<div class="title">Figure 3. MSI address translation to direct guest programmed MSI to IMSIC guest interrupt files</div>
</div>
</div>
<div class="sect3">
<h4 id="guest-os"><a class="anchor" href="#guest-os"></a>Guest OS</h4>
<div class="paragraph">
<p>The hypervisor may provide a virtual IOMMU facility, through hardware
emulation or by enlightening the guest OS to use a software interface with
the Hypervisor (also known as para-virtualization). The guest OS may then use
the facilities provided by the virtual IOMMU to avail the same benefits as
those discussed for a non-virtualized OS through the use of a first-stage page
table that it controls. The hypervisor establishes a second-stage page table
that it controls to virtualize the address space for the virtual machine and to
contain memory accesses from the devices passed through to the VM to the memory
associated with the VM.</p>
</div>
<div class="paragraph">
<p>With two-stage address translations active, the IOVA is first translated to
a GPA using the first-stage page tables managed by the guest OS and the GPA
translated to a SPA using the second-stage page tables managed by the
hypervisor.</p>
</div>
<div class="paragraph">
<p><a href="#fig:iommu-for-guest-os">Address translation in IOMMU for Guest OS</a> illustrates the concept.</p>
</div>
<div id="fig:iommu-for-guest-os" class="imageblock text-center">
<div class="content">
<img src="_images/guest-OS.svg" alt="guest OS" width="500" height="400">
</div>
<div class="title">Figure 4. Address translation in IOMMU for Guest OS</div>
</div>
<div class="paragraph">
<p>The IOMMU is configured to perform address translation using a first-stage
and second-stage page table for device D1. The second-stage is typically used by
the hypervisor to translate GPA to SPA and limit the device D1 to memory
associated with VM-1. The first-stage is typically configured by the Guest OS to
translate a VA to a GPA and contain device D1 access to a subset of VM-1 memory.</p>
</div>
<div class="paragraph">
<p>For device D2 only the second-stage is active and the first-stage is set to Bare.</p>
</div>
<div class="paragraph">
<p>The host OS or hypervisor may also retain a device, such as D3, for its own use.
The first-stage suffices to provide the required address translation and
protection function for device D3 and the second-stage is set to Bare.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="placement-and-data-flow"><a class="anchor" href="#placement-and-data-flow"></a>Placement and data flow</h3>
<div class="paragraph">
<p><a href="#fig:example-soc-with-iommu">Example of IOMMUs integration in SoC.</a> shows an example of a typical system on a chip
(SOC) with RISC-V hart(s). The SOC incorporates memory controllers and several
IO devices. This SOC also incorporates two instances of the IOMMU. A device
may be directly connected to the IO Bridge and the system interconnect or may
be connected through a Root Port when a IO protocol transaction to system
interconnect transaction translation is required. In case of PCIe cite:[PCI],
for example, the Root Port is a PCIe port that maps a portion of a hierarchy
through an associated virtual PCI-PCI bridge and maps the PCIe IO protocol
transactions to the system interconnect transactions.</p>
</div>
<div class="paragraph">
<p>The first IOMMU instance, IOMMU 0 (associated with the IO Bridge 0), interfaces
a Root Port to the system fabric/interconnect. One or more endpoint devices are
interfaced to the SoC through this Root Port. In the case of PCIe, the Root Port
incorporates an ATS interface to the IOMMU that is used to support the PCIe ATS
protocol by the IOMMU.  The example shows an endpoint device with a device side
ATC (DevATC) that holds translations obtained by the device from IOMMU 0 using
the PCIe ATS protocol cite:[PCI].</p>
</div>
<div style="page-break-after: always;"></div>
<div class="paragraph">
<p>When such IO-protocol-to-system-fabric-protocol translation using a Root Port
is not required, the devices may interface directly with the system fabric.
The second IOMMU instance, IOMMU 1 (associated with the IO Bridge 1),
illustrates interfacing devices (IO Devices A and B) to the system fabric
without the use of a Root Port.</p>
</div>
<div class="paragraph">
<p>The IO Bridge is placed between the device(s) and the system interconnect to
process DMA transactions. IO Devices may perform DMA transactions using IO
Virtual Addresses (VA, GVA or GPA). The IO Bridge invokes the associated IOMMU
to translate the IOVA to a Supervisor Physical Addresses (SPA).</p>
</div>
<div class="paragraph">
<p>The IOMMU is not invoked for outbound transactions.</p>
</div>
<div id="fig:example-soc-with-iommu" class="imageblock">
<div class="content">
<img src="_images/placement.svg" alt="placement" width="800">
</div>
<div class="title">Figure 5. Example of IOMMUs integration in SoC.</div>
</div>
<div class="paragraph">
<p>The IOMMU is invoked by the IO Bridge for address translation and protection for
inbound transactions. The data associated with the inbound transactions is not
processed by the IOMMU. The IOMMU behaves like a look-aside IP to the IO Bridge
and has several interfaces (see <a href="#fig:iommu-interfaces">IOMMU interfaces.</a>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Host interface: it is an interface to the IOMMU for the harts to access
its memory-mapped registers and perform global configuration and/or
maintenance operations.</p>
</li>
<li>
<p>Device Translation Request interface: it is an interface, which receives
the translation requests from the IO Bridge. On this interface the IO Bridge
provides information about the request such as:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>The hardware identities associated with transaction - the <code>device_id</code> and
if applicable the <code>process_id</code> and its validity. The IOMMU uses the hardware
identities to retrieve the context information to perform the requested
address translations.</p>
</li>
<li>
<p>The IOVA and the type of the transaction (Translated or Untranslated).</p>
</li>
<li>
<p>Whether the request is for a read, write, execute, or an atomic operation.</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Execute requested must be explicitly associated with the request
(e.g., using a PCIe PASID). When not explicitly requested, the default must
be 0.</p>
</li>
</ol>
</div>
</li>
<li>
<p>The privilege mode associated with the request. When a privilege mode is not
explicitly associated with the request (e.g., using a PCIe PASID), the default
privilege mode must be User. For requests without a <code>process_id</code> the privilege
mode must be User.</p>
</li>
<li>
<p>The number of bytes accessed by the request.</p>
</li>
<li>
<p>The IO Bridge may also provide some additional opaque information (e.g. tags)
that are not interpreted by the IOMMU but returned along with the response
from the IOMMU to the IO Bridge. As the IOMMU is allowed to complete
translation requests out of order, such information may be used by the IO
Bridge to correlate completions to previous requests.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Data Structure interface: it is used by the IOMMU for implicit access to
memory. It is a requester interface to the IO Bridge and is used to fetch the
required data structure from main memory. This interface is used to access:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>The device and process directories to get the context information and
translation rules.</p>
</li>
<li>
<p>The first-stage and/or second-stage page table entries to translate the IOVA.</p>
</li>
<li>
<p>The in-memory queues (command-queue, fault-queue, and page-request-queue)
used to interface with software.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Device Translation Completion interface: it is an interface which
provides the completion response from the IOMMU for previously requested
address translations. The completion interface may provide information
such as:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>The status of the request, indicating if the request completed successfully
or a fault occurred.</p>
</li>
<li>
<p>If the request was completed successfully; the Supervisor Physical Address
(SPA).</p>
</li>
<li>
<p>Opaque information (e.g. tags), if applicable, associated with the request.</p>
</li>
<li>
<p>The page-based memory types (PBMT), if Svpbmt is supported, obtained from the
IOMMU address translation page tables. The IOMMU provides the page-based
memory type as resolved between the first-stage and second-stage page table
entries.</p>
</li>
</ol>
</div>
</li>
<li>
<p>ATS interface: The ATS interface, if the optional PCIe ATS capability is
supported by the IOMMU, is used to communicate with ATS capable endpoints
through the PCIe Root Port. This interface is used:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>To receive ATS translation requests from the endpoints and to return the
completions to the endpoints. The Root Port may provide an indication if the
endpoint originating the request is a CXL type 1 or type 2 device.</p>
</li>
<li>
<p>To send ATS "Invalidation Request" messages to the endpoints and to receive
the "Invalidation Completion" messages from the endpoints.</p>
</li>
<li>
<p>To receive "Page Request" and "Stop Marker" messages from the endpoints and
to send "Page Request Group Response" messages to the endpoints.</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The interfaces related to recording an incoming MSI in a memory-resident
interrupt file (MRIF) (See RISC-V Advanced Interrupt Architecture cite:[AIA])
are implementation-specific. The partitioning of responsibility between
the IOMMU and the IO bridge for recording the incoming MSI in an MRIF and
generating the associated <em>notice</em> MSI are implementation-specific.</p>
</div>
<div id="fig:iommu-interfaces" class="imageblock">
<div class="content">
<img src="_images/interfaces.svg" alt="interfaces" width="800">
</div>
<div class="title">Figure 6. IOMMU interfaces.</div>
</div>
<div class="paragraph">
<p>Similar to the RISC-V harts, physical memory attributes (PMA) and physical
memory protection (PMP) checks must be completed on all inbound IO transactions
even when the IOMMU is in bypass (<code>Bare</code> mode). The placement and integration of
the PMA and PMP checkers is a platform choice. PMA and PMP checkers reside
outside the IOMMU. The example above is showing them in the IO Bridge.</p>
</div>
<div class="paragraph">
<p>Implicit accesses by the IOMMU itself through the Data Structure interface are
checked by the PMA checker. PMAs are tightly tied to a given physical platformâ€™s
organization, and many details are inherently platform-specific.</p>
</div>
<div class="paragraph">
<p>The memory accesses performed by the IOMMU using the Data Structure interface
need not be ordered in general with the device-initiated memory accesses.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The IOMMU may generate implicit memory accesses on the Data Structure interface
to access data structures needed to perform the address translations. Such
accesses must not be blocked by the original device-initiated memory access.</p>
</div>
<div class="paragraph">
<p>The IO bridge may perform ordering of memory accesses on the Data Structure
interface to satisfy the necessary hazard checks and other rules as defined by
the IO bridge and the system interconnect.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The IOMMU provides the resolved PBMT (PMA, IO, NC) along with the translated
address on the device translation completion interface to the IO Bridge. The
PMA checker in the IO Bridge may use the provided PBMT to override the PMA(s)
for the associated memory pages.</p>
</div>
<div class="paragraph">
<p>The PMP checker may use the hardware ID of the bus access initiator to determine
physical memory access privileges. As the IOMMU itself is a bus access initiator
for its implicit accesses, the IOMMU hardware ID may be used by the PMP checker
to select the appropriate access control rules.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The IOMMU does not validate the authenticity of the hardware IDs provided by
the IO bridge.</p>
</div>
<div class="paragraph">
<p>The IO bridge and/or the root ports must include suitable mechanisms to
authenticate the hardware IDs. In some SOCs this may be trivially achieved as a
property of the devices being integrated into the SOC and their IDs being
immutable. For PCIe, for example, the PCIe defined Access Control Services (ACS)
Source Validation capabilities may be used to authenticate the hardware IDs.
Other implementation-specific methods in the IO bridge may be provided to
perform such authentication.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="iommu-features"><a class="anchor" href="#iommu-features"></a>IOMMU features</h3>
<div class="paragraph">
<p>Version 1.0 of the RISC-V IOMMU specification supports the following
features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Memory-based device context to locate parameters and address translation
structures. The device context is located using the hardware-provided
unique <code>device_id</code>. The supported <code>device_id</code> width may be up to 24 bits.</p>
</li>
<li>
<p>Memory-based process context to locate parameters and address translation
structures using hardware-provided unique <code>process_id</code>. The supported
<code>process_id</code> may be up to 20 bits.</p>
</li>
<li>
<p>16-bit GSCIDs and 20-bit PSCIDs.</p>
</li>
<li>
<p>Two-stage address translation.</p>
</li>
<li>
<p>Page based virtual-memory system as specified by the RISC-V Privileged
specification cite:[PRIV] to allow software flexibility to either use a
common page table for the CPU MMU as well as the IOMMU or to use a
separate page table for the IOMMU.</p>
</li>
<li>
<p>Up to 57-bit virtual-address width, 56-bit system-physical-address, and
59-bit guest-physical-address width.</p>
</li>
<li>
<p>Hardware updating of PTE Accessed and Dirty bits.</p>
</li>
<li>
<p>Identifying memory accesses to a virtual interrupt file and MSI address
translation using MSI page tables specified by the RISC-V Advanced
Interrupt Architecture cite:[AIA].</p>
</li>
<li>
<p>Svnapot and Svpbmt extensions.</p>
</li>
<li>
<p>PCIe ATS and PRI services cite:[PCI]. Support for translating an IOVA to a
GPA instead of a SPA in response to a translation request.</p>
</li>
<li>
<p>A hardware performance monitor (HPM).</p>
</li>
<li>
<p>MSI and wire-signaled interrupts to request service from software.</p>
</li>
<li>
<p>A register interface for software to request an address translation to
support debug.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Features supported by the IOMMU may be discovered using the <code>capabilities</code>
register <a href="#CAP">[CAP]</a>.</p>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="iommu_preface.html">Preface</a></span>
  <span class="next"><a href="iommu_data_structures.html">Data Structures</a></span>
</nav>
</article>  </div>
</main>
<div class="modal micromodal-slide" id="modal-versions" aria-hidden="true">
    <div class="modal__overlay" tabindex="-1" data-micromodal-close>
        <div class="modal__container" role="dialog" aria-modal="true">
            <main class="modal__content" id="modal-versions-content">
              <button data-micromodal-close class="modal-versions-close">
                <svg width="28px" height="28px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><defs><style>.cls-1h{fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:2px;}</style></defs><title/><g id="cross"><line class="cls-1h" x1="7" x2="25" y1="7" y2="25"/><line class="cls-1h" x1="7" x2="25" y1="25" y2="7"/></g></svg>
              </button>
                  <ul class="nav-versions">
                      <li class="component">
                        <div>
                          <a class="title" href="../../ffh/v1.0/index.html">ACPI Functional Fixed Hardware</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="../../ffh/v1.0/index.html">
      v1.0
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                      <li class="component">
                        <div>
                          <a class="title" href="../../aia/v1.0/index.html">Advanced Interrupt Architecture</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="../../aia/v1.0/index.html">
      v1.0
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                      <li class="component">
                        <div>
                          <a class="title" href="../../etrace/v1.0/index.html">E-Trace Encapsulation Specification</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="../../etrace/v1.0/index.html">
      v1.0
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                      <li class="component">
                        <div>
                          <a class="title" href="../../psabi/v1.0/index.html">ELF psABI Specification</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="../../psabi/v1.0/index.html">
      v1.0
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                      <li class="component">
                        <div>
                          <a class="title" href="index.html">IOMMU Architecture</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="index.html">
      v1.0
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                      <li class="component">
                        <div>
                          <a class="title" href="../../isa/index.html">ISA Specifications</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="../../isa/index.html">
      default
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                      <li class="component">
                        <div>
                          <a class="title" href="../../reri/v1.0/index.html">RERI Architecture</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="../../reri/v1.0/index.html">
      v1.0
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                      <li class="component">
                        <div>
                          <a class="title" href="../../qos/v1.0/index.html">RISC-V Capacity and Bandwidth QoS Register Interface</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="../../qos/v1.0/index.html">
      v1.0
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                      <li class="component">
                        <div>
                          <a class="title" href="../../plic/v1.0.0/index.html">RISC-V Platform-Level Interrupt Controller</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="../../plic/v1.0.0/index.html">
      v1.0.0
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                      <li class="component">
                        <div>
                          <a class="title" href="../../semihost/v1.0/index.html">semihosting</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="../../semihost/v1.0/index.html">
      v1.0
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                  </ul>
            </main>
        </div>
    </div>
</div>

</div>
<footer class="hidden">
</footer><script src="../../_/js/vendor/import.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
<script async src="../../_/js/vendor/spring-tabs.js" data-sync-storage-key="docs:preferred-tab"></script>
  </body>
</html>
