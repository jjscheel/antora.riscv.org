<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: RISC-V Ratified Specifications Library</title>
    <link rel="prev" href="MSLevel.html">
    <link rel="next" href="IPIs.html">
    <meta name="generator" content="Antora 3.1.12">
    <script>
!function (theme, navWidth) {
  if (theme === 'dark') document.documentElement.classList.add('dark-theme')
  if (navWidth) document.documentElement.style.setProperty('--nav-width', `${navWidth}px`)
}(localStorage && localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme: dark)')?.matches && 'dark'),
  localStorage && localStorage.getItem('nav-width'))
    </script>
    <link rel="stylesheet" href="../../_/css/site.css">
    <link rel="stylesheet" href="../../_/css/vendor/search.css">
    <link rel="stylesheet" href="../../_/css/vendor/page-search.css">
    <link rel="stylesheet" href="../../_/css/vendor/spring-tabs.css">

    <meta name="antora-ui-version" content="1e2798650bcf82e415abe50a131b399fc753d9ef"> 
    <meta name="version" content="v1.0">
    <meta name="component" content="aia">
    <meta name="latest-version" content="false">
    <link rel="icon" href="../../_/img/favicon.ico" type="image/vnd.microsoft.icon">
  </head>
  <body class="article">


<header class="header" id="antora-header">
    <nav class="navbar">
        <head>
            <link data-rh="true" rel="icon" href="/img/favicon.ico">
            <link data-rh="true" rel="canonical" href="https://developer.riscv.org/ref">
            <link data-rh="true" rel="alternate" href="https://developer.riscv.org/ref" hreflang="en">
            <link data-rh="true" rel="alternate" href="https://developer.riscv.org/ref" hreflang="x-default">
            <link data-rh="true" rel="preconnect" href="https://MGVPU7BN22-dsn.algolia.net" crossorigin="anonymous">
            <link rel="stylesheet" type="text/css" href="/docs/reference/_/docusaurus-styles-copy-08-25.css">

        </head>
        <script>
            !function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const a=new URLSearchParams(window.location.search).entries();for(var[t,e]of a)if(t.startsWith("docusaurus-data-")){var n=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(n,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())
        </script>
            <link rel="preload" as="image" href="/img/logo.svg">
            <div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div>
            <div class="announcementBar_mb4j" role="banner">
                <div class="announcementBarPlaceholder_vyr4"></div>
                <div class="content_knG7 announcementBarContent_xLdY">congratulations, you found the RISC-V Developer Portal! ðŸŽ‰ . This site is under active development and not meant for public consumption yet.</div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div>
            <nav aria-label="Main" class="navbar ">
                <div class="navbar__inner">
                    <div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button>
                        <a class="navbar__brand" href="/">
                            <div class="navbar__logo"><img src="/img/logo.svg" alt="RISC-V Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="RISC-V Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Home</b></a>
                        <div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Specifications</a>
                            <ul class="dropdown__menu">
                                <li><a class="dropdown__link" href="/docs/spec/isa">ISA</a></li>
                                <li><a class="dropdown__link" href="/docs/spec/profiles">Profiles</a></li>
                                <li><a class="dropdown__link" docid="spec/non-isa" href="/docs/spec/non-isa">Non-ISA</a></li>
                            </ul>
                        </div>
                        <div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Developers</a>
                            <ul class="dropdown__menu">
                                <li><a class="dropdown__link" href="/docs/spec/intro">Specification Developers</a></li>
                                <li><a class="dropdown__link" href="/docs/hardware/overview">Hardware Developers</a></li>
                                <li><a class="dropdown__link" href="/docs/software/overview">Software Developers</a></li>
                            </ul>
                        </div><a class="navbar__item navbar__link" href="/blog">Blog</a><a href="https://riscv.org/community/calendar/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Events<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div>
                    <div class="navbar__items navbar__items--right">
                      <div class="navbarSearchContainer_Bca1">
                        <button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)">
                          <span class="DocSearch-Button-Container">
                            <svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true">
                              <path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path>
                            </svg>
                            <span class="DocSearch-Button-Placeholder">Search</span>
                          </span>
                          <span class="DocSearch-Button-Keys"></span>
                        </button>
                      </div>
                    </div>
                </div>
                <div role="presentation" class="navbar-sidebar__backdrop"></div>
            </nav>
            <div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper__tJE"></div>
        

    </nav>
</header><div class="body">
<div class="nav-container" data-component="aia" data-version="v1.0">
  <aside class="nav">
    <div class="panels">
      <div class="nav-panel-menu is-active" data-panel="menu">
        <nav class="nav-menu">
<div class="context">
  <span class="title">Advanced Interrupt Architecture</span>
  <span class="version">v1.0</span>
  <button class="browse-version" id="browse-version">
    <svg
      height="24px"
      id="Layer_1"
      style="enable-background:new 0 0 512 512;"
      version="1.1"
      viewBox="0 0 512 512"
      width="24px"
      xml:space="preserve"
    ><g><path
          d="M256,224c-17.7,0-32,14.3-32,32s14.3,32,32,32c17.7,0,32-14.3,32-32S273.7,224,256,224L256,224z"
        ></path><path
          d="M128.4,224c-17.7,0-32,14.3-32,32s14.3,32,32,32c17.7,0,32-14.3,32-32S146,224,128.4,224L128.4,224z"
        ></path><path
          d="M384,224c-17.7,0-32,14.3-32,32s14.3,32,32,32s32-14.3,32-32S401.7,224,384,224L384,224z"
        ></path></g></svg>
  </button>
  </div><ul class="nav-list">
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">RISC-V Advanced Interrupt Architecture</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link"  href="intro.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link"  href="CSRs.html">Control and Status Registers (CSRs) Added to Harts</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link"  href="IMSIC.html">Incoming MSI Controller (IMSIC)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link"  href="AdvPLIC.html">Advanced Platform-Level Interrupt Controller (APLIC)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link"  href="MSLevel.html">Interrupts for Machine and Supervisor Levels</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link"  href="VSLevel.html">Interrupts for Virtual Machines (VS Level)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link"  href="IPIs.html">Interprocessor Interrupts (IPIs)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link"  href="IOMMU.html">IOMMU Support for MSIs to Virtual Machines</a>
  </li>
</ul>
  </li>
</ul>
          <div class="toggle-sm">
            <button id="nav-toggle-2" class="nav-toggle"></button>
          </div>
        </nav>
      </div>
      <div class="nav-collapse">
        <button id="nav-collapse-toggle"><span></span></button>        
      </div>
    </div>
    <div class="nav-resize"></div>
  </aside>
</div>
<script>
!function (sidebar) {
  if (sidebar) {
    document.body.classList.add('nav-sm')
  }
}(localStorage && localStorage.getItem('sidebar') === 'close')
</script><main class="article">
<div class="toolbar" role="navigation">
  <button id="nav-toggle-1" class="nav-toggle"></button>
</div>
  <div class="content">
<aside class="sidebar">
  <div class="content">
    <div
      class="toc"
      data-title=""
      data-levels="2"
    >
      <div class="toc-menu"></div>
    </div>
    <div class="sidebar-links">
        <a href="https://github.com/riscv/riscv-aia/edit/antora-refactor/modules/ROOT/pages/VSLevel.adoc">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            height="24"
            viewBox="0 0 24 24"
            width="24"
          ><path
              d="m16 2.012 3 3L16.713 7.3l-3-3zM4 14v3h3l8.299-8.287-3-3zm0 6h16v2H4z"
            ></path></svg>
          Edit this Page
        </a>
              <a href="https://github.com/riscv/riscv-aia" title="GitHub">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            height="512px"
            id="Layer_1"
            version="1.1"
            viewBox="0 0 512 512"
            width="512px"
          ><style type="text/css"><
              .st0{fill-rule:evenodd;clip-rule:evenodd;} ]]></style><g><path
                class="st0"
                d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"
              ></path></g></svg>
          GitHub Project
        </a>

      
    </div>
  </div>
</aside>
<article class="doc">
<div class="breadcrumbs-container">
  <nav class="breadcrumbs" aria-label="breadcrumbs">
    <ul>
      <li><a href="index.html">Advanced Interrupt Architecture</a></li>
      <li>RISC-V Advanced Interrupt Architecture</li>
      <li><a href="VSLevel.html">Interrupts for Virtual Machines (VS Level)</a></li>
    </ul>
  </nav>
</div><div class="sect1">
<h2 id="VSLevel"><a class="anchor" href="#VSLevel"></a>Interrupts for Virtual Machines (VS Level)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When the H extension is implemented, a hart&#8217;s set of possible
privilege modes includes the <em>virtual supervisor</em> (VS) and <em>virtual
user</em> (VU) modes for hosting virtual harts. The Advanced Interrupt
Architecture adds to the H extension new interrupt facilities
aligned with those described earlier for supervisor-level interrupts.</p>
</div>
<div class="paragraph">
<p>As introduced in <a href="#CSRs">[CSRs]</a>, several hypervisor and VS
CSRs are added: <code>hvien</code>, <code>hvictl</code>, <code>hviprio1</code>, <code>hviprio2</code>, <code>vsiselect</code>, <code>vsireg</code>, <code>vstopei</code>, and <code>vstopi</code>. (And for RV32, the following
high-half CSRs are also added: <code>hidelegh</code>, <code>hvienh</code>, <code>hviph</code>, <code>hviprio1h</code>, <code>hviprio2h</code>, <code>vsiph</code> and <code>vsieh</code>.) As always, when
executing in VS-mode or VU-mode, the VS CSRs substitute for the
corresponding supervisor CSRs.</p>
</div>
<div class="paragraph">
<p>To give software that runs in a virtual machine the appearance of
executing on a real machine that implements the Advanced Interrupt
Architecture at supervisor level, responsibility is shared between
hypervisor software and the hardware facilities described in this
chapter. While some behaviors can be handled directly by hardware,
others require significant emulation by the hypervisor, sometimes with
hardware assistance.</p>
</div>
<div class="sect2">
<h3 id="vs-level-external-interrupts-with-a-guest-interrupt-file"><a class="anchor" href="#vs-level-external-interrupts-with-a-guest-interrupt-file"></a>VS-level external interrupts with a guest interrupt file</h3>
<div class="paragraph">
<p>When a hart implements the H extension, it is recommended that
the hart also have an IMSIC with guest interrupt files. Assuming guest
interrupt files are available, each can be assigned to a virtual hart at
the physical hart to act as the supervisor-level interrupt file for that
virtual hart. If there are \(N\) guest interrupt files, then
\(N\) virtual harts at that physical hart may each have a
physical guest interrupt file to serve as its (virtual) supervisor-level
interrupt file. The guest interrupt file for the current virtual hart is
always indicated by the VGEIN field of CSR <code>hstatus</code>. When VGEIN is not the valid
number of a guest interrupt file, the current virtual hart has no guest
interrupt file to act as its supervisor-level interrupt file.</p>
</div>
<div class="paragraph">
<p>When <code>hstatus</code>.VGEIN is the valid number of a guest interrupt file, values of <code>vsiselect</code> in
the range <code>0x70</code>-<code>0xFF</code> select registers of this guest interrupt file, just as
values of <code>siselect</code> in the same range select registers of the IMSIC&#8217;s true
supervisor-level interrupt file. The registers of an interrupt file that
are accessed indirectly through <code>vsiselect</code> and <code>vsireg</code> are documented in
<a href="#IMSIC">[IMSIC]</a> on the IMSIC, along with IMSIC-only CSR <code>vstopei</code>.
Because all IMSIC interrupt files act identically, the guest interrupt
file that a virtual hart accesses through CSRs <code>siselect</code>, <code>sireg</code>, and <code>stopei</code> is
indistinguishable from a true supervisor-level interrupt file as seen
from S-mode (or HS-mode).</p>
</div>
<div class="paragraph">
<p>In addition to an IMSIC at each hart, a virtual machine may also need to
see a PLIC or APLIC. However, unlike an IMSIC&#8217;s ability to provide
physical guest interrupt files for virtual harts, a PLIC or APLIC must
be emulated for a virtual machine by the hypervisor.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The Advanced Interrupt Architecture does not currently include hardware
assistance for virtualizing an APLIC. For small numbers of harts, such
hardware would be substantially larger than that required to implement
guest interrupt files for an IMSIC. It is assumed that most
high-performance I/O can be done through devices that can send MSIs
directly to guest interrupt files (such as devices attached through a
PCI Express interconnect). For the types of devices whose interrupts
must go through a (virtual) APLIC, the overhead cost of emulating the
APLIC is expected to be less significant.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When a virtual hart appears to have an IMSIC because a guest interrupt
file is assigned to it, all external interrupts, real or emulated,
destined for the virtual hart must go through this perceived IMSIC. A
hypervisor can easily inject an emulated external interrupt into the
guest interrupt file selected by <code>hstatus</code>.VGEIN by setting a bit in the
interrupt-pending array indirectly accessed through <code>vsiselect</code> and <code>vsireg</code>. When a virtual
hart has a guest interrupt file, a hypervisor is not normally expected
to set bit VSEIP in CSR <code>hvip</code>.</p>
</div>
<div class="paragraph">
<p>In the special case that an emulated APLIC for a virtual machine has a
wired interrupt source that equates to an actual interrupt source of a
real APLIC, if software running in this virtual machine configures its
virtual APLIC to forward interrupts from that source as MSIs to a
specific virtual hart, the hypervisor can configure the real APLIC to
forward the actual interrupts directly as MSIs to the virtual hartâ€™s
guest interrupt file. In this way, although the hypervisor must trap and
emulate the virtual machineâ€™s memory accesses that configure the
forwarding of interrupts at the virtual APLIC, the interrupts themselves
can be converted automatically into real MSIs for the guest interrupt
file, without the hypervisor being invoked for each arriving interrupt.</p>
</div>
<div class="sect3">
<h4 id="direct-control-of-a-device-by-a-guest-os"><a class="anchor" href="#direct-control-of-a-device-by-a-guest-os"></a>Direct control of a device by a guest OS</h4>
<div class="paragraph">
<p>To ensure proper support for interrupts, two conditions must be met
before a hypervisor may allow a guest OS running in a virtual machine to
directly control a physical device that sends MSIs: First, each virtual
hart must have a guest interrupt file assigned to it, giving each its
own apparent IMSIC within the virtual machine. Second, interrupts from
the device must be signaled by wire through an APLIC that can translate
these interrupts into MSIs, or the system must have an IOMMU that can
translate the addresses of MSI memory writes made by the device itself.</p>
</div>
<div class="paragraph">
<p>If a guest OS directly controls a device capable of sending MSIs, it
will naturally configure MSIs at the device with the guest physical
addresses the OS sees for the IMSICs of its virtual harts, not knowing
that these addresses are only virtual. When the device performs a memory
write for an MSI, the destination address of this write must be
translated by the IOMMU from the guest physical address assigned by the
guest OS into the true physical address of the target guest interrupt
file, using a translation table supplied by the hypervisor.</p>
</div>
<div class="paragraph">
<p>By design, the translation an IOMMU must do for device MSIs is
fundamentally no different than the address translation the IOMMU
already must perform for other memory accesses from the same device,
converting guest physical addresses into true physical addresses.
Because each virtual hart is assigned a dedicated, physical guest
interrupt file that is indistinguishable from a true supervisor-level
interrupt file, no translation is needed for the data of an MSI write,
which specifies the interrupt&#8217;s identity number in the target interrupt
file.</p>
</div>
</div>
<div class="sect3">
<h4 id="virtHartMigration"><a class="anchor" href="#virtHartMigration"></a>Migrating a virtual hart to a different guest interrupt file</h4>
<div class="paragraph">
<p>When it is necessary to move a virtual hart from one physical hart to
another, if the virtual hart uses a guest interrupt file, the specific
guest interrupt file assigned to it must change from the one in use at
the old physical hart to a different one at the new physical hart.
Because each guest interrupt file is physically tied to a single
physical hart, a virtual hart cannot bring its guest interrupt file with
it when it moves.</p>
</div>
<div class="paragraph">
<p>The process of migrating a virtual hart from one guest interrupt file to
another is more complex than moving most other state held by the virtual
hart. After the destination guest interrupt file has been chosen at the
new physical hart, the following steps are recommended:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>At the old interrupt file, save to memory the values of registers <code>eidelivery</code> and
<code>eithreshold</code>, and set <code>eidelivery</code> = 0.</p>
</li>
<li>
<p>At the new interrupt file, set <code>eidelivery</code> = 0, and zero all implemented
interrupt-pending bits (the <code>eip</code> array).</p>
</li>
<li>
<p>Modify the relevant translation tables at all IOMMUs so that MSIs for
this virtual interrupt file are now sent to the new physical interrupt
file. Likewise, if any interrupts at an APLIC are forwarded by MSIs to
the old interrupt file, reconfigure the APLIC to send them to the new
interrupt file. As needed, synchronize with all IOMMUs and APLICs to
ensure that no straggler MSIs will arrive at the old interrupt file
after this step. Synchronizing with an APLIC can be accomplished using
the algorithm of <a href="#AdvPLIC-MSISync">[AdvPLIC-MSISync]</a>.</p>
</li>
<li>
<p>At the old interrupt file, dump to memory all implemented
interrupt-pending and interrupt-enable bits (the <code>eip</code> and <code>eie</code> arrays). After this
step is done, the old interrupt file is no longer in use.</p>
</li>
<li>
<p>At the new interrupt file, logically OR the interrupt-pending bits
that were saved in step 4 into the new interrupt file, using instruction
CSRS to write to the <code>eip</code> array. Also, load the interrupt-enable bits that
were saved in step 4 into the <code>eie</code> array.</p>
</li>
<li>
<p>At the new interrupt file, load registers <code>eithreshold</code> and <code>eidelivery</code> with the values that
were saved in step 1.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Resuming execution of the virtual hart at the new physical hart is not
recommended until the entire interrupt file has been fully migrated.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Resuming execution of the virtual hart before the interrupt file is
fully migrated could allow software running in the virtual machine to
see multiple MSIs arriving from a single device in an order that should
not happen. While this would rarely matter in practice, it runs the risk
of wedging a device driver that depends (perhaps inadvertently) on a
valid ordering of events.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="vs-level-external-interrupts-without-a-guest-interrupt-file"><a class="anchor" href="#vs-level-external-interrupts-without-a-guest-interrupt-file"></a>VS-level external interrupts without a guest interrupt file</h3>
<div class="paragraph">
<p>Although it is recommended that harts implementing the hypervisor
extension also have IMSICs with guest interrupt files, this is not a
requirement. Even assuming guest interrupt files exist, it may happen
that there are more virtual harts at a physical hart than guest
interrupt files, leaving some virtual harts without one. In either case,
a hypervisor must emulate an external interrupt controller for a virtual
hart without the benefit of a guest interrupt file allocated to the
virtual hart.</p>
</div>
<div class="paragraph">
<p>When emulating an external interrupt controller for a virtual hart, if
configurable interrupt priority is not supported for the virtual hart
other than for external interrupts, then external interrupts may be
asserted to VS level simply by setting bit VSEIP in <code>hvip</code>, as defined by the
H extension. However, to emulate both an external interrupt
controller and priority configurability for non-external interrupts, a
hypervisor must make use of CSR <code>hvictl</code> (Hypervisor Virtual Interrupt Control),
described later in the next section.</p>
</div>
</div>
<div class="sect2">
<h3 id="interrupts-at-vs-level"><a class="anchor" href="#interrupts-at-vs-level"></a>Interrupts at VS level</h3>
<div class="sect3">
<h4 id="configuring-priorities-of-major-interrupts-at-vs-level"><a class="anchor" href="#configuring-priorities-of-major-interrupts-at-vs-level"></a>Configuring priorities of major interrupts at VS level</h4>
<div class="paragraph">
<p>Like for supervisor level, the Advanced Interrupt Architecture
optionally allows major VS-level interrupts to be configured by software
to intermix in priority with VS-level external interrupts. As documented
in <a href="#intrs-S">[intrs-S]</a>, interrupt priorities for
supervisor level are configured by the <code>iprio</code> array accessed indirectly through
CSRs <code>siselect</code> and <code>sireg</code>. The <code>siselect</code> addresses for the <code>iprio</code> array registers are <code>0x30</code>-<code>0x3F</code>.</p>
</div>
<div class="paragraph">
<p>VS level has its own <code>vsiselect</code> and <code>vsireg</code>, but unlike supervisor level, there are no
registers at <code>vsiselect</code> addresses <code>0x30</code>-<code>0x3F</code>. When <code>vsiselect</code> has a value in the range <code>0x30</code>-<code>0x3F</code>, an attempt
from VS-mode to access <code>sireg</code> (really <code>vsireg</code>) causes a virtual instruction exception.
To give a virtual hart the illusion of an array of <code>iprio</code> registers accessed
through <code>siselect</code> and <code>sireg</code>, a hypervisor must emulate the VS-level <code>iprio</code> array when accesses
to <code>sireg</code> from VS-mode cause virtual instruction traps.</p>
</div>
<div class="paragraph">
<p>Instead of a physical VS-level <code>iprio</code> array, a separate hardware mechanism is
provided for configuring the priorities of a subset of interrupts for VS
level, using hypervisor CSRs <code>hviprio1</code> and <code>hviprio2</code>. The subset of major interrupt numbers
whose priority may be configured in hardware are these:</p>
</div>
<table class="tableblock frame-none grid-none fit-content center">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Supervisor software interrupt</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Supervisor timer interrupt</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">13</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Counter overflow interrupt</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">14-23</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Reserved for standard local interrupts</em></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For interrupts directed to VS level, software-configurable priorities
are not supported in hardware for standard local interrupts in the range
32-48.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For custom interrupts, priority configurability may be supported in
hardware by custom CSRs, expanding upon <code>hviprio1</code> and <code>hviprio2</code> for standard interrupts.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Registers <code>hviprio1</code> and <code>hviprio2</code> have these formats:</p>
</div>
<div class="paragraph">
<p><code>hviprio1</code>:</p>
</div>
<table class="tableblock frame-none grid-none fit-content center">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bits 7:0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Reserved for priority number for interrupt 0; reads as
zero</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bits 15:8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Priority number for interrupt 1, supervisor software
interrupt<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bits 23:16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Reserved for priority number for interrupt 4; reads as
zero</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bits 31:24</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Priority number for interrupt 5, supervisor timer
interrupt</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bits 39:32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Reserved for priority number for interrupt 8; reads as
zero</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bits 47:40</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Priority number for interrupt 13, counter overflow
interrupt</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bits 55:48</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Priority number for interrupt 14</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bits 63:56</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Priority number for interrupt 15</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><code>hviprio2</code>:</p>
</div>
<table class="tableblock frame-none grid-none fit-content center">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bits 7:0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Priority number for interrupt 16</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bits 15:8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Priority number for interrupt 17</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bits 23:16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Priority number for interrupt 18</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bits 31:24</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Priority number for interrupt 19</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bits 39:32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Priority number for interrupt 20</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bits 47:40</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Priority number for interrupt 21</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bits 55:48</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Priority number for interrupt 22</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bits 63:56</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Priority number for interrupt 23</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Each priority number in <code>hviprio1</code> and <code>hviprio2</code> is a <strong>WARL</strong> unsigned integer field that is either
read-only zero or implements a minimum of IPRIOLEN bits or 6 bits,
whichever is larger, and preferably all 8 bits. Implementations may
freely choose which priority number fields are read-only zeros, but all
other fields must implement the same number of integer bits. A minimal
implementation of these CSRs has them both be read-only zeros.</p>
</div>
<div class="paragraph">
<p>A hypervisor can choose to employ registers <code>hviprio1</code> and <code>hviprio2</code> when emulating the
(virtual) supervisor-level <code>iprio</code> array accessed indirectly through <code>siselect</code> and <code>sireg</code> (really
<code>vsiselect</code> and <code>vsireg</code>) for a virtual hart. For interrupts not in the subset supported by
<code>hviprio1</code> and <code>hviprio2</code>, the priority number bytes in the emulated <code>iprio</code> array can be read-only
zeros.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Providing hardware support for configurable priority for only a subset
of major interrupts at VS level is a compromise. The utility of being
able to control interrupt priorities at VS level is arguably illusory
when all traps to M-mode and HS-modeâ€”both interrupts and synchronous
exceptionsâ€”have absolute priority, and when each virtual hart may also
be competing for resources against other virtual harts well beyond its
control. Nevertheless, priority configurability has been made possible
for the most likely subset of interrupts, while minimizing the number of
added CSRs that must be swapped on a virtual hart switch.</p>
</div>
<div class="paragraph">
<p>Major interrupts outside the priority-configurable subset can still be
directed to VS level, but their priority will simply be the default
order defined in <a href="#majorIntrs">[majorIntrs]</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If a hypervisor really must emulate configurability of priority for
interrupts beyond the subset supported by <code>hviprio1</code> and <code>hviprio2</code>, it can do so with extra
effort by setting bit VTI of CSR <code>hvictl</code>, described in the next subsection.</p>
</div>
</div>
<div class="sect3">
<h4 id="virtual-interrupts-for-vs-level"><a class="anchor" href="#virtual-interrupts-for-vs-level"></a>Virtual interrupts for VS level</h4>
<div class="paragraph">
<p>Assuming a virtual hart does not need configurable priority for major
interrupts beyond the subset supported in hardware by <code>hviprio1</code> and <code>hviprio2</code>, a hypervisor
can assert interrupts to the virtual hart using CSRs <code>hvien</code> (Hypervisor
Virtual-Interrupt-Enable) and <code>hvip</code> (Hypervisor Virtual-Interrupt-Pending
bits). These CSRs affect interrupts for VS level much the same way that <code>mvien</code>
and <code>mvip</code> do for supervisor level, as explained in
<a href="#virtIntrs-S">[virtIntrs-S]</a>.</p>
</div>
<div class="paragraph">
<p>Each bit of registers <code>hvien</code> and <code>hvip</code> corresponds with an interrupt number in the
range 0-63. Bits 12:0 of <code>hvien</code> are reserved and must be read-only zeros, while
bits 12:0 of <code>hvip</code> are defined by the H extension. Specifically,
bits 10, 6, and 2 of <code>hvip</code> are writable bits that correspond to VS-level
external interrupts (VSEIP), VS-level timer interrupts (VSTIP), and
VS-level software interrupts (VSSIP), respectively.</p>
</div>
<div class="paragraph">
<p>The following applies only to the CSR bits for interrupt numbers 13-63:
When a bit in <code>hideleg</code> is one, then the same bit position in <code>vsip</code> is an alias for the
corresponding bit in <code>sip</code>. Else, when a bit in <code>hideleg</code> is zero and the matching bit
in <code>hvien</code> is one, the same bit position in <code>vsip</code> is an alias for the corresponding
bit in <code>hvip</code>. A bit in <code>vsip</code> is read-only zero when the corresponding bits in <code>hideleg</code> and <code>hvien</code>
are both zero. The combined effects of <code>hideleg</code> and <code>hvien</code> on <code>vsip</code> and <code>vsie</code> are summarized in <a href="#intrFilteringForVS">The effects of <code>hideleg</code> and <code>hvien</code> on <code>vsip</code> and <code>vsie</code> for major interrupts 13-63.</a>.</p>
</div>
<table id="intrFilteringForVS" class="tableblock frame-all grid-all fit-content center">
<caption class="title">Table 1. The effects of <code>hideleg</code> and <code>hvien</code> on <code>vsip</code> and <code>vsie</code> for major interrupts 13-63.</caption>
<colgroup>
<col>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top"><code>hideleg</code>[\(n\)]</th>
<th class="tableblock halign-center valign-top"><code>hvien</code>[\(n\)]</th>
<th class="tableblock halign-center valign-top"><code>vsip</code>[\(n\)]</th>
<th class="tableblock halign-center valign-top"><code>vsie</code>[\(n\)]</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Read-only 0</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Read-only 0</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Alias of <code>hvip</code>[\(n\)]</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Writable</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Alias of <code>sip</code>[\(n\)]</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Alias of <code>sie</code>[\(n\)]</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For interrupt numbers 13-63, a bit in <code>vsie</code> is writable if and only if the
corresponding bit is set in either <code>hideleg</code> or <code>hvien</code>. When an interrupt is delegated
by <code>hideleg</code>, the writable bit in <code>vsie</code> is an alias of the corresponding bit in <code>sie</code>; else
it is an independent writable bit. The H extension specifies
when bits 12:0 of <code>vsie</code> are aliases of bits in <code>hie</code>. As usual, bits that are not
writable in <code>vsie</code> must be read-only zeros.</p>
</div>
<div class="paragraph">
<p>If a bit of <code>hideleg</code> is zero and the corresponding bit in <code>hvien</code> is changed from zero to
one, then the value of the matching bit in <code>vsie</code> becomes UNSPECIFIED. Likewise, if a bit
of <code>hvien</code> is one and the corresponding bit in <code>hideleg</code> is changed from one to zero, the
value of the matching bit in <code>vsie</code> again becomes UNSPECIFIED.</p>
</div>
<div class="paragraph">
<p>For interrupt numbers 13-63, implementations may freely choose which
bits of <code>hvien</code> are writable and which bits are read-only zero or one. If such a
bit in <code>hvien</code> is read-only zero (preventing the virtual interrupt from being
enabled), the same bit should be read-only zero in <code>hvip</code>. All other bits for
interrupts 13-63 must be writable in <code>hvip</code>.</p>
</div>
<div class="paragraph">
<p>CSR <code>hvictl</code> (Hypervisor Virtual Interrupt Control) provides further flexibility
for injecting interrupts into VS level in situations not fully supported
by the facilities described thus far, but only with more active
involvement of the hypervisor. A hypervisor must use <code>hvictl</code> for any of the
following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>asserting for VS level a major interrupt not supported by <code>hvien</code> and <code>hvip</code>;</p>
</li>
<li>
<p>implementing configurability of priorities at VS level for major
interrupts beyond those supported by <code>hviprio1</code> and <code>hviprio2</code>; or</p>
</li>
<li>
<p>emulating an external interrupt controller for a virtual hart without
the use of an IMSICâ€™s guest interrupt file, while also supporting
configurable priorities both for external interrupts and for major
interrupts to the virtual hart.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Among the possible uses, <code>hvictl</code> is needed for a hypervisor
to fully emulate HS-mode in VS-mode, which is a requirement for
the hosting of nested hypervisors without paravirtualization.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The format of <code>hvictl</code> is:</p>
</div>
<table class="tableblock frame-none grid-none fit-content center">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bit 30</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">VTI</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bits 27:16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IID (<strong>WARL</strong>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bit 9</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DPR</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bit 8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IPRIOM</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bits 7:0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IPRIO</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>All other bits of <code>hvictl</code> are reserved and read as zeros.</p>
</div>
<div class="paragraph">
<p>When bit VTI (Virtual Trap Interrupt control) = 1, attempts from VS-mode
to explicitly access CSRs <code>sip</code> and <code>sie</code> (or, for RV32 only, <code>siph</code> and <code>sieh</code>) cause a virtual
instruction exception. Furthermore, for any given CSR, if there is some
circumstance in which a write to the register may cause a bit of <code>vsip</code> to
change from one to zero, excluding bit 9 for external interrupts (SEIP),
then when VTI = 1, a virtual instruction exception is raised also for
any attempt by the guest to write this register. Both the value being
written to the CSR and the value of <code>vsip</code> (before or after) are ignored for
determining whether to raise the exception. (Hence a write would not
actually need to change a bit of <code>vsip</code> from one to zero for the exception to
be raised.) In particular, if register <code>vstimecmp</code> is implemented (from extension
Sstc), then attempts from VS-mode to write to <code>stimecmp</code> (or, for RV32 only, <code>stimecmph</code>)
cause a virtual instruction exception when VTI = 1.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For the standard local interrupts (major identities 13-23 and 32-47),
and for software interrupts (SSI), the corresponding interrupt-pending
bits in <code>vsip</code> are defined as "sticky," meaning a guest can clear them only
by writing directly to <code>sip</code> (really <code>vsip</code>). Among the standard-defined interrupts,
that leaves only timer interrupts (STI), which can potentially be
cleared in <code>vsip</code> by writing a new value to <code>vstimecmp</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>All <code>hvictl</code> fields together can affect the value of CSR <code>vstopi</code> (Virtual Supervisor Top
Interrupt) and therefore the interrupt identity reported in <code>vscause</code> when an
interrupt traps to VS-mode. IID is a <strong>WARL</strong> unsigned integer field with at
least 6 implemented bits, while IPRIO is always the full 8 bits. If
\(k\) bits are implemented for IID, then all values 0 through
\({2}^{k}-{1}\) are supported, and a write to <code>hvictl</code> sets
IID equal to bits (\({15}+k\)):16 of the value written.</p>
</div>
<div class="paragraph">
<p>For a virtual interrupt specified for VS level by <code>hvictl</code>, if VTI = 1 and
\({IID} \neq {9}\), field DPR (Default Priority
Rank) determines the interruptâ€™s presumed default priority order
relative to a (virtual) supervisor external interrupt (SEI), major
identityÂ 9, as follows:</p>
</div>
<table class="tableblock frame-none grid-none fit-content center">
<colgroup>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">0 = interrupt has higher default priority than an SEI</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">1 = interrupt has lower default priority than an SEI</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>When <code>hvictl</code>.IID = 9, DPR is ignored.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Register <code>hvictl</code> has no effect on any of <code>mip</code>, <code>sip</code>, <code>hip</code>, or <code>vsip</code>;
it affects only <code>vstopi</code> and the trapping of some instructions.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="vstopi"><a class="anchor" href="#vstopi"></a>Virtual supervisor top interrupt CSR (<code>vstopi</code>)</h4>
<div class="paragraph">
<p>Read-only CSR <code>vstopi</code> is VSXLEN bits wide and has the same format as <code>stopi</code>:</p>
</div>
<table class="tableblock frame-none grid-none fit-content center">
<colgroup>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">bits 27:16 IID</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">bits 7:0   IPRIO</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><code>vstopi</code> returns information about the highest-priority interrupt for VS level,
found from among these candidates (prefixed by + signs):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>if bit 9 is one in both <code>vsip</code> and <code>vsie</code>, <code>hstatus</code>.VGEIN is the valid number of a guest
interrupt file, and <code>vstopei</code> is not zero:</p>
<div class="ulist">
<ul>
<li>
<p>+ a supervisor external interrupt (code 9) with the priority number indicated by <code>vstopei</code>;</p>
</li>
</ul>
</div>
</li>
<li>
<p>if bit 9 is one in both <code>vsip</code> and <code>vsie</code>, <code>hstatus</code>.VGEIN = 0, and <code>hvictl</code> fields IID = 9 and
\({IPRIO} \neq {0}\):</p>
<div class="ulist">
<ul>
<li>
<p>+ a supervisor external interrupt (code 9) with priority number <code>hvictl</code>.IPRIO;</p>
</li>
</ul>
</div>
</li>
<li>
<p>if bit 9 is one in both <code>vsip</code> and <code>vsie</code>, and neither of the first two cases
applies:</p>
<div class="ulist">
<ul>
<li>
<p>+ a supervisor external interrupt (code 9) with priority number 256;</p>
</li>
</ul>
</div>
</li>
<li>
<p>if <code>hvictl</code>.VTI = 0:</p>
<div class="ulist">
<ul>
<li>
<p>+ the highest-priority pending-and-enabled major interrupt indicated by <code>vsip</code> and <code>vsie</code>
other than a supervisor external interrupt (code 9), using the priority numbers assigned
by <code>hviprio1</code> and <code>hviprio2</code>;</p>
</li>
</ul>
</div>
</li>
<li>
<p>if <code>hvictl</code> fields VTI = 1 and \({IID} \neq {9}\):</p>
<div class="ulist">
<ul>
<li>
<p>+ the major interrupt specified by <code>hvictl</code> fields IID, DPR, and IPRIO.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the list above, all "supervisor" external interrupts are virtual,
directed to VS level, having major codeÂ 9 at VS level.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The list of candidate interrupts can be reduced to two finalists
relatively easily by observing that the first three list items are
mutually exclusive of one another, and the remaining two items are also
mutually exclusive of one another.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When <code>hvictl</code>.VTI = 1, the absence of an interrupt for VS level can be indicated
only by setting <code>hvictl</code>.IID = 9. Software might want to use the pair IID = 9,
IPRIO = 0 generally to represent <em>no interrupt</em> in <code>hvictl</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When no interrupt candidates satisfy the conditions of the list above,
<code>vstopi</code> is zero. Else, <code>vstopi</code> fields IID and IPRIO are determined by the
highest-priority interrupt from among the candidates. The usual priority
order for supervisor level applies, as specified by
<a href="#TableintrPrios-S">[TableintrPrios-S]</a>, except that priority
numbers are taken from the candidate list above, not from the
supervisor-level <code>iprio</code> array. Ties in nominal priority are broken as usual by
the default priority order from
<a href="#TablemajorIntrs">[TablemajorIntrs]</a>, unless <code>hvictl</code> fields VTI = 1 and
\({IID} \neq {9}\) (last item in the candidate list
above), in which case default priority order is determined solely by
<code>hvictl</code>.DPR. If bit IPRIOM (IPRIO Mode) of <code>hvictl</code> is zero, IPRIO in <code>vstopi</code> is 1; else, if the
priority number for the highest-priority candidate is within the range 1
to 255, IPRIO is that value; else, IPRIO is set to either 0 or 255 in
the manner documented for <code>stopi</code> in <a href="#stopi">[stopi]</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="interrupt-traps-to-vs-mode"><a class="anchor" href="#interrupt-traps-to-vs-mode"></a>Interrupt traps to VS-mode</h4>
<div class="paragraph">
<p>The Advanced Interrupt Architecture modifies the H extension
such that an interrupt is pending at VS level if and only
if <code>vstopi</code> is not zero. CSRs <code>vsip</code> and <code>vsie</code> do not by themselves determine whether a
VS-level interrupt is pending, though they may do so indirectly through
their effect on <code>vstopi</code>.</p>
</div>
<div class="paragraph">
<p>Whenever <code>vstopi</code> is not zero, if either the current privilege mode is VS-mode
and the SIE bit in CSR <code>vsstatus</code> is one, or the current privilege mode is VU-mode,
a trap is taken to VS-mode for the interrupt indicated by field IID of <code>vstopi</code>.</p>
</div>
<div class="paragraph">
<p>The Exception Code field of <code>vscause</code> must implement at least as many bits as
needed to represent the largest value that field IID of <code>vstopi</code> can have for the
given hart.</p>
</div>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="MSLevel.html">Interrupts for Machine and Supervisor Levels</a></span>
  <span class="next"><a href="IPIs.html">Interprocessor Interrupts (IPIs)</a></span>
</nav>
</article>  </div>
</main>
<div class="modal micromodal-slide" id="modal-versions" aria-hidden="true">
    <div class="modal__overlay" tabindex="-1" data-micromodal-close>
        <div class="modal__container" role="dialog" aria-modal="true">
            <main class="modal__content" id="modal-versions-content">
              <button data-micromodal-close class="modal-versions-close">
                <svg width="28px" height="28px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><defs><style>.cls-1h{fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:2px;}</style></defs><title/><g id="cross"><line class="cls-1h" x1="7" x2="25" y1="7" y2="25"/><line class="cls-1h" x1="7" x2="25" y1="25" y2="7"/></g></svg>
              </button>
                  <ul class="nav-versions">
                      <li class="component">
                        <div>
                          <a class="title" href="../../ffh/v1.0/index.html">ACPI Functional Fixed Hardware</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="../../ffh/v1.0/index.html">
      v1.0
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                      <li class="component">
                        <div>
                          <a class="title" href="index.html">Advanced Interrupt Architecture</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="index.html">
      v1.0
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                      <li class="component">
                        <div>
                          <a class="title" href="../../etrace/v1.0/index.html">E-Trace Encapsulation Specification</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="../../etrace/v1.0/index.html">
      v1.0
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                      <li class="component">
                        <div>
                          <a class="title" href="../../psabi/v1.0/index.html">ELF psABI Specification</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="../../psabi/v1.0/index.html">
      v1.0
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                      <li class="component">
                        <div>
                          <a class="title" href="../../iommuArch/v1.0/index.html">IOMMU Architecture</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="../../iommuArch/v1.0/index.html">
      v1.0
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                      <li class="component">
                        <div>
                          <a class="title" href="../../isa/index.html">ISA Specifications</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="../../isa/index.html">
      default
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                      <li class="component">
                        <div>
                          <a class="title" href="../../reri/v1.0/index.html">RERI Architecture</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="../../reri/v1.0/index.html">
      v1.0
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                      <li class="component">
                        <div>
                          <a class="title" href="../../qos/v1.0/index.html">RISC-V Capacity and Bandwidth QoS Register Interface</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="../../qos/v1.0/index.html">
      v1.0
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                      <li class="component">
                        <div>
                          <a class="title" href="../../plic/v1.0.0/index.html">RISC-V Platform-Level Interrupt Controller</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="../../plic/v1.0.0/index.html">
      v1.0.0
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                      <li class="component">
                        <div>
                          <a class="title" href="../../semihost/v1.0/index.html">semihosting</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="../../semihost/v1.0/index.html">
      v1.0
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                  </ul>
            </main>
        </div>
    </div>
</div>

</div>
<footer class="hidden">
</footer><script src="../../_/js/vendor/import.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
<script async src="../../_/js/vendor/spring-tabs.js" data-sync-storage-key="docs:preferred-tab"></script>
  </body>
</html>
