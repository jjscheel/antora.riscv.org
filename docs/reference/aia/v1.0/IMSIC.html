<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: RISC-V Ratified Specifications Library</title>
    <link rel="prev" href="CSRs.html">
    <link rel="next" href="AdvPLIC.html">
    <meta name="generator" content="Antora 3.1.12">
    <script>
!function (theme, navWidth) {
  if (theme === 'dark') document.documentElement.classList.add('dark-theme')
  if (navWidth) document.documentElement.style.setProperty('--nav-width', `${navWidth}px`)
}(localStorage && localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme: dark)')?.matches && 'dark'),
  localStorage && localStorage.getItem('nav-width'))
    </script>
    <link rel="stylesheet" href="../../_/css/site.css">
    <link rel="stylesheet" href="../../_/css/vendor/search.css">
    <link rel="stylesheet" href="../../_/css/vendor/page-search.css">
    <link rel="stylesheet" href="../../_/css/vendor/spring-tabs.css">

    <meta name="antora-ui-version" content="3f4ce2c51445edcfc62ee1f59ab97fffc218fb79"> 
    <meta name="version" content="v1.0">
    <meta name="component" content="aia">
    <meta name="latest-version" content="false">
    <link rel="icon" href="../../_/img/favicon.ico" type="image/vnd.microsoft.icon">
  </head>
  <body class="article">
<link rel="stylesheet" type="text/css" href="/docusaurus-styles-copy-08-25.css">

<header class="header" id="antora-header">
    <nav class="navbar">
        <head>
            <link data-rh="true" rel="icon" href="/img/favicon.ico">
            <link data-rh="true" rel="canonical" href="https://developer.riscv.org/ref">
            <link data-rh="true" rel="alternate" href="https://developer.riscv.org/ref" hreflang="en">
            <link data-rh="true" rel="alternate" href="https://developer.riscv.org/ref" hreflang="x-default">
            <link data-rh="true" rel="preconnect" href="https://MGVPU7BN22-dsn.algolia.net" crossorigin="anonymous">
            <link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="RISC-V Developer Portal RSS Feed">
            <link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="RISC-V Developer Portal Atom Feed">

            <link rel="search" type="application/opensearchdescription+xml" title="RISC-V Developer Portal" href="/opensearch.xml">
            <link rel="stylesheet" href="/assets/css/styles.2a6e33aa.css">
            <script src="/assets/js/runtime~main.1f8bbb5b.js" defer="defer"></script>
            <script src="/assets/js/main.0e5d05c8.js" defer="defer"></script>
        </head>
        <script>
            !function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const a=new URLSearchParams(window.location.search).entries();for(var[t,e]of a)if(t.startsWith("docusaurus-data-")){var n=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(n,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())
        </script>
            <link rel="preload" as="image" href="/img/logo.svg">
            <div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div>
            <div class="announcementBar_mb4j" role="banner">
                <div class="announcementBarPlaceholder_vyr4"></div>
                <div class="content_knG7 announcementBarContent_xLdY">congratulations, you found the RISC-V Developer Portal! ðŸŽ‰ . This site is under active development and not meant for public consumption yet.</div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div>
            <nav aria-label="Main" class="navbar ">
                <div class="navbar__inner">
                    <div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button>
                        <a class="navbar__brand" href="/">
                            <div class="navbar__logo"><img src="/img/logo.svg" alt="RISC-V Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="RISC-V Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Home</b></a>
                        <div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Specifications</a>
                            <ul class="dropdown__menu">
                                <li><a class="dropdown__link" href="/docs/spec/isa">ISA</a></li>
                                <li><a class="dropdown__link" href="/docs/spec/profiles">Profiles</a></li>
                                <li><a class="dropdown__link" docid="spec/non-isa" href="/docs/spec/non-isa">Non-ISA</a></li>
                            </ul>
                        </div>
                        <div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Developers</a>
                            <ul class="dropdown__menu">
                                <li><a class="dropdown__link" href="/docs/spec/intro">Specification Developers</a></li>
                                <li><a class="dropdown__link" href="/docs/hardware/overview">Hardware Developers</a></li>
                                <li><a class="dropdown__link" href="/docs/software/overview">Software Developers</a></li>
                            </ul>
                        </div><a class="navbar__item navbar__link" href="/blog">Blog</a><a href="https://riscv.org/community/calendar/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Events<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div>
                    <div class="navbar__items navbar__items--right">
                        <div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div>
                        <div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div>
                    </div>
                </div>
                <div role="presentation" class="navbar-sidebar__backdrop"></div>
            </nav>
            <div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper__tJE"></div>
        

    </nav>
</header><div class="body">
<div class="nav-container" data-component="aia" data-version="v1.0">
  <aside class="nav">
    <div class="panels">
      <div class="nav-panel-menu is-active" data-panel="menu">
        <nav class="nav-menu">
<div class="context">
  <span class="title">Advanced Interrupt Architecture</span>
  <span class="version">v1.0</span>
  <button class="browse-version" id="browse-version">
    <svg
      height="24px"
      id="Layer_1"
      style="enable-background:new 0 0 512 512;"
      version="1.1"
      viewBox="0 0 512 512"
      width="24px"
      xml:space="preserve"
    ><g><path
          d="M256,224c-17.7,0-32,14.3-32,32s14.3,32,32,32c17.7,0,32-14.3,32-32S273.7,224,256,224L256,224z"
        ></path><path
          d="M128.4,224c-17.7,0-32,14.3-32,32s14.3,32,32,32c17.7,0,32-14.3,32-32S146,224,128.4,224L128.4,224z"
        ></path><path
          d="M384,224c-17.7,0-32,14.3-32,32s14.3,32,32,32s32-14.3,32-32S401.7,224,384,224L384,224z"
        ></path></g></svg>
  </button>
  </div><ul class="nav-list">
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">RISC-V Advanced Interrupt Architecture</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link"  href="intro.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link"  href="CSRs.html">Control and Status Registers (CSRs) Added to Harts</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link"  href="IMSIC.html">Incoming MSI Controller (IMSIC)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link"  href="AdvPLIC.html">Advanced Platform-Level Interrupt Controller (APLIC)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link"  href="MSLevel.html">Interrupts for Machine and Supervisor Levels</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link"  href="VSLevel.html">Interrupts for Virtual Machines (VS Level)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link"  href="IPIs.html">Interprocessor Interrupts (IPIs)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link"  href="IOMMU.html">IOMMU Support for MSIs to Virtual Machines</a>
  </li>
</ul>
  </li>
</ul>
          <div class="toggle-sm">
            <button id="nav-toggle-2" class="nav-toggle"></button>
          </div>
        </nav>
      </div>
      <div class="nav-collapse">
        <button id="nav-collapse-toggle"><span></span></button>        
      </div>
    </div>
    <div class="nav-resize"></div>
  </aside>
</div>
<script>
!function (sidebar) {
  if (sidebar) {
    document.body.classList.add('nav-sm')
  }
}(localStorage && localStorage.getItem('sidebar') === 'close')
</script><main class="article">
<div class="toolbar" role="navigation">
  <button id="nav-toggle-1" class="nav-toggle"></button>
</div>
  <div class="content">
<aside class="sidebar">
  <div class="content">
    <div
      class="toc"
      data-title=""
      data-levels="2"
    >
      <div class="toc-menu"></div>
    </div>
    <div class="sidebar-links">
        <a href="https://github.com/riscv/riscv-aia/edit/antora-refactor/modules/ROOT/pages/IMSIC.adoc">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            height="24"
            viewBox="0 0 24 24"
            width="24"
          ><path
              d="m16 2.012 3 3L16.713 7.3l-3-3zM4 14v3h3l8.299-8.287-3-3zm0 6h16v2H4z"
            ></path></svg>
          Edit this Page
        </a>
              <a href="https://github.com/riscv/riscv-aia" title="GitHub">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            height="512px"
            id="Layer_1"
            version="1.1"
            viewBox="0 0 512 512"
            width="512px"
          ><style type="text/css"><
              .st0{fill-rule:evenodd;clip-rule:evenodd;} ]]></style><g><path
                class="st0"
                d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"
              ></path></g></svg>
          GitHub Project
        </a>

      <a href="" title="PDF">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            height="512px"
            id="Layer_1"
            version="1.1"
            viewBox="0 0 512 512"
            width="512px"
          ><style type="text/css"><
              .st0{fill-rule:evenodd;clip-rule:evenodd;} ]]></style><g><path
                class="st0"
                d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"
              ></path></g></svg>
          Download PDF
        </a>
    </div>
  </div>
</aside>
<article class="doc">
<div class="breadcrumbs-container">
  <nav class="breadcrumbs" aria-label="breadcrumbs">
    <ul>
      <li><a href="index.html">Advanced Interrupt Architecture</a></li>
      <li>RISC-V Advanced Interrupt Architecture</li>
      <li><a href="IMSIC.html">Incoming MSI Controller (IMSIC)</a></li>
    </ul>
  </nav>
</div><div class="sect1">
<h2 id="IMSIC"><a class="anchor" href="#IMSIC"></a>Incoming MSI Controller (IMSIC)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>An Incoming MSI Controller (IMSIC) is an optional RISC-V hardware component
that is closely coupled with a hart, one IMSIC per hart. An IMSIC
receives and records incoming message-signaled interrupts (MSIs) for a
hart, and signals to the hart when there are pending and enabled
interrupts to be serviced.</p>
</div>
<div class="paragraph">
<p>An IMSIC has one or more memory-mapped registers in the machine&#8217;s
address space for receiving MSIs. Aside from those memory-mapped
registers, software interacts with an IMSIC primarily through several RISC-V CSRs at the attached hart.</p>
</div>
<div class="sect2">
<h3 id="IMSIC-intrFilesAndIdents"><a class="anchor" href="#IMSIC-intrFilesAndIdents"></a>Interrupt files and interrupt identities</h3>
<div class="paragraph">
<p>In a RISC-V system, MSIs are directed not just to a specific hart but to a
specific privilege level of a specific hart, such as machine or
supervisor level. Furthermore, when a hart implements the H
extension, an IMSIC may optionally allow MSIs to be directed to a
specific virtual hart at virtual supervisor level (VS level).</p>
</div>
<div class="paragraph">
<p>For each privilege level and each virtual hart to which MSIs may be
directed at a hart, the hart&#8217;s IMSIC contains a separate <em>interrupt
file</em>. Assuming a hart implements supervisor mode, its IMSIC has at
least two interrupt files, one for machine level and the other for
supervisor level. When a hart also implements the H extension,
its IMSIC may have additional interrupt files for virtual harts, called
<em>guest interrupt files</em>. The number of guest interrupt files an IMSIC
has for virtual harts is exactly <em>GEILEN</em>, the number of supported guest
external interrupts, as defined by the H extension.</p>
</div>
<div class="paragraph">
<p>Each individual interrupt file consists mainly of two arrays of bits of
the same size, one array for recording MSIs that have arrived but are
not yet serviced (interrupt-pending bits), and the other array for
specifying which interrupts the hart will currently accept
(interrupt-enable bits). Each bit position in the two arrays corresponds
with a different interrupt <em>identity number</em> by which MSIs from
different sources are distinguished at an interrupt file. Because an
IMSIC is the external interrupt controller for a hart, an interrupt
file&#8217;s interrupt identities become the <em>minor identities</em> for external
interrupts at the attached hart.</p>
</div>
<div class="paragraph">
<p>The number of interrupt identities supported by an interrupt file (and
hence the number of active bits in each array) is one less than a
multiple of 64, and may be a minimum of 63 and a maximum of 2047.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Platform standards may increase the minimum number of interrupt
identities that must be implemented by each interrupt file.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When an interrupt file supports \(N\) distinct interrupt
identities, valid identity numbers are between 1 and \(N\)
inclusive. The identity numbers within this range are said to be
implemented by the interrupt file; numbers outside this range are not
implemented. The number zero is never a valid interrupt identity.</p>
</div>
<div class="paragraph">
<p>IMSIC hardware does not assume any connection between the interrupt
identity numbers at one interrupt file and those at another interrupt
file. Software is commonly expected to assign the same interrupt
identity number to different MSI sources at different interrupt files,
without coordination across interrupt files. Thus the total number of
MSI sources that can be separately distinguished within a system is
potentially the product of the number of interrupt identities at a
single interrupt file times the total number of interrupt files in the
system, over all harts.</p>
</div>
<div class="paragraph">
<p>It is not necessarily the case that all interrupt files in a system are
the same size (implement the same number of interrupt identities). For a
given hart, the interrupt files for guest external interrupts must all
be the same size, but the interrupt files at machine level and at
supervisor level may differ in size from those of guest external
interrupts, and from each other. Likewise, the interrupt files of
different harts may be different sizes.</p>
</div>
<div class="paragraph">
<p>A platform might provide a means for software to configure the number of
interrupt files in an IMSIC and/or their sizes, such as by allowing a
smaller interrupt file at machine level to be traded for a larger one at
supervisor level, or vice versa, for example. Any such configurability
is outside the scope of this specification. It is recommended, however,
that only machine level be given the power to change the number and
sizes of interrupt files in an IMSIC.</p>
</div>
</div>
<div class="sect2">
<h3 id="MSIEncoding"><a class="anchor" href="#MSIEncoding"></a>MSI encoding</h3>
<div class="paragraph">
<p>Established standards (in particular, for PCI and PCI Express) dictate
that an individual message-signaled interrupt (MSI) from a device takes
the form of a naturally aligned 32-bit write by the device, with the
address and value both configured at the device (or device controller)
by software. Depending on the versions of the standards to which a
device or controller conforms, the address might be restricted to the
lower 4-GiB (32-bit) range, and the value written might be limited to a
16-bit range, with the upper 16 bits always being zeros.</p>
</div>
<div class="paragraph">
<p>When RISC-V harts have IMSICs, an MSI from a device is normally sent directly
to an individual hart that was selected by software to handle the
interrupt (presumably based on some interrupt affinity policy). An MSI
is directed to a specific privilege level, or to a specific virtual
hart, via the corresponding interrupt file that exists in the receiving
hart&#8217;s IMSIC. The MSI write address is the physical address of a
particular word-size register that is physically connected to the target
interrupt file. The MSI write data is simply the identity number of the
interrupt to be made pending in that interrupt file (becoming eventually
the minor identity for an external interrupt to the attached hart).</p>
</div>
<div class="paragraph">
<p>By configuring an MSI&#8217;s address and data at a device, system software
fully controls: (a) which hart receives a particular device interrupt,
(b) the target privilege level or virtual hart, and (c) the identity
number that represents the MSI in the target interrupt file. Elements a
and b are determined by which interrupt file is targeted by the MSI
address, while element c is communicated by the MSI data.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As the maximum interrupt identity number an IMSIC can support is 2047, a
16-bit limit on MSI data values presents no problem.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When the H extension is implemented and a device is being
managed directly by a guest operating system, MSI addresses from the
device are initially guest physical addresses, as they are configured at
the device by the guest OS. These guest addresses must be translated by
an IOMMU, which gets configured by the hypervisor to redirect those MSIs
to the interrupt files for the correct guest external interrupts. For
more on this topic, see <a href="#IOMMU">[IOMMU]</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="interrupt-priorities"><a class="anchor" href="#interrupt-priorities"></a>Interrupt priorities</h3>
<div class="paragraph">
<p>Within a single interrupt file, interrupt priorities are determined
directly from interrupt identity numbers. Lower identity numbers have
higher priority.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Because MSIs give software complete control over the assignment of
identity numbers in an interrupt file, software is free to select
identity numbers that reflect the relative priorities desired for
interrupts.</p>
</div>
<div class="paragraph">
<p>It is true that software could adjust interrupt priorities more
dynamically if interrupt files included an array of priority numbers to
assign to each interrupt identity. However, we believe that such
additional flexibility would not be utilized often enough to justify the
extra hardware expense. In fact, for many systems currently employing
MSIs, it is common practice for software to ignore interrupt priorities
entirely and act as though all interrupts had equal priority.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>An interrupt file&#8217;s lowest identity numbers have been given the highest
priorities, not the reverse order, because it is only for the
highest-priority interrupts that priority order may need to be carefully
managed, yet it is the low-numbered identities, 1Â through 63 (or perhaps
1 through 127), that are guaranteed to exist across all systems.
Consider, for example, that an interrupt file&#8217;s highest-priority
interruptâ€”presumably the most time-criticalâ€”is always identity number 1.
If priority order were reversed, the highest-priority interrupt would
have different identity numbers on different machines, depending on how
many identities are implemented by interrupt files. The ability for
software to assign fixed identity numbers to the highest-priority
interrupts is considered worth any discomfort that may be felt from
interrupt priorities being the reverse of the natural number order.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="reset-and-revealed-state"><a class="anchor" href="#reset-and-revealed-state"></a>Reset and revealed state</h3>
<div class="paragraph">
<p>Upon reset of an IMSIC, all the state of its interrupt files becomes
valid and consistent but otherwise UNSPECIFIED, except possibly for the <code>eidelivery</code> register of
machine-level and supervisor-level interrupt files, as specified in
<a href="#IMSIC-reg-eidelivery">External interrupt delivery enable register (<code>eidelivery</code>)</a>.</p>
</div>
<div class="paragraph">
<p>If an IMSIC contains a supervisor-level interrupt file and software at
the attached hart enables S-mode that was previously disabled (e.g. by
changing bit S of CSR <code>misa</code> from zero to one), all state of the
supervisor-level interrupt file is valid and consistent but otherwise UNSPECIFIED. Likewise, if an IMSIC contains guest interrupt files and software at the attached hart enables the H extension that was previously disabled (e.g. by changing bit H of <code>misa</code> from zero to one), all state of the IMSIC&#8217;s guest interrupt files is valid and consistent but otherwise UNSPECIFIED.</p>
</div>
</div>
<div class="sect2">
<h3 id="IMSIC-memRegion"><a class="anchor" href="#IMSIC-memRegion"></a>Memory region for an interrupt file</h3>
<div class="paragraph">
<p>Each interrupt file in an IMSIC has one or two memory-mapped 32-bit
registers for receiving MSI writes. These memory-mapped registers are
located within a naturally aligned 4-KiB region (a page) of physical
address space that exists for the interrupt file, i.e., one page per
interrupt file.</p>
</div>
<div class="paragraph">
<p>The layout of an interrupt-file&#8217;s memory region is:</p>
</div>
<table class="tableblock frame-none grid-none fit-content center">
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">offset</th>
<th class="tableblock halign-left valign-top">size</th>
<th class="tableblock halign-left valign-top">register name</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" colspan="3"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4 bytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>seteipnum_le</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x004</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4 bytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>seteipnum_be</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>All other bytes in an interrupt file&#8217;s 4-KiB memory region are reserved
and must be implemented as read-only zeros.</p>
</div>
<div class="paragraph">
<p>Only naturally aligned 32-bit simple reads and writes are supported
within an interrupt file&#8217;s memory region. Writes to read-only bytes are
ignored. For other forms of accesses (other sizes, misaligned accesses,
or AMOs), an IMSIC implementation should preferably report an access
fault or bus error but must otherwise ignore the access.</p>
</div>
<div class="paragraph">
<p>If \(i\) is an implemented interrupt identity number, writing
valueÂ \(i\) in little-endian byte order to <code>seteipnum_le</code> (Set External Interrupt-Pending bit by Number, Little-Endian) causes the pending bit for interruptÂ \(i\) to be set to one. A write to <code>seteipnum_le</code> is ignored if the value written is not an implemented interrupt identity number in little-endian byte order.</p>
</div>
<div class="paragraph">
<p>For systems that support big-endian byte order, if \(i\) is an
implemented interrupt identity number, writing value \(i\) in
big-endian byte order to <code>seteipnum_be</code> (Set External Interrupt-Pending bit by Number, Big-Endian) causes the pending bit for interrupt \(i\) to be set to one. A write to <code>seteipnum_be</code> is ignored if the value written is not an implemented interrupt identity number in big-endian byte order. Systems that support only little-endian byte order may choose to ignore all
writes to <code>seteipnum_be</code>.</p>
</div>
<div class="paragraph">
<p>In most systems, <code>seteipnum_le</code> is the write port for MSIs directed to this interrupt file. For systems built mainly for big-endian byte order, <code>seteipnum_be</code> may serve as the write port for MSIs directed to this interrupt file from some devices.</p>
</div>
<div class="paragraph">
<p>A read of <code>seteipnum_le</code> or <code>seteipnum_be</code> returns zero in all cases.</p>
</div>
<div class="paragraph">
<p>When not ignored, writes to an interrupt file&#8217;s memory region are
guaranteed to be reflected in the interrupt file eventually, but not
necessarily immediately. For a single interrupt file, the effects of
multiple writes (stores) to its memory region, though arbitrarily
delayed, always occur in the same order as the <em>global memory order</em> of
the stores as defined by the RISC-V Unprivileged ISA.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In most circumstances, any delay between the completion of a write to an
interrupt file&#8217;s memory region and the effect of the write on the
interrupt file is indistinguishable from other delays in the memory
system. However, if a hart writes to a <code>seteipnum_le</code> or <code>seteipnum_be</code> register of its own IMSIC, then a delay between the completion of the store instruction and the consequent setting of an interrupt-pending bit in the interrupt file may be visible to the hart.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="IMSIC-systemMemRegions"><a class="anchor" href="#IMSIC-systemMemRegions"></a>Arrangement of the memory regions of multiple interrupt files</h3>
<div class="paragraph">
<p>Each interrupt file that an IMSIC implements has its own memory region
as described in the previous section, occupying exactly one 4-KiB page
of machine address space. When practical, the memory pages of the
machine-level interrupt files of all IMSICs should be located together
in one part of the address space, and the memory pages of all
supervisor-level and guest interrupt files should similarly be located
together in another part of the address space, according to the rules
below.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The main reason for separating the machine-level interrupt files from
the other interrupt files in the address space is so harts that
implement physical memory protection (PMP) can grant supervisor-level
access to all supervisor-level and guest interrupt files using only a
single PMP table entry. If the memory pages for machine-level interrupt
files are instead interleaved with those of lower-privilege interrupt
files, the number of PMP table entries needed for granting
supervisor-level access to all non-machine-level interrupt files could
equal the number of harts in the system.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If a machine&#8217;s construction dictates that harts be subdivided into
groups, with each group relegated to its own portion of the address
space, then the best that can be achieved is to locate together the
machine-level interrupt files of each group of harts separately, and
likewise locate together the supervisor-level and guest interrupt files
of each group of harts separately. This situation is further addressed
later below.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A system may divide harts into groups in the address space because each
group exists on a separate chip (or chiplet in a multi-chip module), and
weaving together the address spaces of the multiple chips is
impractical. In that case, granting supervisor-level access to all
non-machine-level interrupt files takes one PMP table entry per group.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For the purpose of locating the memory pages of interrupt files in the
address space, assume each hart (or each hart within a group) has a
unique hart number that may or may not be related to the unique hart
identifiers ("hart IDs") that the Privileged Architecture
assigns to harts. For convenient addressing, the memory pages of all
machine-level interrupt files (or all those of a single group of harts)
should be arranged so that the address of the machine-level interrupt
file for hart number \(h\) is given by the formula
\({A+h\times{2}^{C}}\) for some integer constants
\(A\) and \(C\). If the largest hart number is
\(h_{\rm max}\), let
\({k = \lceil\log_{2}(h_{\rm max}+{1})\rceil}\), the
number of bits needed to represent any hart number. Then the base
address \(A\) should be aligned to a
\({2}^{k+C}\) address boundary, so
\({A+h\times{2}^{C}}\) always equals
\(A\) | \({(h\times{2}^{C})}\), where the
vertical bar (|) represents bitwise logical OR.</p>
</div>
<div class="paragraph">
<p>The smallest that \(C\) can be is 12, with
\({2}^{C}\) being the size of one 4-KiB page. If
\({C &gt; 12}\), the start of the memory page for each
machine-level interrupt file is aligned not just to a 4-KiB page but to
a stricter \({2}^{C}\) address boundary. Within the
\({{2}^{k+C}}\)-size address range \(A\)
through \({A+{2}^{k+C}-{1}}\), every 4-KiB page that
is not occupied by a machine-level interrupt file should be filled with
32-bit words of read-only zeros, such that any read of an aligned word
returns zero and any write to an aligned word is ignored.</p>
</div>
<div class="paragraph">
<p>The memory pages of all supervisor-level interrupt files (or all those
of a single group of harts) should similarly be arranged so that the
address of the supervisor-level interrupt file for hart
number \(h\) is \({B+h\times{2}^{D}}\) for some
integer constants \(B\) and \(D\), with the base
address \(B\) being aligned to a \({2}^{k+D}\)
address boundary.</p>
</div>
<div class="paragraph">
<p>If an IMSIC implements guest interrupt files, the memory pages for the
IMSIC&#8217;s supervisor-level interrupt file and for its guest interrupt
files should be contiguous, starting with the supervisor-level interrupt
file at the lowest address and followed by the guest interrupt files,
ordered by guest interrupt number. Schematically, the memory pages
should be ordered contiguously as</p>
</div>
<div class="paragraph">
<p>S, \({G}_{1}$\), \({G}_{2}\),
\({G}_{3}\), â€¦</p>
</div>
<div class="paragraph">
<p>where S is the page for the supervisor-level interrupt file and each
\({G}_{i}\) is the page for the interrupt file of guest
interrupt number \(i\). Consequently, the smallest that
constant \(D\) can be is
\({\lceil\log_{\rm 2}({maximum GEILEN}+{1})\rceil}+12\),
recalling that GEILEN for each IMSIC is the number of guest interrupt
files the IMSIC implements.</p>
</div>
<div class="paragraph">
<p>Within the \({{2}^{k+D}}\)-size address range
\(B\) through \({B+{2}^{k+D}-{1}}\), every
4-KiB page that is not occupied by an interrupt file (supervisor-level
or guest) should be filled with 32-bit words of read-only zeros.</p>
</div>
<div class="paragraph">
<p>When a system divides harts into groups, each in its own separate
portion of the address space, the memory page addresses of interrupt
files should follow the formulas
\({g\times{2}^{E}}A{h\times{2}^{C}}\) for
machine-level interrupt files, and
\({g\times{2}^{E}}B{h\times{2}^{D}}\) for
supervisor-level interrupt files, with \(g\) being a <em>group
number</em>, \(h\) being a hart number relative to the group, and
\(E\) being another integer constant
\(\geq\) \({k+\max(C,D)}\) but usually much larger.
If the largest group number is \(g_{\rm max}\), let
\({j = \lceil\log_{2}(g_{\rm max}+{1})\rceil}\), the
number of bits needed to represent any group number. Besides being
multiples of \({2}^{k+C}\) and
\({2}^{k+D}\) respectively, \(A\) and
\(B\) should be chosen so</p>
</div>
<div class="paragraph">
<p>\(((2^j-1)\times{2}^{E})\) &amp; \(A \,=\, 0\) and \(\left(({2}^{j}-{1})\times{2}^{E}\right)\) &amp; \(B \,=\, 0\)</p>
</div>
<div class="paragraph">
<p>where an ampersand (&amp;) represents bitwise logical AND. This ensures that</p>
</div>
<div class="paragraph">
<p>\(g\times{2}^{E}+A+h\times{2}^{C}\) always equals
(\(g\times{2}^{E}\)) | \(A\) | (\(h\times{2}^{C}\)), and<br>
\(g\times{2}^{E}+B+h\times{2}^{D}\) always equals (\(g\times{2}^{E}\)) | \(B\) |
(\(h\times{2}^{D}\)).</p>
</div>
<div class="paragraph">
<p>Infilling with read-only-zero pages is expected only within each group,
not between separate groups. Specifically, if \(g\) is any
integer between 0 and \({{2}^{j}-1}\) inclusive, then
within the address ranges,</p>
</div>
<div class="paragraph">
<p>\(g\times2^E+A\) through
\(g\times2^E+A+2^{k+C}-1\), and<br>
\(g\times2^E+B\) through
\(g\times2^E+B+2^{k+D}-1\),</p>
</div>
<div class="paragraph">
<p>pages not occupied by an interrupt file should be read-only zeros.</p>
</div>
<div class="paragraph">
<p>See also <a href="#AdvPLIC-MSIAddrs">[AdvPLIC-MSIAddrs]</a> for the
default algorithms an Advanced PLIC may use to determine the destination
addresses of outgoing MSIs, which should be the addresses of IMSIC
interrupt files.</p>
</div>
</div>
<div class="sect2">
<h3 id="csrs-for-external-interrupts-via-an-imsic"><a class="anchor" href="#csrs-for-external-interrupts-via-an-imsic"></a>CSRs for external interrupts via an IMSIC</h3>
<div class="paragraph">
<p>Software accesses a hart&#8217;s IMSIC primarily through the CSRs introduced
in <a href="#CSRs">[CSRs]</a>. There is a separate set of CSRs for each
implemented privilege level that can receive interrupts. The
machine-level CSRs interact with the IMSIC&#8217;s machine-level interrupt
file, while, if supervisor mode is implemented, the supervisor-level
CSRs interact with the IMSIC&#8217;s supervisor-level interrupt file. When an
IMSIC has guest interrupt files, the VS CSRs interact with a single
guest interrupt file, selected by the VGEIN field of CSR <code>hstatus</code>.</p>
</div>
<div class="paragraph">
<p>For machine level, the relevant CSRs are <code>miselect</code>, <code>mireg</code>, and <code>mtopei</code>. When supervisor mode is implemented, the set of supervisor-level CSRs matches those of machine level: <code>siselect</code>, <code>sireg</code>, and <code>stopei</code>. And when the H extension is implemented, there are three corresponding VS CSRs: <code>vsiselect</code>, <code>vsireg</code>, and <code>vstopei</code>.</p>
</div>
<div class="paragraph">
<p>As explained in <a href="#CSRs">[CSRs]</a>, registers <code>miselect</code> and <code>mireg</code> provide indirect access to additional machine-level registers. Likewise for supervisor-level <code>siselect</code> and <code>sireg</code>, and VS-level <code>vsiselect</code> and <code>vsireg</code> . In each case, a value of the <strong><em>*iselect</em></strong> <em>CSR</em> (<code>miselect</code>, <code>siselect</code> , or <code>vsiselect)</code>) in the range 0x70-0xFF selects a register of the
corresponding IMSIC interrupt file, either the machine-level interrupt
file (<code>miselect</code>), the supervisor-level interrupt file (<code>siselect</code>), or a guest interrupt file (<code>vsiselect</code>).</p>
</div>
<div class="paragraph">
<p>Interrupt files at each level act identically. For a given privilege
level, values of the <code>*iselect</code> CSR in the range <code>0x70-0xFF</code> select these registers of the corresponding interrupt file:</p>
</div>
<table class="tableblock frame-none grid-none fit-content center">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x70</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>eidelivery</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x72</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>eithreshold</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x80</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>eip0</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x81</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>eip1</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0xBF</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>eip63</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0xC0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>eie0</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0xC1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>eie1</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0xFF</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>eie63</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Register numbers 0x71 and 0x73-0x7F are reserved. When an <code><em>*iselect</em></code> <em>CSR</em>  has one of these values, reads from the matching <code><em>*ireg</em></code> <em>CSR</em> (<code>mireg</code>, <code>sireg</code>, or <code>vsireg</code>) return zero, and writes to the <code><em>*ireg</em></code> <em>CSR</em> are ignored. (For <code>vsiselect</code> and <code>vsireg</code>, all accesses depend on <code>hstatus</code>.VGEIN being the valid number of a guest interrupt file.)</p>
</div>
<div class="paragraph">
<p>Registers <code>eip0</code> through <code>eip63</code> contain the pending bits for all implemented interrupt identities, and are collectively called the <code><em>eip</em></code> <em>array</em>. Registers <code>eie0</code> through <code>eie63</code> contain the enable bits for the same interrupt identities, and are collectively called the <code><em>eie</em></code> <em>array</em>.</p>
</div>
<div class="paragraph">
<p>The indirectly accessed interrupt-file registers and CSRs <code>mtopei</code>, <code>stopei</code>, and <code>vstopei</code> are all documented in more detail in the next two sections.</p>
</div>
</div>
<div class="sect2">
<h3 id="indirectly-accessed-interrupt-file-registers"><a class="anchor" href="#indirectly-accessed-interrupt-file-registers"></a>Indirectly accessed interrupt-file registers</h3>
<div class="paragraph">
<p>This section describes the registers of an interrupt file that are
accessed indirectly through a <code><em>*iselect</em></code> <em>CSR</em> (<code>miselect</code>, <code>siselect</code>, or <code>vsiselect</code>) and its partner <code><em>*ireg</em></code> <em>CSR</em> (<code>mireg</code>, <code>sireg</code>, or <code>vsireg</code>). The width of these indirect accesses is always the current XLEN,
32 bits for RV32 code, or 64 bits for RV64 code.</p>
</div>
<div class="sect3">
<h4 id="IMSIC-reg-eidelivery"><a class="anchor" href="#IMSIC-reg-eidelivery"></a>External interrupt delivery enable register (<code>eidelivery</code>)</h4>
<div class="paragraph">
<p><code>eidelivery</code> is a <strong>WARL</strong> register that controls whether interrupts from this interrupt file are delivered from the IMSIC to the attached hart so they appear as a pending external interrupt in the hart&#8217;s <code>mip</code> or <code>hgeip</code> CSR. Register <code>eidelivery</code> may optionally also support the direct delivery of interrupts from a PLIC (Platform-Level Interrupt Controller) or APLIC (Advanced PLIC) to the attached hart. Three possible values are currently defined for <code>eidelivery</code>:</p>
</div>
<table class="tableblock frame-none grid-none fit-content center">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock">0 =</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interrupt delivery is disabled</p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock">1 =</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interrupt delivery from the interrupt file is enabled</p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock">0x40000000 =</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interrupt delivery from a PLIC or APLIC is enabled (optional)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If <code>eidelivery</code> supports value 0x40000000, then a specific PLIC or APLIC in the system may act as an alternate external interrupt controller for the attached hart at the same privilege level as this interrupt file. When <code>eidelivery</code> is 0x40000000, the interrupt file functions the same as though <code>eidelivery</code> is 0, and the PLIC or APLIC replaces the interrupt file in supplying pending external interrupts at this privilege level at the hart.</p>
</div>
<div class="paragraph">
<p>Guest interrupt files do not support value 0x40000000 for <code>eidelivery</code>.</p>
</div>
<div class="paragraph">
<p>Reset initializes <code>eidelivery</code> to 0x40000000 if that value is supported; otherwise, <code>eidelivery</code> has an UNSPECIFIED valid value (0 or 1) after reset.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>eidelivery</code> value 0x40000000 supports system software that is oblivious to IMSICs and assumes instead that the external interrupt controller is a PLIC or APLIC. Such software may exist either because it predates the existence of IMSICs or because bypassing IMSICs is believed to reduce programming effort.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>eidelivery</code> register affects only whether
an external interrupt appears in a hart&#8217;s <code>*ip</code> register
(MEI or SEI in <code>mip</code> or <code>sip</code>, or a bit in <code>hgeip</code>) and what
the source of such an interrupt may be (either the interrupt file
or a separate external interrupt controller such as an APLIC).
It has no effect on other state within the interrupt file,
or on any <code>*topei</code> CSR (<code>mtopei</code>, <code>stopei</code>, or <code>vstopei</code>).</p>
</div>
</div>
<div class="sect3">
<h4 id="external-interrupt-enable-threshold-register-eithreshold"><a class="anchor" href="#external-interrupt-enable-threshold-register-eithreshold"></a>External interrupt enable threshold register (<code>eithreshold</code>)</h4>
<div class="paragraph">
<p><code>eithreshold</code> is a <strong>WLRL</strong> register that determines the minimum interrupt priority (maximum interrupt identity number) allowing an interrupt to be signaled from this interrupt file to the attached hart. If \(N\) is the maximum implemented interrupt identity number for this interrupt file,
<code>eithreshold</code> must be capable of holding all values between 0 and \(N\),
inclusive.</p>
</div>
<div class="paragraph">
<p>When <code>eithreshold</code> is a nonzero value \(P\), interrupt identities
\(P\) and higher do not contribute to signaling interrupts, as
though those identities were not enabled, regardless of the settings of
their corresponding interrupt-enable bits in the <code>eie</code> array. When <code>eithreshold</code> is zero, all enabled interrupt identities contribute to signaling interrupts from
the interrupt file.</p>
</div>
</div>
<div class="sect3">
<h4 id="external-interrupt-pending-registers-eip0-eip63"><a class="anchor" href="#external-interrupt-pending-registers-eip0-eip63"></a>External interrupt-pending registers (<code>eip0</code>-<code>eip63</code>)</h4>
<div class="paragraph">
<p>When the current XLEN = 32, register <code>eip</code>\(k\) contains the
pending bits for interrupts with identity numbers
\(k\times{32}\) through
\({k\times{32} + {31}}\). For an implemented
interrupt identity \(i\) within that range, the pending bit
for interruptÂ \(i\) is bit \((i\bmod{32})\) of <code>eip</code>\(k\).</p>
</div>
<div class="paragraph">
<p>When the current XLEN = 64, the odd-numbered registers <code>eip1</code>, <code>eip3</code>, â€¦ <code>eip63</code> do not
exist. In that case, if the <code>*iselect</code> CSR is an odd value in the range 0x81â€“0xBF, an
attempt to access the matching <code>*ireg</code> CSR raises an illegal instruction
exception, unless done in VS-mode, in which case it raises a virtual
instruction exception. For even \(k\), register <code>eip</code>\(k\) contains the pending bits for interrupts with identity
numbers \(k\times{32}\) through
\({k\times{32} + {63}}\). For an implemented
interrupt identityÂ \(i\) within that range, the pending bit
for interruptÂ \(i\) is bit \((i\bmod{64})\) of <code>eip</code>\(k\).</p>
</div>
<div class="paragraph">
<p>Bit positions in a valid <code>eip</code>\(k\) register that don&#8217;t correspond
to a supported interrupt identity (such as bit 0 of <code>eip0</code>) are read-only
zeros.</p>
</div>
</div>
<div class="sect3">
<h4 id="external-interrupt-enable-registers-eie0-eie63"><a class="anchor" href="#external-interrupt-enable-registers-eie0-eie63"></a>External interrupt-enable registers (<code>eie0</code>-<code>eie63</code>)</h4>
<div class="paragraph">
<p>When the current XLEN = 32, register <code>eie</code>\(k\) contains the enable
bits for interrupts with identity numbers \(k\times{32}\)
through \({k\times{32} + {31}}\). For an implemented
interrupt identity \(i\) within that range, the enable bit for
interrupt \(i\) is bit (\(i\bmod{32}\)) of <code>eie</code>\(k\).</p>
</div>
<div class="paragraph">
<p>When the current XLEN = 64, the odd-numbered registers <code>eie1</code>, <code>eie3</code>, â€¦ <code>eie63</code> do not
exist. In that case, if the <code>*iselect</code> CSR is an odd value in the range <code>0xC1</code>â€“<code>0xFF</code>, an
attempt to access the matching <code>*ireg</code> CSR raises an illegal instruction
exception, unless done in VS-mode, in which case it raises a virtual
instruction exception. For evenÂ \(k\), register
<code>eie</code>\(k\) contains the enable bits for interrupts with identity
numbers \(k\times{32}\) through
\({k\times{32} + {63}}\). For an implemented
interrupt identityÂ \(i\) within that range, the enable bit for
interruptÂ \(i\) is bit (\(i\bmod{64}\)) of <code>eie</code>\(k\).</p>
</div>
<div class="paragraph">
<p>Bit positions in a valid <code>eie</code>\(k\) register that don&#8217;t correspond
to a supported interrupt identity (such as bit 0 of <code>eie0</code>) are read-only
zeros.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="top-external-interrupt-csrs-mtopei-stopei-vstopei"><a class="anchor" href="#top-external-interrupt-csrs-mtopei-stopei-vstopei"></a>Top external interrupt CSRs (<code>mtopei</code>, <code>stopei</code>, <code>vstopei</code>)</h3>
<div class="paragraph">
<p>CSR <code>mtopei</code> interacts directly with an IMSIC&#8217;s machine-level interrupt file. If
supervisor mode is implemented, CSR <code>stopei</code> interacts directly with the
supervisor-level interrupt file. And if the H extension is
implemented and field VGEIN of <code>hstatus</code> is the number of an implemented guest
interrupt file, <code>vstopei</code> interacts with the chosen guest interrupt file.</p>
</div>
<div class="paragraph">
<p>The value of a <code><em>*topei</em></code> <em>CSR</em> (<code>mtopei</code>, <code>stopei</code>, or <code>vstopei</code>) indicates the interrupt file&#8217;s current highest-priority pending-and-enabled interrupt that also exceeds the priority threshold specified by its <code>eithreshold</code> register if <code>eithreshold</code> is not zero. Interrupts with lower identity numbers have higher priorities.</p>
</div>
<div class="paragraph">
<p>A read of a <code>*topei</code> CSR returns zero either if no interrupt is both pending in the interrupt file&#8217;s <code>eip</code> array and enabled in its <code>eie</code> array, or if <code>eithreshold</code> is not zero and no pending-and-enabled interrupt has an identity number less than the value of <code>eithreshold</code>. Otherwise, the value returned from a read of <code>*topei</code> has this format:</p>
</div>
<table class="tableblock frame-none grid-none fit-content center">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock">bits 26:16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interrupt identity</p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock">bits 10:0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interrupt priority (same as identity)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>All other bit positions are zeros.</p>
</div>
<div class="paragraph">
<p>The interrupt identity reported in a <code>*topei</code> CSR is the minor identity for an
external interrupt at the hart.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The redundancy in the value read from a <code>*topei</code> CSR is consistent with the
Advanced PLIC, which returns both an interrupt identity number and its
priority in the same format as above, but with the two components being
independent of one another.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The value of a <code>*topei</code> CSR is not affected by an interrupt file&#8217;s
<code>eidelivery</code> register or by any of <code>mie</code>, <code>sie</code>, <code>hie</code>, <code>hgeie</code>, or <code>vsie</code>.</p>
</div>
<div class="paragraph">
<p>A write to a <code>*topei</code> CSR <em>claims</em> the reported interrupt identity by clearing
its pending bit in the interrupt file. The value written is ignored;
rather, the current readable value of the register determines which
interrupt-pending bit is cleared. Specifically, when a <code>*topei</code> CSR is written, if the register value has interrupt identity \(i\) in bits
26:16, then the interrupt file&#8217;s pending bit for interrupt \(i\) is cleared. When a <code>*topei</code> CSR&#8217;s value is zero, a write to the register has no effect.</p>
</div>
<div class="paragraph">
<p>If a read and write of a <code>*topei</code> CSR are done together by a single CSR
instruction (CSRRW, CSRRS, or CSRRC), the value returned by the read
indicates the pending bit that is cleared.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is almost always a mistake to write to a <code>*topei</code> CSR without a simultaneous
read to learn which interrupt was claimed. Note especially, if a read of
a <code>*topei</code> register and a subsequent write to the register are done by two
separate CSR instructions, then a higher-priority interrupt may become
newly pending-and-enabled in the interrupt file between the two
instructions, causing the write to clear the pending bit of the new
interrupt and not the one reported by the read. Once the pending bit of
the new interrupt is cleared, the interrupt is lost.</p>
</div>
<div class="paragraph">
<p>If it is necessary first to read a <code>*topei</code> CSR and then subsequently claim the
interrupt as a separate step, the claim can be safely done by clearing
the pending bit in the <code>eip</code> array via <code>*siselect</code> and <code>*sireg</code>, instead of writing to <code>*topei</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="interrupt-delivery-and-handling"><a class="anchor" href="#interrupt-delivery-and-handling"></a>Interrupt delivery and handling</h3>
<div class="paragraph">
<p>An IMSIC&#8217;s interrupt files supply <em>external interrupt</em> signals to the
attached hart, one interrupt signal per interrupt file. The interrupt
signal from a machine-level interrupt file appears as bit MEIP in CSR <code>mip</code>,
and the interrupt signal from a supervisor-level interrupt file appears
as bit SEIP in <code>mip</code> and <code>sip</code>. Interrupt signals from any guest interrupt files appear as the active bits in hypervisor CSR <code>hgeip</code>.</p>
</div>
<div class="paragraph">
<p>When interrupt delivery is disabled by an interrupt file&#8217;s <code>eidelivery</code> register (<code>eidelivery</code> = 0), the interrupt signal from the interrupt file is held de-asserted (false). When interrupt delivery from an interrupt file is enabled (<code>eidelivery</code> = 1), its interrupt signal is asserted if and only if the interrupt file has a pending-and-enabled interrupt that also exceeds the priority threshold specified by <code>eithreshold</code>, if not zero.</p>
</div>
<div class="paragraph">
<p>Changes to the state of an interrupt file are guaranteed
to be reflected in the relevant interrupt-pending bit in CSR
<code>mip</code> or <code>hgeip</code> eventually, but not necessarily immediately.</p>
</div>
<div class="paragraph">
<p>A trap handler solely for external interrupts via an IMSIC could be
written roughly as follows:</p>
</div>
<table class="tableblock frame-none grid-none fit-content center">
<colgroup>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">save processor registers</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>i</code>=read CSR <code>mtopei</code> or <code>stopei</code>, and write simultaneously to claim the interrupt</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>i</code>= <code>i&gt;&gt;16</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">call the interrupt handler for external interrupt <code>i</code> (minor identity)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">restore processor registers</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">return from trap</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The combined read and write of <code>mtopei</code> or <code>stopei</code> in the second step can be done by a single CSRRW machine instruction,</p>
</div>
<div class="paragraph">
<p><code>csrrw</code> <em>rd</em>, <code>mtopei/stopei</code>, <code>x0</code></p>
</div>
<div class="paragraph">
<p>where <em>rd</em> is the destination register for value <em>i</em>.</p>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="CSRs.html">Control and Status Registers (CSRs) Added to Harts</a></span>
  <span class="next"><a href="AdvPLIC.html">Advanced Platform-Level Interrupt Controller (APLIC)</a></span>
</nav>
</article>  </div>
</main>
<div class="modal micromodal-slide" id="modal-versions" aria-hidden="true">
    <div class="modal__overlay" tabindex="-1" data-micromodal-close>
        <div class="modal__container" role="dialog" aria-modal="true">
            <main class="modal__content" id="modal-versions-content">
              <button data-micromodal-close class="modal-versions-close">
                <svg width="28px" height="28px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><defs><style>.cls-1h{fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:2px;}</style></defs><title/><g id="cross"><line class="cls-1h" x1="7" x2="25" y1="7" y2="25"/><line class="cls-1h" x1="7" x2="25" y1="25" y2="7"/></g></svg>
              </button>
                  <ul class="nav-versions">
                      <li class="component">
                        <div>
                          <a class="title" href="../../ffh/v1.0/index.html">ACPI Functional Fixed Hardware</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="../../ffh/v1.0/index.html">
      v1.0
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                      <li class="component">
                        <div>
                          <a class="title" href="index.html">Advanced Interrupt Architecture</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="index.html">
      v1.0
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                      <li class="component">
                        <div>
                          <a class="title" href="../../etrace/v1.0/index.html">E-Trace Encapsulation Specification</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="../../etrace/v1.0/index.html">
      v1.0
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                      <li class="component">
                        <div>
                          <a class="title" href="../../psabi/v1.0/index.html">ELF psABI Specification</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="../../psabi/v1.0/index.html">
      v1.0
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                      <li class="component">
                        <div>
                          <a class="title" href="../../iommuArch/v1.0/index.html">IOMMU Architecture</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="../../iommuArch/v1.0/index.html">
      v1.0
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                      <li class="component">
                        <div>
                          <a class="title" href="../../isa/index.html">ISA Specifications</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="../../isa/index.html">
      default
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                      <li class="component">
                        <div>
                          <a class="title" href="../../reri/v1.0/index.html">RERI Architecture</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="../../reri/v1.0/index.html">
      v1.0
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                      <li class="component">
                        <div>
                          <a class="title" href="../../qos/v1.0/index.html">RISC-V Capacity and Bandwidth QoS Register Interface</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="../../qos/v1.0/index.html">
      v1.0
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                      <li class="component">
                        <div>
                          <a class="title" href="../../plic/v1.0.0/index.html">RISC-V Platform-Level Interrupt Controller</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="../../plic/v1.0.0/index.html">
      v1.0.0
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                      <li class="component">
                        <div>
                          <a class="title" href="../../semihost/v1.0/index.html">semihosting</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="../../semihost/v1.0/index.html">
      v1.0
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                  </ul>
            </main>
        </div>
    </div>
</div>

</div>
<footer class="hidden">
</footer><script src="../../_/js/vendor/import.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
<script async src="../../_/js/vendor/spring-tabs.js" data-sync-storage-key="docs:preferred-tab"></script>
  </body>
</html>
