<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: RISC-V Ratified Specifications Library</title>
    <link rel="prev" href="iommu_intro.html">
    <link rel="next" href="iommu_in_memory_queues.html">
    <meta name="generator" content="Antora 3.1.12">
    <script>
!function (theme, navWidth) {
  if (theme === 'dark') document.documentElement.classList.add('dark-theme')
  if (navWidth) document.documentElement.style.setProperty('--nav-width', `${navWidth}px`)
}(localStorage && localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme: dark)')?.matches && 'dark'),
  localStorage && localStorage.getItem('nav-width'))
    </script>
    <link rel="stylesheet" href="../../_/css/site.css">
    <link rel="stylesheet" href="../../_/css/vendor/search.css">
    <link rel="stylesheet" href="../../_/css/vendor/page-search.css">
    <link rel="stylesheet" href="../../_/css/vendor/spring-tabs.css">

    <meta name="antora-ui-version" content="3f4ce2c51445edcfc62ee1f59ab97fffc218fb79"> 
    <meta name="version" content="v1.0">
    <meta name="component" content="iommuArch">
    <meta name="latest-version" content="false">
    <link rel="icon" href="../../_/img/favicon.ico" type="image/vnd.microsoft.icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../..">RISC-V Ratified Specifications Library</a>
      <button class="navbar-burger" aria-controls="topbar-nav" aria-expanded="false" aria-label="Toggle main menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="iommuArch" data-version="v1.0">
  <aside class="nav">
    <div class="panels">
      <div class="nav-panel-menu is-active" data-panel="menu">
        <nav class="nav-menu">
<div class="context">
  <span class="title">IOMMU Architecture</span>
  <span class="version">v1.0</span>
  <button class="browse-version" id="browse-version">
    <svg
      height="24px"
      id="Layer_1"
      style="enable-background:new 0 0 512 512;"
      version="1.1"
      viewBox="0 0 512 512"
      width="24px"
      xml:space="preserve"
    ><g><path
          d="M256,224c-17.7,0-32,14.3-32,32s14.3,32,32,32c17.7,0,32-14.3,32-32S273.7,224,256,224L256,224z"
        ></path><path
          d="M128.4,224c-17.7,0-32,14.3-32,32s14.3,32,32,32c17.7,0,32-14.3,32-32S146,224,128.4,224L128.4,224z"
        ></path><path
          d="M384,224c-17.7,0-32,14.3-32,32s14.3,32,32,32s32-14.3,32-32S401.7,224,384,224L384,224z"
        ></path></g></svg>
  </button>
  </div><ul class="nav-list">
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">IOMMU Architecture</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link"  href="contributors.html">Contributors</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link"  href="iommu_preface.html">Preface</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link"  href="iommu_intro.html">Introduction</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link"  href="iommu_data_structures.html">Data Structures</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link"  href="iommu_in_memory_queues.html">In-memory queue interface</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link"  href="iommu_debug.html">Debug support</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link"  href="iommu_registers.html">Memory-mapped register interface</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link"  href="iommu_sw_guidelines.html">Software guidelines</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link"  href="iommu_hw_guidelines.html">Hardware guidelines</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link"  href="iommu_extensions.html">IOMMU Extensions</a>
  </li>
</ul>
  </li>
</ul>
          <div class="toggle-sm">
            <button id="nav-toggle-2" class="nav-toggle"></button>
          </div>
        </nav>
      </div>
      <div class="nav-collapse">
        <button id="nav-collapse-toggle"><span></span></button>        
      </div>
    </div>
    <div class="nav-resize"></div>
  </aside>
</div>
<script>
!function (sidebar) {
  if (sidebar) {
    document.body.classList.add('nav-sm')
  }
}(localStorage && localStorage.getItem('sidebar') === 'close')
</script><main class="article">
<div class="toolbar" role="navigation">
  <button id="nav-toggle-1" class="nav-toggle"></button>
</div>
  <div class="content">
<aside class="sidebar">
  <div class="content">
    <div
      class="toc"
      data-title=""
      data-levels="2"
    >
      <div class="toc-menu"></div>
    </div>
    <div class="sidebar-links">
        <a href="https://github.com/riscv-non-isa/riscv-iommu/edit/antora-refactor/modules/ROOT/pages/iommu_data_structures.adoc">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            height="24"
            viewBox="0 0 24 24"
            width="24"
          ><path
              d="m16 2.012 3 3L16.713 7.3l-3-3zM4 14v3h3l8.299-8.287-3-3zm0 6h16v2H4z"
            ></path></svg>
          Edit this Page
        </a>
              <a href="https://github.com/riscv-non-isa/riscv-iommu" title="GitHub">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            height="512px"
            id="Layer_1"
            version="1.1"
            viewBox="0 0 512 512"
            width="512px"
          ><style type="text/css"><
              .st0{fill-rule:evenodd;clip-rule:evenodd;} ]]></style><g><path
                class="st0"
                d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"
              ></path></g></svg>
          GitHub Project
        </a>

      <a href="" title="PDF">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            height="512px"
            id="Layer_1"
            version="1.1"
            viewBox="0 0 512 512"
            width="512px"
          ><style type="text/css"><
              .st0{fill-rule:evenodd;clip-rule:evenodd;} ]]></style><g><path
                class="st0"
                d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"
              ></path></g></svg>
          Download PDF
        </a>
    </div>
  </div>
</aside>
<article class="doc">
<div class="breadcrumbs-container">
  <nav class="breadcrumbs" aria-label="breadcrumbs">
    <ul>
      <li>IOMMU Architecture</li>
      <li><a href="iommu_data_structures.html">Data Structures</a></li>
    </ul>
  </nav>
</div><div class="sect1">
<h2 id="DATA_STRUCTURES"><a class="anchor" href="#DATA_STRUCTURES"></a>Data Structures</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A data structure called device-context (<code>DC</code>) is used by the IOMMU to associate
a device with an address space and to hold other per-device parameters used
by the IOMMU to perform address translations. A radix-tree data structure called
device directory table (DDT) that is traversed using the <code>device_id</code> is used to
locate the <code>DC</code>.</p>
</div>
<div class="paragraph">
<p>The address space used by a device may require second-stage address translation
and protection when the control of the device is passed through to a Guest OS.
A Guest OS may optionally provide a first-stage page table for translating IOVA
used by a device controlled by the Guest OS to a GPA. When the use of a
first-stage is not required, then it may be effectively disabled by selecting the
first-stage address translation scheme to be <code>Bare</code>. The second-stage is used to
translate the GPA to a SPA.</p>
</div>
<div class="paragraph">
<p>When the control of the device is retained by the hypervisor or Host OS itself
then only the first-stage suffices to perform necessary address translations and
protections; the second-stage scheme may be effectively disabled for the device by
programming the second-stage address translation scheme to be <code>Bare</code>.</p>
</div>
<div class="paragraph">
<p>When second-stage address translation is not Bare, the <code>DC</code> holds the PPN of the
root second-stage page table; a guest-soft-context-ID (<code>GSCID</code>), which
facilitates invalidation of cached address translations on a per-virtual-machine
basis; and the second-stage address translation scheme.</p>
</div>
<div class="paragraph">
<p>Some devices support multiple process contexts where each context may be
associated with a different process and thus a different virtual address space.
The context in such devices may be configured with a <code>process_id</code> that
identifies the address space. When making a memory access, such devices signal
the <code>process_id</code> along with the <code>device_id</code> to identify the accessed address
space. An example of such a device may be a GPU that supports multiple process
contexts, where each context is associated with a different user process, such
that the GPU may access memory using the virtual address provided by the user
process itself. To support selecting an address space associated with the
<code>process_id</code>, the <code>DC</code> holds the PPN of the root Process Directory Table (PDT),
a radix-tree data structure, indexed using fields of the <code>process_id</code> to locate
a data structure called the Process Context (<code>PC</code>).</p>
</div>
<div class="paragraph">
<p>When a PDT is active, the controls for first-stage address translation are held
in the (<code>PC</code>).</p>
</div>
<div class="paragraph">
<p>When a PDT is not active, the controls for first-stage address translation are
held in the <code>DC</code> itself.</p>
</div>
<div class="paragraph">
<p>The first-stage address translation controls include the PPN of the root
first-stage page table; a process-soft-context-ID (<code>PSCID</code>), which facilitates
invalidation of cached address translations on a per-address-space basis; and
the first-stage address translation scheme.</p>
</div>
<div class="paragraph">
<p>To handle MSIs from a device controlled by a guest OS, an IOMMU must be able to
redirect those MSIs to a guest interrupt file in an IMSIC. Because MSIs from
devices are simply memory writes, they would naturally be subject to the same
address translation that an IOMMU applies to other memory writes. However,
the IOMMU architecture may treat MSIs directed to virtual machines specially, in
part to simplify software, and in part to allow optional support for
memory-resident interrupt files. To support this capability, the architecture
adds to the device contexts an MSI address mask and address pattern, used together
to identify pages in the guest physical address space that are the destinations
of MSIs; and the real physical address of an MSI page table for controlling the
translation and/or conversion of MSIs from the device. The IOMMU support for
MSIs to virtual machines is specified by the Advanced Interrupt Architecture
specification.</p>
</div>
<div class="paragraph">
<p>The <code>DC</code> further holds controls for the type of transactions that a device is
allowed to generate. One example of such a control is whether the device is
allowed to use the PCIe defined Address Translation Service (ATS) cite:[PCI].</p>
</div>
<div class="paragraph">
<p>Two formats of the device-context structure are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Base Format</strong> - is 32-bytes in size used when the special treatment of MSI
as specified in <a href="#MSI_TRANS">Process to translate addresses of MSIs</a> is not supported by the IOMMU.</p>
</li>
<li>
<p><strong>Extended Format</strong> - is 64-bytes in size and extends the base format <code>DC</code> with
additional fields to translate MSIs as specified in <a href="#MSI_TRANS">Process to translate addresses of MSIs</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If <code>capabilities.MSI_FLAT</code> is 1 then the Extended Format is used else the Base
Format is used.</p>
</div>
<div class="paragraph">
<p>The DDT used to locate the <code>DC</code> may be configured to be a 1, 2, or 3 level
radix-tree depending on the maximum width of the <code>device_id</code> supported. The
partitioning of the <code>device_id</code> to obtain the device directory indexes (DDI) to
traverse the DDT radix-tree are as follows:</p>
</div>
<div class="imageblock kroki">
<div class="content">
<img src="https://kroki.io/wavedrom/svg/eNqrLkpNt1KI5lJQqE7KLCm2UjDXUchLzE21UlB3cfGMNohVr9VBSFqiSBqiSlqgSBqBJWN1FJLz89Iy062qcxLzUoGqDHUUMooLEpNTrQwNjEx0FNLy80qKM6uA2gzNamsBjykqKA==" alt="Base format `device_id` partitioning">
</div>
<div class="title">Figure 1. Base format <code>device_id</code> partitioning</div>
</div>
<div class="imageblock kroki">
<div class="content">
<img src="https://kroki.io/wavedrom/svg/eNqrLkpNt1KI5lJQqE7KLCm2UjDTUchLzE21UlB3cfGMNohVr9VBSFqiSBrikzQCS8bqKCTn56VlpltV5yTmpQJVGeooZBQXJCanWhkaGJnoKKTl55UUZ1YBtRma1dYCAI7vKig=" alt="Extended format `device_id` partitioning">
</div>
<div class="title">Figure 2. Extended format <code>device_id</code> partitioning</div>
</div>
<div class="paragraph">
<p>The PDT may be configured to be a 1, 2, or 3 level radix-tree depending on the
maximum width of the <code>process_id</code> supported by that device.  The partitioning
of the <code>process_id</code> to obtain the process directory indices (PDI) to traverse
the PDT radix-tree are as follows:</p>
</div>
<div class="imageblock kroki">
<div class="content">
<img src="https://kroki.io/wavedrom/svg/eNqrLkpNt1KI5lJQqE7KLCm2UrDQUchLzE21UlAPcPGMNohVr9VBSFqiSBqiShqjSBqBJWN1FJLz89Iy062qcxLzUoGqDHUUMooLEpNTrQwNjEx0FNLy80qKM6uA2gzNamsBmo8qSA==" alt="`process_id` partitioning for PDT radix-tree traversal">
</div>
<div class="title">Figure 3. <code>process_id</code> partitioning for PDT radix-tree traversal</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>process_id</code> partitioning is designed to require a maximum of 4 KiB, a
page, of memory for each process directory table. The root of the table when
using a 20-bit wide <code>process_id</code> is not fully populated. The option of making
the root table occupy 32 KiB was considered but not adopted as these tables
are allocated at run time and contiguous memory allocation larger than a page
may stress the Guest and hypervisor memory allocators.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>All RISC-V IOMMU implementations are required to support DDT and PDT located
in main memory. Supporting data structures in I/O memory is not required but
is not prohibited by this specification.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="device-directory-table-ddt"><a class="anchor" href="#device-directory-table-ddt"></a>Device-Directory-Table (DDT)</h3>
<div class="paragraph">
<p>The DDT is a 1, 2, or 3-level radix-tree indexed using the device directory
index (DDI) bits of the <code>device_id</code> to locate a <code>DC</code>.</p>
</div>
<div style="page-break-after: always;"></div>
<div class="paragraph">
<p>The following diagrams illustrate the DDT radix-tree. The PPN of the root
device-directory-table is held in a memory-mapped register called the
device-directory-table pointer (<code>ddtp</code>).</p>
</div>
<div class="paragraph">
<p>Each valid non-leaf (<code>NL</code>) entry is 8-bytes in size and holds the PPN of the
next device-directory-table.</p>
</div>
<div class="paragraph">
<p>A valid leaf device-directory-table entry holds the device-context (<code>DC</code>).</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="_images/ddt-ext.svg" alt="ddt ext" width="800" height="400">
</div>
<div class="title">Figure 4. Three, two and single-level device directory with extended format <code>DC</code></div>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="_images/ddt-base.svg" alt="ddt base" width="800" height="400">
</div>
<div class="title">Figure 5. Three, two and single-level device directory with base format <code>DC</code></div>
</div>
<div class="sect3">
<h4 id="non-leaf-ddt-entry"><a class="anchor" href="#non-leaf-ddt-entry"></a>Non-leaf DDT entry</h4>
<div class="paragraph">
<p>A valid (<code>V==1</code>) non-leaf DDT entry provides the PPN of the next level DDT.</p>
</div>
<div class="imageblock kroki">
<div class="content">
<img src="https://kroki.io/wavedrom/svg/eNqrLkpNt1KI5lJQqE7KLCm2UjDUUVDIS8xNtVJQD1MHsiEgsaSkCChiqF6rg1BqqQNTWZRanFpUlpoC1ABVaYmi0sQErjQgwA9mLFSpiQmKWkMDhAswzTU0ACmO1VFIzs9Ly0y3qs5JzEsF6jLSUcgoLkhMTrUyNDAC2paWn1dSnFkFNMTQrLYWAH4yQUg=" alt="Non-leaf device-directory-table entry">
</div>
<div class="title">Figure 6. Non-leaf device-directory-table entry</div>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect3">
<h4 id="leaf-ddt-entry"><a class="anchor" href="#leaf-ddt-entry"></a>Leaf DDT entry</h4>
<div class="paragraph">
<p>The leaf DDT page is indexed by <code>DDI[0]</code> and holds the device-context (<code>DC</code>).</p>
</div>
<div class="paragraph">
<p>In base-format the <code>DC</code> is 32-bytes. In extended-format the <code>DC</code> is 64-bytes.</p>
</div>
<div class="imageblock kroki">
<div class="content">
<img src="https://kroki.io/wavedrom/svg/eNp1jjEOgkAQRXtPMR2YQKLGUHAAo5WNnbEYYFg2wV0yMxiVcHdXLLSQ8v3k_byByeRwXgAMhVXJIdsmAA6vlEN0YnTSolrv0tI7Zd9CrOUyGpP_wuEI-0dHfLPiGUxPooBVxSQC-j0DdBV07JXKCWPrG4PazR__lqAq26JXkhCD887OsmgqioamerorxLV88i8JhK22Jh9adBTUYDbSYRnU9WoTqA6O2Oebs3F8AbjJYUk=" alt="Base-format device-context">
</div>
<div class="title">Figure 7. Base-format device-context</div>
</div>
<div class="imageblock kroki">
<div class="content">
<img src="https://kroki.io/wavedrom/svg/eNqNkEFLw0AQhe_-irk1QgJWpEh-gNiD9KA3kTJJJulgsrvMTEUN-e_uhoI9mOLxDe8b3nujUFfC6xXAWLFpCZu7HMDhQCWsXgSd9mjsXVF7Z-J7yKy-Xk3538B2B49fgeSD1Qt0R1IDbBohVbDfZ4CugSDeqJ5lxv7QoYXlx-dJ0Ey4OhppDIPLzAOLWqGGHc3p6dMga_VC_KfnbRGS3bDqCYLnSAlkg3K4lC5xp5rFgPo-E_t02Sf5PzDEXiTujD1dlvHIxa2pSYa3HGLJlrty7NFRdN7ncNCAdXSub24j1sYRlL-T3kzTDx4Zo_Q=" alt="Extended-format device-context">
</div>
<div class="title">Figure 8. Extended-format device-context</div>
</div>
<div class="paragraph">
<p>The <code>DC</code> is interpreted as four 64-bit doublewords in base-format and as eight
64-bit doublewords in extended-format.  The byte order of each of the
doublewords in memory, little-endian or big-endian, is the endianness as
determined by <code>fctl.BE</code> (<a href="#FCTRL">[FCTRL]</a>). The IOMMU may read the <code>DC</code> fields in any
order.</p>
</div>
</div>
<div class="sect3">
<h4 id="device-context-fields"><a class="anchor" href="#device-context-fields"></a>Device-context fields</h4>
<div class="sect4">
<h5 id="translation-control-tc"><a class="anchor" href="#translation-control-tc"></a>Translation control (<code>tc</code>)</h5>
<div class="imageblock kroki">
<div class="content">
<img src="https://kroki.io/wavedrom/svg/eNp9zkELgjAcBfB7n-J_87JDWkTstphJEDF0RBARZtOEnOGsQ7Lvnh0KBv49Pn7vwesaVVA4TgC6S9kaCj4B0GmlKHh7z5JBCHdnJpMRFfEGUxlEgmHI5RojwSX6R8QixixiPMQsGTEu8NkKp8PWpYD8qFFGNS91dXz55-xp2rpycDY8PhHIap2XBe3uqVZ9cU7gZh5p1jf9adCnvNatKd_fvHCTtR_YoI1y" alt="Translation control (`tc`) field">
</div>
<div class="title">Figure 9. Translation control (<code>tc</code>) field</div>
</div>
<div class="paragraph">
<p><code>DC</code> is valid if the <code>V</code> bit is 1; If it is 0, all other bits in <code>DC</code> are
don&#8217;t-care and may be freely used by software.</p>
</div>
<div class="paragraph">
<p>If the IOMMU supports PCIe ATS specification cite:[PCI] (see <code>capabilities</code>
register), the <code>EN_ATS</code> bit is used to enable ATS transaction processing. If
<code>EN_ATS</code> is set to 1, IOMMU supports the following inbound transactions;
otherwise they are treated as unsupported requests.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Translated read for execute transaction</p>
</li>
<li>
<p>Translated read transaction</p>
</li>
<li>
<p>Translated write/AMO transaction</p>
</li>
<li>
<p>PCIe ATS Translation Request</p>
</li>
<li>
<p>PCIe ATS Invalidation Completion Message</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the <code>EN_ATS</code> bit is 1 and the <code>T2GPA</code> bit is set to 1 the IOMMU performs the
two-stage address translation to determine the permissions and the size of the
translation to be provided in the completion of a PCIe ATS Translation Request
from the device. However, the IOMMU returns a GPA, instead of a SPA, as the
translation of an IOVA in the response. In this mode of operation, the ATC in the
device caches a GPA as a translation for an IOVA and uses the GPA as the address
in subsequent translated memory access transactions. Usually, translated requests
use a SPA and need no further translation to be performed by the IOMMU. However
when <code>T2GPA</code> is 1, translated requests from a device use a GPA and are
translated by the IOMMU using the second-stage page table to a SPA. The <code>T2GPA</code>
control enables a hypervisor to contain DMA from a device, even if the device
misuses the ATS capability and attempts to access memory that is not associated
with the VM.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When <code>T2GPA</code> is enabled, the addresses provided to the device in response to a
PCIe ATS Translation Request cannot be directly routed by the I/O fabric
(e.g. PCI switches) that connect the device to other peer devices and to host.
Such addresses also cannot be routed within the device when peer-to-peer
transactions within the device (e.g. between functions of a device) are
supported.</p>
</div>
<div class="paragraph">
<p>Use of <code>T2GPA</code> set to 1 may not be compatible with devices that implement caches
tagged by the translated address returned in response to a PCIe ATS Translation
Request.</p>
</div>
</td>
</tr>
</table>
</div>
<div style="page-break-after: always;"></div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Hypervisors that configure <code>T2GPA</code> to 1 must ensure through protocol-specific
means that translated accesses are routed through the host such that the IOMMU
may translate the GPA and then route the transaction based on PA to memory or
to a peer device. For PCIe, for example, the Access Control Service (ACS) must
be configured to always redirect peer-to-peer (P2P) requests upstream to the
host.</p>
</div>
<div class="paragraph">
<p>As an alternative to setting <code>T2GPA</code> to 1, the hypervisor may establish a trust
relationship with the device if authentication protocols are supported by the
device. For PCIe, for example, the PCIe component measurement and authentication
(CMA) capability provides a mechanism to verify the device&#8217;s configuration and
firmware/executable (Measurement) and hardware identities (Authentication) to
establish such a trust relationship.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If <code>EN_PRI</code> bit is 0, then PCIe "Page Request" messages from the device are
invalid requests. A "Page Request" message received from a device is responded to
with a "Page Request Group Response" message. Normally, a software handler
generates this response message. However, under some conditions the IOMMU itself
may generate a response. For IOMMU-generated "Page Request Group Response"
messages the PRG-response-PASID-required (<code>PRPR</code>) bit when set to 1 indicates
that the IOMMU response message should include a PASID if the associated
"Page Request" had a PASID.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Functions that support PASID and have the "PRG Response PASID Required"
capability bit set to 1, expect that "Page Request Group Response" messages will
contain a PASID if the associated "Page Request" message had a PASID. If the
capability bit is 0, the function does not expect PASID on any "Page Request
Group Response" message and the behavior of the function if it receives the
response with a PASID is undefined. The <code>PRPR</code> bit should be configured
with the value held in the "PRG Response PASID Required" capability bit.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Setting the disable-translation-fault (<code>DTF</code>) bit to 1 disables reporting of
faults encountered in the address translation process. Setting <code>DTF</code> to 1 does
not disable error responses from being generated to the device in response to
faulting transactions. Setting <code>DTF</code> to 1 does not disable reporting of faults
from the IOMMU that are not related to the address translation process. The
faults that are not reported when <code>DTF</code> is 1 are listed in <a href="#FAULT_CAUSE">[FAULT_CAUSE]</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A hypervisor may set <code>DTF</code> to 1 to disable fault reporting when it has
identified conditions that may lead to a flurry of errors such as due to an
abnormal termination of a virtual machine.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>DC.fsc</code> field holds the context for first-stage translation. If the
<code>PDTV</code> bit is 1, the field holds the process-directory table pointer (<code>pdtp</code>).
If the <code>PDTV</code> bit is 0, the <code>DC.fsc</code> field holds (<code>iosatp</code>).</p>
</div>
<div class="paragraph">
<p>The <code>PDTV</code> bit is expected to be set to 1 when <code>DC</code> is associated with a device
that supports multiple process contexts and thus generates a valid <code>process_id</code>
with its memory accesses. For PCIe, for example, if the request has a PASID
then the PASID is used as the <code>process_id</code>.</p>
</div>
<div class="paragraph">
<p>When <code>PDTV</code> is 1, the <code>DPE</code> bit may set to 1 to enable the use of 0 as the
default value of <code>process_id</code> for translating requests without a valid
<code>process_id</code>. When <code>PDTV</code> is 0, the <code>DPE</code> bit is reserved for future standard
extension.</p>
</div>
<div class="paragraph">
<p>The IOMMU supports the 1 setting of <code>GADE</code> and <code>SADE</code> bits if
<code>capabilities.AMO_HWAD</code> is 1. When <code>capabilities.AMO_HWAD</code> is 0, these bits are
reserved.</p>
</div>
<div class="paragraph">
<p>If <code>GADE</code> is 1, the IOMMU updates A and D bits in second-stage PTEs atomically.
If <code>GADE</code> is 0, the IOMMU causes a guest-page-fault corresponding to the original
access type if the A bit is 0 or if the memory access is a store and the D bit
is 0.</p>
</div>
<div class="paragraph">
<p>If <code>SADE</code> is 1, the IOMMU updates A and D bits in first-stage PTEs atomically. If
<code>SADE</code> is 0, the IOMMU causes a page-fault corresponding to the original access
type if the A bit is 0 or if the memory access is a store and the D bit is 0.</p>
</div>
<div class="paragraph">
<p>If <code>SBE</code> is 0, implicit memory accesses to PDT entries and first-stage PTEs are
little-endian else they are big-endian. The supported values of <code>SBE</code> are the
same as that of the <code>fctl.BE</code> field.</p>
</div>
<div class="paragraph">
<p>The <code>SXL</code> field controls the supported paged virtual-memory schemes as defined
in <a href="#IOSATP_MODE_ENC">Encodings of <code>iosatp.MODE</code> field</a>. If <code>fctl.GXL</code> is 1 then the <code>SXL</code> field must be 1;
otherwise the legal values for the <code>SXL</code> field are the same as those for the
<code>fctl.GXL</code> field.</p>
</div>
<div class="paragraph">
<p>When <code>SXL</code> is 1, the following rules apply:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the first-stage is not Bare, then a page fault corresponding to the original
access type occurs if the <code>IOVA</code> has bits beyond bit 31 set to 1.</p>
</li>
<li>
<p>If the second-stage is not Bare, then a guest page fault corresponding to the
original access type occurs if the incoming GPA has bits beyond bit 33 set to 1.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="io-hypervisor-guest-address-translation-and-protection-iohgatp"><a class="anchor" href="#io-hypervisor-guest-address-translation-and-protection-iohgatp"></a>IO hypervisor guest address translation and protection (<code>iohgatp</code>)</h5>
<div class="imageblock kroki">
<div class="content">
<img src="https://kroki.io/wavedrom/svg/eNqrLkpNt1KI5lJQqE7KLCm2UjAx0VHIS8xNtVJQDwjwU6_VQUgZmsGl3IOdPV1QJIHaYJK-_i6uILlYHYXk_Ly0zHSr6pzEvFSgIiMdhYzigsRkoCpDAyOglrT8vJLizCoQ36y2FgAe0ykT" alt="IO hypervisor guest address translation and protection (`iohgatp`) field">
</div>
<div class="title">Figure 10. IO hypervisor guest address translation and protection (<code>iohgatp</code>) field</div>
</div>
<div class="paragraph">
<p>The <code>iohgatp</code> field holds the PPN of the root second-stage page table and a
virtual machine identified by a guest soft-context ID (<code>GSCID</code>), to facilitate
address-translation fences on a per-virtual-machine basis. If multiple devices
are associated to a VM with a common second-stage page table, the hypervisor is
expected to program the same <code>GSCID</code> in each <code>iohgatp</code>. The <code>MODE</code> field is used
to select the second-stage address translation scheme.</p>
</div>
<div class="paragraph">
<p>The second-stage page table formats are as defined by the Privileged
specification.  The <code>fctl.GXL</code> field controls the supported address-translation
schemes for guest physical addresses as defined in <a href="#IOHGATP_MODE_ENC">Encodings of <code>iohgatp.MODE</code> field</a>.</p>
</div>
<div class="paragraph">
<p>The <code>iohgatp</code> <code>MODE</code> field identifies the paged virtual-memory schemes and its
encodings are as follows:</p>
</div>
<table id="IOHGATP_MODE_ENC" class="tableblock frame-all grid-all fit-content center">
<caption class="title">Table 1. Encodings of <code>iohgatp.MODE</code> field</caption>
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top" colspan="3"><code>fctl.GXL=0</code></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">Value</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>Bare</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No translation or protection.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">1-7</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reserved for standard use.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>Sv39x4</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Page-based 41-bit virtual addressing (2-bit extension
                    of Sv39).</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">9</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>Sv48x4</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Page-based 50-bit virtual addressing (2-bit extension
                    of Sv48).</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">10</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>Sv57x4</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Page-based 59-bit virtual addressing (2-bit extension
                    of Sv57).</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">11-15</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reserved for standard use.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top" colspan="3"><p class="tableblock"><code>fctl.GXL=1</code></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">Value</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>Bare</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No translation or protection.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">1-7</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reserved for standard use.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>Sv32x4</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Page-based 34-bit virtual addressing (2-bit extension
                    of Sv32).</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">9-15</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reserved for standard use.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Implementations are not required to support all defined mode settings for
<code>iohgatp</code>. The IOMMU only needs to support the modes also supported by the MMU
in the harts integrated into the system or a subset thereof.</p>
</div>
<div class="paragraph">
<p>The root page table as determined by <code>iohgatp.PPN</code> is 16 KiB and must be aligned
to a 16-KiB boundary.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>GSCID</code> field of <code>iohgatp</code> identifies an address space. If an identical
<code>GSCID</code> is configured in two <code>DC</code> when the second-stage page-table referenced by
the two <code>DC</code> are not identical then it is unpredictable whether the IOMMU uses
the PTEs from the first page table or the second page table. These are the only
expected behaviors.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="DC_TA"><a class="anchor" href="#DC_TA"></a>Translation attributes (<code>ta</code>)</h5>
<div class="imageblock kroki">
<div class="content">
<img src="https://kroki.io/wavedrom/svg/eNqrLkpNt1KI5lJQqE7KLCm2UjA00lHIS8xNtVJQL0otTi0qS01Rr9VByBsZwOUDgp09XVAkLfDrRTI7CF0rkpwvVC5WRyE5Py8tM92qOicxLxVkuY5CRnFBYjJQlaGBkYmOQlp-XklxZhWIb1ZbCwBTDjzG" alt="Translation attributes (`ta`) field">
</div>
<div class="title">Figure 11. Translation attributes (<code>ta</code>) field</div>
</div>
<div class="paragraph">
<p>The <code>PSCID</code> field of <code>ta</code> provides the process soft-context ID that identifies
the address-space of the process. <code>PSCID</code> facilitates address-translation
fences on a per-address-space basis. The <code>PSCID</code> field in <code>ta</code> is used as the
address-space ID if <code>DC.tc.PDTV</code> is 0 and the <code>iosatp.MODE</code> field is not <code>Bare</code>.
When <code>DC.tc.PDTV</code> is 1, the <code>PSCID</code> field in <code>ta</code> is ignored.</p>
</div>
<div class="paragraph">
<p>The <code>RCID</code> and <code>MCID</code> fields are added by the QoS ID extension. If
<code>capabilities.QOSID</code> is 0, these bits are reserved and must be set to 0.
IOMMU-initiated requests for accessing the following data structures use the
value configured in the <code>RCID</code> and <code>MCID</code> fields of <code>DC.ta</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Process directory table (<code>PDT</code>)</p>
</li>
<li>
<p>Second-stage page table</p>
</li>
<li>
<p>First-stage page table</p>
</li>
<li>
<p>MSI page table</p>
</li>
<li>
<p>Memory-resident interrupt file (<code>MRIF</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>RCID</code> and <code>MCID</code> configured in <code>DC.ta</code> are provided to the IO bridge on
successful address translations. The IO bridge should associate these QoS IDs
with device-initiated requests.</p>
</div>
</div>
<div class="sect4">
<h5 id="first-stage-context-fsc"><a class="anchor" href="#first-stage-context-fsc"></a>First-Stage context (<code>fsc</code>)</h5>
<div class="paragraph">
<p>If <code>DC.tc.PDTV</code> is 0, the <code>DC.fsc</code> field holds the <code>iosatp</code> that provides
the controls for first-stage address translation and protection.</p>
</div>
<div id="IOSATP_FORMAT" class="imageblock kroki">
<div class="content">
<img src="https://kroki.io/wavedrom/svg/eNqrLkpNt1KI5lJQqE7KLCm2UjAx0VHIS8xNtVJQDwjwU6_VQUgZmsGlilKLU4vKUlNQ5IE6YfK-_i6uILlYHYXk_Ly0zHSr6pzEvFSgIiMdhYzigsRkoCpDAyOglrT8vJLizCoQ36y2FgD3HysJ?id=IOSATP_FORMAT" alt="IO Supervisor address translation and prot. (`iosatp`) field">
</div>
<div class="title">Figure 12. IO Supervisor address translation and prot. (<code>iosatp</code>) field</div>
</div>
<div class="paragraph">
<p>The first-stage page table formats are as defined by the Privileged specification.</p>
</div>
<div class="paragraph">
<p>The <code>DC.tc.SXL</code> field controls the supported paged virtual-memory schemes.</p>
</div>
<div class="paragraph">
<p>The <code>iosatp.MODE</code> identifies the paged virtual-memory schemes and is encoded
as defined in <a href="#IOSATP_MODE_ENC">Encodings of <code>iosatp.MODE</code> field</a>. The <code>iosatp.PPN</code> field holds the PPN of the
root page of a first-stage page table.</p>
</div>
<div class="paragraph">
<p>When second-stage address translation is not <code>Bare</code>, the <code>iosatp.PPN</code> is a guest
PPN. The GPA of the root page is then converted by guest physical address
translation process, as controlled by the <code>iohgatp</code>, into a supervisor physical
address.</p>
</div>
<table id="IOSATP_MODE_ENC" class="tableblock frame-all grid-all fit-content center">
<caption class="title">Table 2. Encodings of <code>iosatp.MODE</code> field</caption>
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top" colspan="3"><code>DC.tc.SXL=0</code></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">Value</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>Bare</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No translation or protection.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">1-7</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reserved for standard use.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>Sv39</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Page-based 39-bit virtual addressing.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">9</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>Sv48</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Page-based 48-bit virtual addressing.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">10</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>Sv57</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Page-based 57-bit virtual addressing.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">11-13</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reserved for standard use.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">14-15</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Designated for custom use.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top" colspan="3"><p class="tableblock"><code>DC.tc.SXL=1</code></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">Value</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>Bare</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No translation or protection.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">1-7</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reserved for standard use.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>Sv32</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Page-based 32-bit virtual addressing.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">9-15</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reserved for standard use.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>When <code>DC.tc.PDTV</code> is 1, the <code>DC.fsc</code> field holds the process-directory table
pointer (<code>pdtp</code>). When the device supports multiple process contexts, selected
by the <code>process_id</code>, the PDT is used to determine the first-stage page table and
associated <code>PSCID</code> for virtual address translation and protection.</p>
</div>
<div class="paragraph">
<p>The <code>pdtp</code> field holds the PPN of the root PDT and the <code>MODE</code> field that
determines the number of levels of the PDT.</p>
</div>
<div class="imageblock kroki">
<div class="content">
<img src="https://kroki.io/wavedrom/svg/eNqrLkpNt1KI5lJQqE7KLCm2UjAx0VHIS8xNtVJQDwjwU6_VQUgZmsGlilKLU4vKUlNQ5IE6YfK-_i6uILlYHYXk_Ly0zHSr6pzEvFSgIiMdhYzigsRkoCpDAyOglrT8vJLizCoQ36y2FgD3HysJ" alt="Process-directory table pointer (`pdtp`) field">
</div>
<div class="title">Figure 13. Process-directory table pointer (<code>pdtp</code>) field</div>
</div>
<div class="paragraph">
<p>When second-stage address translation is not Bare, the <code>pdtp.PPN</code> field holds a
guest PPN. The GPA of the root PDT is then converted by guest physical address
translation process, as controlled by the <code>iohgatp</code>, into a supervisor physical
address. Translating addresses of PDT using a second-stage page table, allows the
PDT to be held in memory allocated by the guest OS and allows the guest OS to
directly edit the PDT to associate a virtual-address space identified by a
first-stage page table with a <code>process_id</code>.</p>
</div>
<table id="PDTP_MODE_ENC" class="tableblock frame-all grid-all fit-content center">
<caption class="title">Table 3. Encodings of <code>pdtp.MODE</code> field</caption>
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">Value</th>
<th class="tableblock halign-center valign-top">Name</th>
<th class="tableblock halign-center valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>Bare</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No first-stage address translation or protection.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>PD8</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8-bit process ID enabled. The directory has 1 levels with
                    256 entries.The bits 19:8 of <code>process_id</code> must be 0.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>PD17</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">17-bit process ID enabled. The directory has 2 levels.
                    The root PDT page has 512 entries and leaf level has
                    256 entries. The bits 19:17 of <code>process_id</code> must be 0.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>PD20</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">20-bit process ID enabled. The directory has 3 levels.
                    The root PDT has 8 entries and the next non-leaf
                    level has 512 entries. The leaf level has 256 entries.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">4-13</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reserved for standard use.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">14-15</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Designated for custom use.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="msi-page-table-pointer-msiptp"><a class="anchor" href="#msi-page-table-pointer-msiptp"></a>MSI page table pointer (<code>msiptp</code>)</h5>
<div class="imageblock kroki">
<div class="content">
<img src="https://kroki.io/wavedrom/svg/eNqrLkpNt1KI5lJQqE7KLCm2UjAx0VHIS8xNtVJQDwjwU6_VQUgZmsGlilKLU4vKUlNQ5IE6YfK-_i6uILlYHYXk_Ly0zHSr6pzEvFSgIiMdhYzigsRkoCpDAyOglrT8vJLizCoQ36y2FgD3HysJ" alt="MSI page table pointer (`msiptp`) field">
</div>
<div class="title">Figure 14. MSI page table pointer (<code>msiptp</code>) field</div>
</div>
<div class="paragraph">
<p>The <code>msiptp.PPN</code> field holds the PPN of the root MSI page table used to direct
an MSI to a guest interrupt file in an IMSIC. The MSI page table formats are
defined by the Advanced Interrupt Architecture specification.</p>
</div>
<div class="paragraph">
<p>The <code>msiptp.MODE</code> field is used to select the MSI address translation scheme.</p>
</div>
<div style="page-break-after: always;"></div>
<table class="tableblock frame-all grid-all fit-content center">
<caption class="title">Table 4. Encodings of <code>msiptp.MODE</code> field</caption>
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">Value</th>
<th class="tableblock halign-center valign-top">Name</th>
<th class="tableblock halign-center valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>Off</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Recognition of accesses to
                    a virtual interrupt file using MSI address mask and
                    pattern is not performed.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>Flat</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Flat MSI page table</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">2-13</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reserved for standard use.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">14-15</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Designated for custom use.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="MSI_ID"><a class="anchor" href="#MSI_ID"></a>MSI address mask (<code>msi_addr_mask</code>) and pattern (<code>msi_addr_pattern</code>)</h5>
<div class="imageblock kroki">
<div class="content">
<img src="https://kroki.io/wavedrom/svg/eNqrLkpNt1KI5lJQqE7KLCm2UjA10lHIS8xNtVJQz00szlav1UHIGSLkilKLU4vKUlNA8rE6Csn5eWmZ6VbVOYl5qUCFQHUZxQWJyUCVhgZGJjoKafl5JcWZVSC-WW0tADOtJDo=" alt="MSI address mask (`msi_addr_mask`) field">
</div>
<div class="title">Figure 15. MSI address mask (<code>msi_addr_mask</code>) field</div>
</div>
<div class="imageblock kroki">
<div class="content">
<img src="https://kroki.io/wavedrom/svg/eNpFyjEOgCAMQNHdU3RzYRCiDlzFOCAWJNFqoHGQcHdxcvx5P0f0GqYGIC-Bk4ZBCSBzoIb2MswYqS3iZ_lzxITxxvXzWYA9yQWv824I61i_LV3G1lN2qhfgTuIUnq_HUl7D6SWM" alt="MSI address pattern (`msi_addr_pattern`) field">
</div>
<div class="title">Figure 16. MSI address pattern (<code>msi_addr_pattern</code>) field</div>
</div>
<div class="paragraph">
<p>The MSI address mask (<code>msi_addr_mask</code>) and pattern (<code>msi_addr_pattern</code>) fields
are used to identify the 4-KiB pages of virtual interrupt files in the guest
physical address space of the relevant VM. An incoming memory access made by a
device is recognized as an access to a virtual interrupt file if the destination
guest physical page matches the supplied address pattern in all bit positions
that are zeros in the supplied address mask. In detail, a memory access to guest
physical address <code>A</code> is recognized as an access to a virtual interrupt file&#8217;s
memory-mapped page if:</p>
</div>
<div class="paragraph">
<p><code>(A &gt;&gt; 12) &amp; ~msi_addr_mask = (msi_addr_pattern &amp; ~msi_addr_mask)</code></p>
</div>
<div class="paragraph">
<p>where &gt;&gt; 12 represents shifting right by 12 bits, an ampersand (&amp;) represents
bitwise logical AND, and <code>~msi_addr_mask</code> is the bitwise logical complement of
the address mask.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="DC_MISCONFIG"><a class="anchor" href="#DC_MISCONFIG"></a>Device-context configuration checks</h4>
<div class="paragraph">
<p>A <code>DC</code> with <code>DC.tc.V=1</code> is considered as misconfigured if any of the following
conditions are true. If misconfigured then, stop and report "DDT entry
misconfigured" (cause = 259).</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If any bits or encodings that are reserved for future standard use are set.</p>
</li>
<li>
<p><code>capabilities.ATS</code> is 0 and <code>DC.tc.EN_ATS</code>, or <code>DC.tc.EN_PRI</code>,
or <code>DC.tc.PRPR</code> is 1</p>
</li>
<li>
<p><code>DC.tc.EN_ATS</code> is 0 and <code>DC.tc.T2GPA</code> is 1</p>
</li>
<li>
<p><code>DC.tc.EN_ATS</code> is 0 and <code>DC.tc.EN_PRI</code> is 1</p>
</li>
<li>
<p><code>DC.tc.EN_PRI</code> is 0 and <code>DC.tc.PRPR</code> is 1</p>
</li>
<li>
<p><code>capabilities.T2GPA</code> is 0 and <code>DC.tc.T2GPA</code> is 1</p>
</li>
<li>
<p><code>DC.tc.T2GPA</code> is 1 and <code>DC.iohgatp.MODE</code> is <code>Bare</code></p>
</li>
<li>
<p><code>DC.tc.PDTV</code> is 1 and <code>DC.fsc.pdtp.MODE</code> is not a supported mode</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>capabilities.PD20</code> is 0 and <code>DC.fsc.pdtp.MODE</code> is <code>PD20</code></p>
</li>
<li>
<p><code>capabilities.PD17</code> is 0 and <code>DC.fsc.pdtp.MODE</code> is <code>PD17</code></p>
</li>
<li>
<p><code>capabilities.PD8</code> is 0 and <code>DC.fsc.pdtp.MODE</code> is <code>PD8</code></p>
</li>
</ol>
</div>
</li>
<li>
<p><code>DC.tc.PDTV</code> is 0 and <code>DC.fsc.iosatp.MODE</code> encoding is not a valid
encoding as determined by <a href="#IOSATP_MODE_ENC">Encodings of <code>iosatp.MODE</code> field</a></p>
</li>
<li>
<p><code>DC.tc.PDTV</code> is 0 and <code>DC.tc.SXL</code> is 0 <code>DC.fsc.iosatp.MODE</code>
is not one of the supported modes</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>capabilities.Sv39</code> is 0 and <code>DC.fsc.iosatp.MODE</code> is <code>Sv39</code></p>
</li>
<li>
<p><code>capabilities.Sv48</code> is 0 and <code>DC.fsc.iosatp.MODE</code> is <code>Sv48</code></p>
</li>
<li>
<p><code>capabilities.Sv57</code> is 0 and <code>DC.fsc.iosatp.MODE</code> is <code>Sv57</code></p>
</li>
</ol>
</div>
</li>
<li>
<p><code>DC.tc.PDTV</code> is 0 and <code>DC.tc.SXL</code> is 1 <code>DC.fsc.iosatp.MODE</code>
is not one of the supported modes</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>capabilities.Sv32</code> is 0 and <code>DC.fsc.iosatp.MODE</code> is <code>Sv32</code></p>
</li>
</ol>
</div>
</li>
<li>
<p><code>DC.tc.PDTV</code> is 0 and <code>DC.tc.DPE</code> is 1</p>
</li>
<li>
<p><code>DC.iohgatp.MODE</code> encoding is not a valid encoding as determined
by <a href="#IOHGATP_MODE_ENC">Encodings of <code>iohgatp.MODE</code> field</a></p>
</li>
<li>
<p><code>fctl.GXL</code> is 0 and <code>DC.iohgatp.MODE</code> is not a supported mode</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>capabilities.Sv39x4</code> is 0 and <code>DC.iohgatp.MODE</code> is <code>Sv39x4</code></p>
</li>
<li>
<p><code>capabilities.Sv48x4</code> is 0 and <code>DC.iohgatp.MODE</code> is <code>Sv48x4</code></p>
</li>
<li>
<p><code>capabilities.Sv57x4</code> is 0 and <code>DC.iohgatp.MODE</code> is <code>Sv57x4</code></p>
</li>
</ol>
</div>
</li>
<li>
<p><code>fctl.GXL</code> is 1 and <code>DC.iohgatp.MODE</code> is not a supported mode</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>capabilities.Sv32x4</code> is 0 and <code>DC.iohgatp.MODE</code> is <code>Sv32x4</code></p>
</li>
</ol>
</div>
</li>
<li>
<p><code>capabilities.MSI_FLAT</code> is 1 and <code>DC.msiptp.MODE</code> is not <code>Off</code>
and not <code>Flat</code></p>
</li>
<li>
<p><code>DC.iohgatp.MODE</code> is not <code>Bare</code> and the root page table determined by
<code>DC.iohgatp.PPN</code> is not aligned to a 16-KiB boundary.</p>
</li>
<li>
<p><code>capabilities.AMO_HWAD</code> is 0 and <code>DC.tc.SADE</code> or <code>DC.tc.GADE</code> is 1</p>
</li>
<li>
<p><code>capabilities.END</code> is 0 and <code>fctl.BE != DC.tc.SBE</code></p>
</li>
<li>
<p><code>DC.tc.SXL</code> value is not a legal value. If <code>fctl.GXL</code> is 1, then
<code>DC.tc.SXL</code> must be 1. If <code>fctl.GXL</code> is 0 and is writable, then
<code>DC.tc.SXL</code> may be 0 or 1. If <code>fctl.GXL</code> is 0 and is not writable
then <code>DC.tc.SXL</code> must be 0.</p>
</li>
<li>
<p><code>DC.tc.SBE</code> value is not a legal value. If <code>fctl.BE</code> is writable
then <code>DC.tc.SBE</code> may be 0 or 1. If <code>fctl.BE</code> is not writable then
<code>DC.tc.SBE</code> must be the same as <code>fctl.BE</code>.</p>
</li>
<li>
<p><code>capabilities.QOSID</code> is 1 and <code>DC.ta.RCID</code> or <code>DC.ta.MCID</code> values
are wider than that supported by the IOMMU.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Some <code>DC</code> fields hold supervisor physical addresses or
guest physical addresses. Some implementations may verify the validity of the
addresses - e.g. the supervisor physical address is not wider than that
supported as determined by <code>capabilities.PAS</code>, etc. at the time of locating the
<code>DC</code>. Such implementations may cause a "DDT entry misconfigured" (cause = 259)
fault.</p>
</div>
<div class="paragraph">
<p>Other implementations only detect such addresses to be invalid when the data
structure referenced by these fields needs to be accessed. Such
implementations may detect access-violation faults in the process of making
the access.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="process-directory-table-pdt"><a class="anchor" href="#process-directory-table-pdt"></a>Process-Directory-Table (PDT)</h3>
<div class="paragraph">
<p>The PDT is a 1, 2, or 3-level radix-tree indexed using the process directory
index (<code>PDI</code>) bits of the <code>process_id</code>.</p>
</div>
<div class="paragraph">
<p>The following diagrams illustrate the PDT radix-tree. The root
process-directory page number is located using the process-directory-table
pointer (<code>pdtp</code>) field of the device-context. Each non-leaf (<code>NL</code>) entry
provides the PPN of the next level process-directory-table. The leaf
process-directory-table entry holds the process-context (<code>PC</code>).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/pdt.svg" alt="pdt" width="800" height="400">
</div>
<div class="title">Figure 17. Three, two and single-level process directory</div>
</div>
<div class="sect3">
<h4 id="non-leaf-pdt-entry"><a class="anchor" href="#non-leaf-pdt-entry"></a>Non-leaf PDT entry</h4>
<div class="paragraph">
<p>A valid (<code>V==1</code>) non-leaf PDT entry holds the PPN of the next-level PDT.</p>
</div>
<div class="imageblock kroki">
<div class="content">
<img src="https://kroki.io/wavedrom/svg/eNqrLkpNt1KI5lJQqE7KLCm2UlAw1FHIS8xNtVJQD1PXUYCCxJKSIqCIoXqtDpJSS7jSotTi1KKy1BSgDqhSSxSlJiZwpQEBfjBzoUpNTFDUGhrgMdbQAKQ2VkchOT8vLTPdqjonMS8VqMlIRyGjuCAxOdXK0MAIaFlafl5JcWYV0BBDs9paAHD8QUg=" alt="Non-leaf process-directory-table entry">
</div>
<div class="title">Figure 18. Non-leaf process-directory-table entry</div>
</div>
</div>
<div class="sect3">
<h4 id="leaf-pdt-entry"><a class="anchor" href="#leaf-pdt-entry"></a>Leaf PDT entry</h4>
<div class="paragraph">
<p>The leaf PDT page is indexed by <code>PDI[0]</code> and holds the 16-byte process-context
(<code>PC</code>).</p>
</div>
<div class="imageblock kroki">
<div class="content">
<img src="https://kroki.io/wavedrom/svg/eNptzEEKwjAQheG9p5hdKySgRbrIATyBu-JiGiZxoKaSGUEacvdG1y7fD98rmaKD6QBQZlZxMF4MQMInOehuGZMsqLwmi6qZ57eSQK947Kr5b66cRa0oRrJ-TUofhT6I_4m7gdYCR1cWTNToYOAhL_SNnk9D-wnNCG_fPda6A92dMuk=" alt="Process-context">
</div>
<div class="title">Figure 19. Process-context</div>
</div>
<div class="paragraph">
<p>The <code>PC</code> is interpreted as two 64-bit doublewords. The byte order of each of the
doublewords in memory, little-endian or big-endian, is the endianness as
determined by <code>DC.tc.SBE</code>. The IOMMU may read the <code>PC</code> fields in any order.</p>
</div>
</div>
<div class="sect3">
<h4 id="process-context-fields"><a class="anchor" href="#process-context-fields"></a>Process-context fields</h4>
<div class="sect4">
<h5 id="translation-attributes-ta"><a class="anchor" href="#translation-attributes-ta"></a>Translation attributes (<code>ta</code>)</h5>
<div class="imageblock kroki">
<div class="content">
<img src="https://kroki.io/wavedrom/svg/eNqrLkpNt1KI5lJQqE7KLCm2UjDUUVDIS8xNtVJQD1MHsiEgsaSkCChiqF6rg1Wpq18wVDEhlcGhvhCVWBVa6sDUFaUWpxaVpaYAFUNVWqKoNDKAKw0IdvZ0QTHUyABFrbERHmONjUBqY3UUkvPz0jLTrapzEvNSgZpMdBQyigsSk4G6DA2MgLy0_LyS4swqEN-sthYAPxhWxg==" alt="Translation attributes (`ta`) field">
</div>
<div class="title">Figure 20. Translation attributes (<code>ta</code>) field</div>
</div>
<div class="paragraph">
<p><code>PC</code> is valid if the <code>V</code> bit is 1; If it is 0, all other bits in <code>PC</code> are don&#8217;t
care and may be freely used by software.</p>
</div>
<div class="paragraph">
<p>When Enable-Supervisory-access (<code>ENS</code>) is 1, transactions requesting supervisor
privilege are allowed with this <code>process_id</code> else the transaction is treated as
an unsupported request.</p>
</div>
<div class="paragraph">
<p>When <code>ENS</code> is 1, the <code>SUM</code> (permit Supervisor User Memory access) bit modifies
the privilege with which supervisor privilege transactions access virtual
memory. When <code>SUM</code> is 0, supervisor privilege transactions to pages mapped with
<code>U</code> bit in PTE set to 1 are disallowed.</p>
</div>
<div class="paragraph">
<p>When <code>ENS</code> is 1, supervisor privilege transactions that read with execute
intent to pages mapped with <code>U</code> bit in PTE set to 1 are disallowed, regardless
of the value of <code>SUM</code>.</p>
</div>
<div class="paragraph">
<p>The software assigned process soft-context ID (<code>PSCID</code>) is used as the address
space ID for the process identified by the first-stage page table when
first-stage address translation is not Bare.</p>
</div>
</div>
<div class="sect4">
<h5 id="first-stage-context-fsc-2"><a class="anchor" href="#first-stage-context-fsc-2"></a>First-Stage context (<code>fsc</code>)</h5>
<div class="imageblock kroki">
<div class="content">
<img src="https://kroki.io/wavedrom/svg/eNqrLkpNt1KI5lJQqE7KLCm2UjAx0VHIS8xNtVJQDwjwU6_VQUgZmsGlilKLU4vKUlNQ5IE6YfK-_i6uILlYHYXk_Ly0zHSr6pzEvFSgIiMdhYzigsRkoCpDAyOglrT8vJLizCoQ36y2FgD3HysJ" alt="Process First-Stage context">
</div>
<div class="title">Figure 21. Process First-Stage context</div>
</div>
<div class="paragraph">
<p>The <code>PC.fsc</code> field provides the controls for first-stage address translation and
protection.</p>
</div>
<div class="paragraph">
<p>The <code>PC.fsc.MODE</code> is used to determine the first-stage paged virtual-memory
scheme and its encodings are as defined in <a href="#IOSATP_MODE_ENC">Encodings of <code>iosatp.MODE</code> field</a>. The <code>DC.tc.SXL</code>
field controls the supported paged virtual-memory schemes. When <code>PC.fsc.MODE</code> is
not <code>Bare</code>, the <code>PC.fsc.PPN</code> field holds the PPN of the root page of a
first-stage page table.</p>
</div>
<div class="paragraph">
<p>When second-stage address translation is not Bare, the <code>PC.fsc.PPN</code> field holds
a guest PPN of the root of a first-stage page table. Addresses of the first-stage
page table entries are then converted by guest physical address translation
process, as controlled by the <code>DC.iohgatp</code>, into a supervisor physical address.
A guest OS may thus directly edit the first-stage page table to limit access by
the device to a subset of its memory and specify permissions for the device
accesses.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>PC.ta.PSCID</code> identifies an address space. If an identical
<code>PSCID</code> is configured in two <code>PC</code> when the page-table referenced by the two <code>PC</code>
are not identical then it is unpredictable whether the IOMMU uses the PTEs from
the first page table or the second page table. These are the only expected
behaviors.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="PC_MISCONFIG"><a class="anchor" href="#PC_MISCONFIG"></a>Process-context configuration checks</h4>
<div class="paragraph">
<p>A <code>PC</code> with <code>PC.ta.V=1</code> is considered as misconfigured if any of the following
conditions are true. If misconfigured then stop and report "PDT entry
misconfigured" (cause = 267).</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If any bits or encoding that are reserved for future standard use are set</p>
</li>
<li>
<p><code>PC.fsc.MODE</code> encoding is not valid as determined by <a href="#IOSATP_MODE_ENC">Encodings of <code>iosatp.MODE</code> field</a></p>
</li>
<li>
<p><code>DC.tc.SXL</code> is 0 and <code>PC.fsc.MODE</code> is not one of the supported modes</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>capabilities.Sv39</code> is 0 and <code>PC.fsc.MODE</code> is <code>Sv39</code></p>
</li>
<li>
<p><code>capabilities.Sv48</code> is 0 and <code>PC.fsc.MODE</code> is <code>Sv48</code></p>
</li>
<li>
<p><code>capabilities.Sv57</code> is 0 and <code>PC.fsc.MODE</code> is <code>Sv57</code></p>
</li>
</ol>
</div>
</li>
<li>
<p><code>DC.tc.SXL</code> is 1 and <code>PC.fsc.MODE</code> is not one of the supported modes</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>capabilities.Sv32</code> is 0 and <code>PC.fsc.MODE</code> is <code>Sv32</code></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Some <code>PC</code> fields hold supervisor physical addresses or
guest physical addresses. Some implementations may verify the validity of the
addresses - e.g. the supervisor physical address is not wider than that supported
as determined by <code>capabilities.PAS</code>, etc. at the time of locating the <code>PC</code>.
Such implementations may cause a "PDT entry misconfigured" (cause = 267) fault.</p>
</div>
<div class="paragraph">
<p>Other implementations only detect such addresses to be invalid when the data
structure referenced by these fields needs to be accessed. Such implementations
may detect access-violation faults in the process of making the access.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="P2IOVA"><a class="anchor" href="#P2IOVA"></a>Process to translate an IOVA</h3>
<div class="paragraph">
<p>The process to translate an IOVA uses the hardware IDs (<code>device_id</code> and
<code>process_id</code>) to locate the Device-Context and the Process-Context. The
Device-context and Process-context provide the root PPN of the page tables,
<code>PSCID</code>, <code>GSCID</code>, and other control parameters that affect the address
translation and protection process. When address translation caches
(<a href="#CACHING">Caching in-memory data structures</a>) are implemented, the translation process may use the <code>GSCID</code> and
<code>PSCID</code> to associate the cached translations with their address spaces.</p>
</div>
<div class="paragraph">
<p>The process to translate an <code>IOVA</code> is as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If <code>ddtp.iommu_mode == Off</code> then stop and report "All inbound transactions
disallowed" (cause = 256).</p>
</li>
<li>
<p>If <code>ddtp.iommu_mode == Bare</code> and any of the following conditions hold then
stop and report "Transaction type disallowed" (cause = 260); else go to step
20 with translated address same as the <code>IOVA</code>.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Transaction type is a Translated request (read, write/AMO, read-for-execute)
or is a PCIe ATS Translation request.</p>
</li>
</ol>
</div>
</li>
<li>
<p>If <code>capabilities.MSI_FLAT</code> is 0 then the IOMMU uses base-format device
context. Let <code>DDI[0]</code> be <code>device_id[6:0]</code>, <code>DDI[1]</code> be <code>device_id[15:7]</code>, and
<code>DDI[2]</code> be <code>device_id[23:16]</code>.</p>
</li>
<li>
<p>If <code>capabilities.MSI_FLAT</code> is 1 then the IOMMU uses extended-format device
context. Let <code>DDI[0]</code> be <code>device_id[5:0]</code>, <code>DDI[1]</code> be <code>device_id[14:6]</code>, and
<code>DDI[2]</code> be <code>device_id[23:15]</code>.</p>
</li>
<li>
<p>If the <code>device_id</code> is wider than that supported by the IOMMU mode, as
determined by the following checks then stop and report "Transaction type
disallowed" (cause = 260).</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>ddtp.iommu_mode</code> is <code>2LVL</code> and <code>DDI[2]</code> is not 0</p>
</li>
<li>
<p><code>ddtp.iommu_mode</code> is <code>1LVL</code> and either <code>DDI[2]</code> is not 0 or <code>DDI[1]</code> is not 0</p>
</li>
</ol>
</div>
</li>
<li>
<p>Use <code>device_id</code> to then locate the device-context (<code>DC</code>) as specified in
<a href="#GET_DC">Process to locate the Device-context</a>.</p>
</li>
<li>
<p>If any of the following conditions hold then stop and report
"Transaction type disallowed" (cause = 260).</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Transaction type is a Translated request (read, write/AMO, read-for-execute)
or is a PCIe ATS Translation request and <code>DC.tc.EN_ATS</code> is 0.</p>
</li>
<li>
<p>Transaction has a valid <code>process_id</code> and <code>DC.tc.PDTV</code> is 0.</p>
</li>
<li>
<p>Transaction has a valid <code>process_id</code> and <code>DC.tc.PDTV</code> is 1 and the
<code>process_id</code> is wider than that supported by <code>pdtp.MODE</code>.</p>
</li>
<li>
<p>Transaction type is not supported by the IOMMU.</p>
</li>
</ol>
</div>
</li>
<li>
<p>If request is a Translated request and <code>DC.tc.T2GPA</code> is 0 then the translation
process is complete. Go to step 20.</p>
</li>
<li>
<p>If request is a Translated request and <code>DC.tc.T2GPA</code> is 1 then the IOVA is a
GPA. Go to step 17 with following page table information:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Let <code>A</code> be the <code>IOVA</code> (the <code>IOVA</code> is a GPA).</p>
</li>
<li>
<p>Let <code>iosatp.MODE</code> be <code>Bare</code></p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>The <code>PSCID</code> value is not used when first-stage is Bare.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Let <code>iohgatp</code> be the value in the <code>DC.iohgatp</code> field</p>
</li>
</ol>
</div>
</li>
<li>
<p>If <code>DC.tc.PDTV</code> is set to 0 then go to step 17 with the following page table
information:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Let <code>iosatp.MODE</code> be the value in the <code>DC.fsc.MODE</code> field</p>
</li>
<li>
<p>Let <code>iosatp.PPN</code> be the value in the <code>DC.fsc.PPN</code> field</p>
</li>
<li>
<p>Let <code>PSCID</code> be the value in the <code>DC.ta.PSCID</code> field</p>
</li>
<li>
<p>Let <code>iohgatp</code> be the value in the <code>DC.iohgatp</code> field</p>
</li>
</ol>
</div>
</li>
<li>
<p>If <code>DPE</code> is 1 and there is no <code>process_id</code> associated with the transaction
then let <code>process_id</code> be the default value of 0.</p>
</li>
<li>
<p>If <code>DPE</code> is 0 and there is no <code>process_id</code> associated with the transaction
then then go to step 17 with the following page table information:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Let <code>iosatp.MODE</code> be <code>Bare</code></p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>The <code>PSCID</code> value is not used when first-stage is Bare.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Let <code>iohgatp</code> be the value in the <code>DC.iohgatp</code> field</p>
</li>
</ol>
</div>
</li>
<li>
<p>If <code>DC.fsc.pdtp.MODE = Bare</code> then go to step 17 with the following page table
information:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Let <code>iosatp.MODE</code> be <code>Bare</code></p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>The <code>PSCID</code> value is not used when first-stage is Bare.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Let <code>iohgatp</code> be value in <code>DC.iohgatp</code> field</p>
</li>
</ol>
</div>
</li>
<li>
<p>Locate the process-context (<code>PC</code>) as specified in <a href="#GET_PC">Process to locate the Process-context</a>.</p>
</li>
<li>
<p>if any of the following conditions hold then stop and report
"Transaction type disallowed" (cause = 260).</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>The transaction requests supervisor privilege but <code>PC.ta.ENS</code> is not set.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Go to step 17 with the following page table information:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Let <code>iosatp.MODE</code> be the value in the <code>PC.fsc.MODE</code> field</p>
</li>
<li>
<p>Let <code>iosatp.PPN</code> be the value in the <code>PC.fsc.PPN</code> field</p>
</li>
<li>
<p>Let <code>PSCID</code> be the value in the <code>PC.ta.PSCID</code> field</p>
</li>
<li>
<p>Let <code>iohgatp</code> be the value in the <code>DC.iohgatp</code> field</p>
</li>
</ol>
</div>
</li>
<li>
<p>Use the process specified in Section "Two-Stage Address Translation" of the
RISC-V Privileged specification cite:[PRIV] to determine the GPA accessed by
the transaction. If a fault is detected by the first stage address translation
process then stop and report the fault. If the translation process is completed
successfully then let <code>A</code> be the translated GPA.</p>
</li>
<li>
<p>If MSI address translations using MSI page tables is enabled
(i.e., <code>DC.msiptp.MODE != Off</code>) then the MSI address translation process
specified in <a href="#MSI_TRANS">Process to translate addresses of MSIs</a> is invoked. If the GPA <code>A</code> is not determined to be
the address of a virtual interrupt file then the process continues at step 19.
If a fault is detected by the MSI address translation process then stop and
report the fault else the process continues at step 20.</p>
</li>
<li>
<p>Use the second-stage address translation process specified in Section
"Two-Stage Address Translation" of the RISC-V Privileged specification
cite:[PRIV] to translate the GPA <code>A</code> to determine the SPA accessed by the
transaction. If a fault is detected by the address translation process then
stop and report the fault.</p>
</li>
<li>
<p>Translation process is complete</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>When checking the <code>U</code> bit in a second-stage PTE, the transaction is treated as
not requesting supervisor privilege. The <code>pte.xwr=010</code> encoding, as specified by
the Zicfiss cite:[CFI] extension for the Shadow Stack page type in single-stage
and VS-stage page tables, remains a reserved encoding for IO transactions.</p>
</div>
<div class="paragraph">
<p>When the translation process reports a fault, and the request is an Untranslated
request or a Translated request, the IOMMU requests the IO bridge to abort the
transaction. Guidelines for handling faulting transactions in the IO bridge are
provided in <a href="#IOBR_FAULT_RESP">[IOBR_FAULT_RESP]</a>. The fault may be reported using the fault/event
reporting mechanism and fault record formats specified in <a href="#FAULT_QUEUE">[FAULT_QUEUE]</a>.</p>
</div>
<div class="paragraph">
<p>If the fault was detected by a PCIe ATS Translation Request then the IOMMU may
provide a PCIe protocol defined response instead of reporting fault to software
or causing an abort. The handling of faulting PCIe ATS Translation Requests is
specified in <a href="#ATS_FAULTS">PCIe ATS translation request handling</a>.</p>
</div>
<div class="sect3">
<h4 id="GET_DC"><a class="anchor" href="#GET_DC"></a>Process to locate the Device-context</h4>
<div class="paragraph">
<p>The process to locate the Device-context for transaction using its <code>device_id</code>
is as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Let <code>a</code> be <code>ddtp.PPN x 2<sup>12</sup></code> and let <code>i = LEVELS - 1</code>. When
<code>ddtp.iommu_mode</code> is <code>3LVL</code>, <code>LEVELS</code> is three. When <code>ddtp.iommu_mode</code> is
<code>2LVL</code>, <code>LEVELS</code> is two. When <code>ddtp.iommu_mode</code> is <code>1LVL</code>, <code>LEVELS</code> is one.</p>
</li>
<li>
<p>If <code>i == 0</code> go to step 8.</p>
</li>
<li>
<p>Let <code>ddte</code> be the value of the eight bytes at address <code>a + DDI[i] x 8</code>. If accessing
<code>ddte</code> violates a PMA or PMP check, then stop and report "DDT entry load
access fault" (cause = 257).</p>
</li>
<li>
<p>If <code>ddte</code> access detects a data corruption (a.k.a. poisoned data), then
stop and report "DDT data corruption" (cause = 268).</p>
</li>
<li>
<p>If <code>ddte.V == 0</code>, stop and report "DDT entry not valid" (cause = 258).</p>
</li>
<li>
<p>If any bits or encoding that are reserved for future standard use are
set within <code>ddte</code>, stop and report "DDT entry misconfigured"
(cause = 259).</p>
</li>
<li>
<p>Let <code>i = i - 1</code> and let <code>a = ddte.PPN x 2<sup>12</sup></code>. Go to step 2.</p>
</li>
<li>
<p>Let <code>DC</code> be the value of <code>DC_SIZE</code> bytes at address <code>a + DDI[0] * DC_SIZE</code>. If
<code>capabilities.MSI_FLAT</code> is 1 then <code>DC_SIZE</code> is 64-bytes else it is 32-bytes.
If accessing <code>DC</code> violates a PMA or PMP check, then stop and report
"DDT entry load access fault" (cause = 257). If <code>DC</code> access detects a data
corruption (a.k.a. poisoned data), then stop and report "DDT data corruption"
(cause = 268).</p>
</li>
<li>
<p>If <code>DC.tc.V == 0</code>, stop and report "DDT entry not valid" (cause = 258).</p>
</li>
<li>
<p>If the <code>DC</code> is misconfigured as determined by rules outlined in
<a href="#DC_MISCONFIG">Device-context configuration checks</a> then stop and report "DDT entry misconfigured" (cause = 259).</p>
</li>
<li>
<p>The device-context has been successfully located.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="GET_PC"><a class="anchor" href="#GET_PC"></a>Process to locate the Process-context</h4>
<div class="paragraph">
<p>The device-context provides the PDT root page PPN (<code>pdtp.ppn</code>).  When
<code>DC.iohgatp.mode</code> is not <code>Bare</code>, <code>pdtp.PPN</code> as well as <code>pdte.PPN</code> are Guest
Physical Addresses (GPA) which must be translated into Supervisor Physical
Addresses (SPA) using the second-stage page table pointed to by <code>DC.iohgatp</code>.
The memory accesses to the PDT are treated as implicit read memory accesses
by the second-stage.</p>
</div>
<div class="paragraph">
<p>The process to locate the Process-context for a transaction using its
<code>process_id</code> is as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Let <code>a</code> be <code>pdtp.PPN x 2<sup>12</sup></code> and let <code>i = LEVELS - 1</code>. When
<code>pdtp.MODE</code> is <code>PD20</code>, <code>LEVELS</code> is three. When <code>pdtp.MODE</code> is
<code>PD17</code>, <code>LEVELS</code> is two. When <code>pdtp.MODE</code> is <code>PD8</code>, <code>LEVELS</code> is one.</p>
</li>
<li>
<p>If <code>DC.iohgatp.mode != Bare</code>, then <code>a</code> is a GPA. Invoke the process
to translate <code>a</code> to a SPA as an implicit memory access. If faults occur during
second-stage address translation of <code>a</code> then stop and report the fault detected
by the second-stage address translation process. The translated <code>a</code> is used in
subsequent steps.</p>
</li>
<li>
<p>If <code>i == 0</code> go to step 9.</p>
</li>
<li>
<p>Let <code>pdte</code> be the value of the eight bytes at address <code>a + PDI[i] x 8</code>. If
accessing <code>pdte</code> violates a PMA or PMP check, then stop and report
"PDT entry load access fault" (cause = 265).</p>
</li>
<li>
<p>If <code>pdte</code> access detects a data corruption (a.k.a. poisoned data), then
stop and report "PDT data corruption" (cause = 269).</p>
</li>
<li>
<p>If <code>pdte.V == 0</code>, stop and report "PDT entry not valid" (cause = 266).</p>
</li>
<li>
<p>If any bits or encoding that are reserved for future standard use are
set within <code>pdte</code>, stop and report "PDT entry misconfigured" (cause = 267).</p>
</li>
<li>
<p>Let <code>i = i - 1</code> and let <code>a = pdte.PPN x 2<sup>12</sup></code>. Go to step 2.</p>
</li>
<li>
<p>Let <code>PC</code> be the value of the 16-bytes at address <code>a + PDI[0] x 16</code>. If accessing <code>PC</code>
violates a PMA or PMP check, then stop and report "PDT entry load access
fault" (cause = 265). If <code>PC</code> access detects a data corruption
(a.k.a. poisoned data), then stop and report "PDT data corruption"
(cause = 269).</p>
</li>
<li>
<p>If <code>PC.ta.V == 0</code>, stop and report "PDT entry not valid" (cause = 266).</p>
</li>
<li>
<p>If the <code>PC</code> is misconfigured as determined by rules outlined in
<a href="#PC_MISCONFIG">Process-context configuration checks</a> then stop and report "PDT entry misconfigured" (cause = 267).</p>
</li>
<li>
<p>The Process-context has been successfully located.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="MSI_TRANS"><a class="anchor" href="#MSI_TRANS"></a>Process to translate addresses of MSIs</h4>
<div class="paragraph">
<p>When an I/O device is configured directly by a guest operating system, MSIs
from the device are expected to be targeted to virtual IMSICs within the guest
OS&#8217;s virtual machine, using guest physical addresses that are inappropriate
and unsafe for the real machine. An IOMMU must recognize certain incoming
writes from such devices as MSIs and convert them as needed for the real
machine.</p>
</div>
<div class="paragraph">
<p>MSIs originating from a single device that require conversion are expected
to have been configured at the device by a single guest OS running within one
RISC-V virtual machine. Assuming the VM itself conforms to the RISC-V Advanced
Interrupt Architecture cite:[AIA], MSIs are sent to virtual harts within the VM by writing
to the memory-mapped registers of the interrupt files of virtual IMSICs. Each of
these virtual interrupt files occupies a separate 4-KiB page in the VM&#8217;s guest
physical address space, the same as real interrupt files do in a real machine&#8217;s
physical address space. A write to a guest physical address can thus be
recognized as an MSI to a virtual hart if the write is to a page occupied by
an interrupt file of a virtual IMSIC within the VM.</p>
</div>
<div class="paragraph">
<p>When MSI address translation is supported (<code>capabilities.MSI_FLAT</code>, <a href="#CAP">[CAP]</a>),
the process to identify an incoming <code>IOVA</code> as the address of a virtual interrupt
file and translating the address using the MSI page table is as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Let <code>A</code> be the <code>GPA</code></p>
</li>
<li>
<p>Let <code>DC</code> be the device-context located using the <code>device_id</code> of the device
using the process outlined in <a href="#GET_DC">Process to locate the Device-context</a>.</p>
</li>
<li>
<p>Determine if the address <code>A</code> is an access to a virtual interrupt file as
specified in <a href="#MSI_ID">MSI address mask (<code>msi_addr_mask</code>) and pattern (<code>msi_addr_pattern</code>)</a>.</p>
</li>
<li>
<p>If the address is not determined to be that of a virtual interrupt file then
stop this process and instead use the regular translation data structures to
do the address translation.</p>
</li>
<li>
<p>Extract an interrupt file number <code>I</code> from <code>A</code> as
<code>I = extract(A &gt;&gt; 12, DC.msi_addr_mask)</code>. The bit extract function
<code>extract(x, y)</code> discards all bits from <code>x</code> whose matching bits in the same
positions in the mask <code>y</code> are zeros, and packs the remaining bits from <code>x</code>
contiguously at the least-significant end of the result, keeping the same bit
order as <code>x</code> and filling any other bits at the most-significant end of the
result with zeros. For example, if the bits of <code>x</code> and <code>y</code> are:</p>
<div class="ulist">
<ul>
<li>
<p><code>x = a b c d e f g h</code></p>
</li>
<li>
<p><code>y = 1 0 1 0 0 1 1 0</code></p>
</li>
<li>
<p>then the value of <code>extract(x, y)</code> has bits <code>0 0 0 0 a c f g</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Let <code>m</code> be <code>(DC.msiptp.PPN x 2<sup>12</sup>)</code>.</p>
</li>
<li>
<p>Let <code>msipte</code> be the value of sixteen bytes at address <code>(m | (I x 16))</code>. If
accessing <code>msipte</code> violates a PMA or PMP check, then stop and report
"MSI PTE load access fault" (cause = 261).</p>
</li>
<li>
<p>If <code>msipte</code> access detects a data corruption (a.k.a. poisoned data), then
stop and report "MSI PT data corruption" (cause = 270).</p>
</li>
<li>
<p>If <code>msipte.V == 0</code>, then stop and report "MSI PTE not valid" (cause = 262).</p>
</li>
<li>
<p>If <code>msipte.C == 1</code>, then further processing to interpret the PTE is
implementation defined.</p>
</li>
<li>
<p>If <code>msipte.C == 0</code> then the process is outlined in subsequent steps.</p>
</li>
<li>
<p>If <code>msipte.M == 0</code> or <code>msipte.M == 2</code>, then stop and report
"MSI PTE misconfigured" (cause = 263).</p>
</li>
<li>
<p>If <code>msipte.M == 3</code> the PTE is in basic translate mode and the translation
process is as follows:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If any bits or encoding that are reserved for future standard use are set
within <code>msipte</code>, stop and report "MSI PTE misconfigured" (cause = 263).</p>
</li>
<li>
<p>Compute the translated address as <code>msipte.PPN &lt;&lt; 12 | A[11:0]</code>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>If <code>msipte.M == 1</code> the PTE is in MRIF mode and the translation process
is as follows:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If <code>capabilities.MSI_MRIF == 0</code>, stop and report "MSI PTE misconfigured"
(cause = 263).</p>
</li>
<li>
<p>If any bits or encoding that are reserved for future standard use are
set within <code>msipte</code>, stop and report "MSI PTE misconfigured" (cause = 263).</p>
</li>
<li>
<p>The address of the destination MRIF is <code>msipte.MRIF_Address[55:9] * 512</code>.</p>
</li>
<li>
<p>The destination address of the notice MSI is <code>msipte.NPPN &lt;&lt; 12</code>.</p>
</li>
<li>
<p>Let <code>NID</code> be <code>(msipte.N10 &lt;&lt; 10) | msipte.N[9:0]</code>. The data value for notice
MSI is the 11-bit <code>NID</code> value zero-extended to 32-bits.</p>
</li>
</ol>
</div>
</li>
<li>
<p>The access permissions associated with the translation determined through this
process are equivalent to that of a regular RISC-V second-stage PTE with
<code>R</code>=<code>W</code>=<code>U</code>=1 and <code>X</code>=0. Similar to a second-stage PTE, when checking the <code>U</code>
bit, the transaction is treated as not requesting supervisor privilege.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If the transaction is an Untranslated or Translated read-for-execute then stop
and report "Instruction access fault" (cause = 1).</p>
</li>
</ol>
</div>
</li>
<li>
<p>MSI address translation process is complete.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In MRIF mode, the Advanced Interrupt Architecture Specification defines the operation to
store the incoming MSIs into the destination MRIF and to generate the notice
MSI. These operations may be performed by the IOMMU itself or the IOMMU may
provide the destination MRIF address, the notice MSI address, and the notice MSI
data value to the I/O bridge in response to the translation request and the
operations may be performed by the I/O bridge.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="iommu-updating-of-pte-accessed-a-and-dirty-d-updates"><a class="anchor" href="#iommu-updating-of-pte-accessed-a-and-dirty-d-updates"></a>IOMMU updating of PTE accessed (A) and dirty (D) updates</h3>
<div class="paragraph">
<p>When <code>capabilities.AMO_HWAD</code> is 1, the IOMMU supports updating the A and D bits in
PTEs atomically. When updating of A and D bits in second-stage PTEs is enabled
(<code>DC.tc.GADE=1</code>) and/or updating of A and D bits in first-stage PTEs is enabled
(<code>DC.tc.SADE=1</code>) the following rules apply:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The A and/or D bit updates by the IOMMU must follow the rules specified by the
Privileged specification for validity, permission checking, and atomicity.</p>
</li>
<li>
<p>The PTE update must be globally visible before a memory access using the
translated address provided by the IOMMU becomes globally visible.
Specifically, when a translated address is provided to a device in an ATS
Translation completion, the PTE update must be globally visible before a
memory access from the device using the translated address becomes globally
visible.</p>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The A and D bits are never cleared by the IOMMU. If the supervisor software does
not rely on accessed and/or dirty bits, e.g. if it does not swap memory pages to
secondary storage or if the pages are being used to map I/O space, it should
set them to 1 in the PTE to improve performance.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="faults-from-virtual-address-translation-process"><a class="anchor" href="#faults-from-virtual-address-translation-process"></a>Faults from virtual address translation process</h3>
<div class="paragraph">
<p>Faults detected during the two-stage address translation specified in the RISC-V
Privileged specification cite:[PRIV] cause the IOVA translation process to stop
and report the detected fault.</p>
</div>
</div>
<div class="sect2">
<h3 id="ATS_FAULTS"><a class="anchor" href="#ATS_FAULTS"></a>PCIe ATS translation request handling</h3>
<div class="paragraph">
<p>ATS cite:[PCI] translation requests that encounter a configuration error results
in a Completer Abort (CA) response to the requester. The following cause codes
belong to this category:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Instruction access fault (cause = 1)</p>
</li>
<li>
<p>Read access fault (cause = 5)</p>
</li>
<li>
<p>Write/AMO access fault (cause = 7)</p>
</li>
<li>
<p>MSI PTE load access fault (cause = 261)</p>
</li>
<li>
<p>MSI PTE misconfigured (cause = 263)</p>
</li>
<li>
<p>PDT entry load access fault (cause = 265)</p>
</li>
<li>
<p>PDT entry misconfigured (cause = 267)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If there is a permanent error or if ATS transactions are disabled then an
Unsupported Request (UR) response is generated. The following cause codes
belong to this category:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>All inbound transactions disallowed (cause = 256)</p>
</li>
<li>
<p>DDT entry load access fault (cause = 257)</p>
</li>
<li>
<p>DDT entry not valid (cause = 258)</p>
</li>
<li>
<p>DDT entry misconfigured (cause = 259)</p>
</li>
<li>
<p>Transaction type disallowed (cause = 260)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When translation could not be completed due to the following causes a Success
Response with R and W bits set to 0 is generated. No faults are logged in
the fault queue on these errors. The translated address returned with such
completions is <code>UNSPECIFIED</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Instruction page fault (cause = 12)</p>
</li>
<li>
<p>Read page fault (cause = 13)</p>
</li>
<li>
<p>Write/AMO page fault (cause = 15)</p>
</li>
<li>
<p>Instruction guest page fault (cause = 20)</p>
</li>
<li>
<p>Read guest-page fault (cause = 21)</p>
</li>
<li>
<p>Write/AMO guest-page fault (cause = 23)</p>
</li>
<li>
<p>PDT entry not valid (cause = 266)</p>
</li>
<li>
<p>MSI PTE not valid (cause = 262)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the translation request has a PASID with "Privilege Mode Requested" field set
to 0, or the request does not have a PASID then the request does not target
privileged memory. If the U-bit that indicates if the memory is accessible to
user mode is 0 then a Success response with R and W bits set to 0 is generated.</p>
</div>
<div class="paragraph">
<p>If the translation request has a PASID with "Privilege Mode Requested" field set
to 1, then the request targets privileged memory. If the U-bit that indicates if
the page is accessible to user mode is 1 and the <code>SUM</code> bit in the <code>ta</code> field of the
process-context is 0 then a Success response with R and W bits set to 0 is
generated.</p>
</div>
<div class="paragraph">
<p>If the translation could be successfully completed but the requested
permissions are not present in either stage (Execute requested but no execute permission;
no-write not requested and no write permission; no read permission)
then a Success response is returned with the denied permission (R, W or X)
set to 0 and the other permission bits set to the value determined from the
page tables. The X permission is granted only if the R permission is also
granted and the execute permission was requested. Execute-only translations are
not compatible with PCIe ATS as PCIe requires read permission to be granted
if the execute permission is granted.</p>
</div>
<div class="paragraph">
<p>When a Success response is generated for an ATS translation request, no fault
records are reported to software through the fault/event reporting mechanism,
even when the response indicates no access was granted or some permissions were
denied. Conversely, when a UR or CA response is generated for an ATS translation
request, the corresponding fault is reported to software through the fault/event
reporting mechanism.</p>
</div>
<div class="paragraph">
<p>If the translation request has an address determined to be an MSI address using
the rules defined by the <a href="#MSI_ID">MSI address mask (<code>msi_addr_mask</code>) and pattern (<code>msi_addr_pattern</code>)</a> but the MSI PTE is configured in MRIF
mode then a Success response is generated with R, W, and U bit set to 1. The U
bit being set to 1 in the response instructs the device that it must only use
Untranslated requests to access the implied 4 KiB memory range.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When a MSI PTE is configured in MRIF mode, a MSI write with data value <code>D</code>
requires the IOMMU to set the interrupt-pending bit for interrupt identity <code>D</code>
in the MRIF. A translation request from a device to a GPA that is mapped
through a MRIF mode MSI PTE is not eligible to receive a translated address.
This is accomplished by setting "Untranslated Access Only" (U) field of the
returned response to 1.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The translation range size returned in a Success response to an ATS translation
request, when either stages of address translation are Bare, is
implementation-defined. However, it is recommended that the translation range
size be large, such as 2 MiB or 1 GiB.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When a Success response is generated for an ATS translation request, the setting
of the Priv, N, CXL.io, Global, and AMA fields is as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Priv field of the ATS translation completion is always set to 0 if the request
does not have a PASID. When a PASID is present then the Priv field is set to
the value in "Privilege Mode Requested" field as the permissions provided
correspond to those the privilege mode indicate in the request.</p>
</li>
<li>
<p>N field of the ATS translation completion is always set to 0. The device may
use other means to determine if the No-snoop flag should be set in the
translated requests.</p>
</li>
<li>
<p>Global field is set to the value determined from the first-stage page tables
if translation could be successfully completed and the request had a PASID
present. In all other cases, including MSI address translations, this field
is set to 0.</p>
</li>
<li>
<p>If requesting device is not a CXL device then CXL.io is set to 0.</p>
</li>
<li>
<p>If requesting device is a CXL type 1 or type 2 device</p>
<div class="ulist">
<ul>
<li>
<p>If the address is determined to be a MSI then the CXL.io bit is set to 1.</p>
</li>
<li>
<p>Else if <code>T2GPA</code> is 1 in the device context then the CXL.io bit is set to 1.</p>
</li>
<li>
<p>Else if the memory type, as determined by the Svpbmt extension, is NC or IO
then the CXL.io bit is set to 1. If the memory type is PMA then the
determination of the setting of this bit is <code>UNSPECIFIED</code>. If the Svpbmt
extension is not supported then the setting of this bit is <code>UNSPECIFIED</code>.</p>
</li>
<li>
<p>In all other cases the setting of this bit is <code>UNSPECIFIED</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>The AMA field is by default set to 000b. The IOMMU may support an
implementation-specific method to provide other encodings.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The IO bridge may override the CXL.io bit in the ATS translation completion
based on the PMA of the translated address. Other implementations may provide
an implementation-defined method for determining PMA for the translated address
to set the CXL.io bit.</p>
</div>
<div class="paragraph">
<p>Use of <code>T2GPA</code> set to 1 may not be compatible with CXL type 1 or type 2 devices
as they use the CXL.cache protocol to implement caches tagged by the translated
address returned in response to a PCIe ATS Translation Request. The IOMMU may
not be invoked for translating addresses in CXL.cache transactions.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="ATS_PRI"><a class="anchor" href="#ATS_PRI"></a>PCIe ATS Page Request handling</h3>
<div class="paragraph">
<p>To process a "Page Request" or "Stop Marker" message cite:[PCI], the IOMMU first locates
the device-context to determine if ATS and PRI are enabled for the requester.
If ATS and PRI are enabled, i.e. <code>EN_ATS</code> and <code>EN_PRI</code> are both set to 1, the
 IOMMU queues the message into an in-memory queue called the
page-request-queue (<code>PQ</code>) (See <a href="#PRQ">[PRQ]</a>). Following suitable processing of the
"Page Request", a software handler may generate a "Page Request Group Response"
message to the device.</p>
</div>
<div class="paragraph">
<p>When PRI is enabled for a device, the IOMMU may still be unable to report
"Page Request" or "Stop Marker" messages through the <code>PQ</code> due to error
conditions such as the queue being disabled, queue being full, or the IOMMU
encountering access faults when attempting to access queue memory. These error
conditions are specified in <a href="#PRQ">[PRQ]</a>.</p>
</div>
<div class="paragraph">
<p>If the <code>ddtp.iommu_mode</code> is <code>Bare</code> or is <code>Off</code>, then the IOMMU cannot locate a
device-context for the requester.</p>
</div>
<div class="paragraph">
<p>If <code>EN_PRI</code> is set to 0, or <code>EN_ATS</code> is set to 0, or if the IOMMU is unable
to locate the <code>DC</code> to determine the <code>EN_PRI</code> configuration, or the request
could not be queued into <code>PQ</code> then the IOMMU behavior depends on the type
of "Page Request".</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the "Page Request" does not require a response, i.e. the "Last Request in
PRG" field of the message is set to 0, then such messages are silently
discarded. "Stop Marker" messages do not require a response and are always
silently discarded on such errors.</p>
</li>
<li>
<p>If the "Page Request" needs a response, then the IOMMU itself may generate
a "Page Request Group Response" message to the device.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When the IOMMU generates the response, the status field of the response depends
on the cause of the error. If a fault condition prevents locating a valid device
context then the <code>PRPR</code> value assumed is 0.</p>
</div>
<div style="page-break-after: always;"></div>
<div class="paragraph">
<p>The status is set to Response Failure if the following faults are encountered:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ddtp.iommu_mode</code> is <code>Off</code> (cause = 256)</p>
</li>
<li>
<p>DDT entry load access fault (cause = 257)</p>
</li>
<li>
<p>DDT entry misconfigured (cause = 259)</p>
</li>
<li>
<p>DDT entry not valid (cause = 258)</p>
</li>
<li>
<p>Page-request queue is not enabled (<code>pqcsr.pqen == 0</code> or <code>pqcsr.pqon == 0</code>)</p>
</li>
<li>
<p>Page-request queue encountered a memory access fault (<code>pqcsr.pqmf == 1</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The status is set to Invalid Request if the following faults are encountered:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ddtp.iommu_mode</code> is <code>Bare</code> (cause = 260)</p>
</li>
<li>
<p><code>EN_PRI</code> is set to 0 (cause = 260)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The status is set to Success if no other faults were encountered but the
"Page Request" could not be queued due to the page-request queue being full
(<code>pqt == pqh - 1</code>) or had a overflow (<code>pqcsr.pqof == 1</code>).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When SR-IOV VF is used as a unit of allocation, a hypervisor may disable page
requests from one of the virtual functions by setting <code>EN_PRI</code> to 0. However the
page-request interface is shared by the PF and all VFs.  The IOMMU protocol
specific logic classifies this condition (cause = 260) as a non-catastrophic
failure, an Invalid Request, in its response to avoid the shared PRI in the
device being disabled for all PFs/VFs.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A "Stop Marker" is encoded as a "Page Request" with a PASID but with the L, W,
and R fields set to 1, 0, and 0 respectively.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For IOMMU-generated "Page Request Group Response" messages that have status
Invalid Request or Success, the PRG-response-PASID-required (<code>PRPR</code>) bit when
set to 1 indicates that the IOMMU response message should include a PASID if the
associated "Page Request" had a PASID.</p>
</div>
<div class="paragraph">
<p>For IOMMU-generated "Page Request Group Response" with response code set to
Response Failure, if the "Page Request" had a PASID then response is generated
with a PASID.</p>
</div>
<div class="paragraph">
<p>No faults are logged in the fault queue for PCIe ATS "Page Request" messages for
the following conditions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Page-request queue is not enabled (<code>pqcsr.pqen == 0</code> or <code>pqcsr.pqon == 0</code>)</p>
</li>
<li>
<p>Page-request queue encountered a memory access fault (<code>pqcsr.pqmf == 1</code>)</p>
</li>
<li>
<p>"Page Request" could not be queued due to the page-request queue being full
(<code>pqt == pqh - 1</code>) or had a overflow (<code>pqcsr.pqof == 1</code>).</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="CACHING"><a class="anchor" href="#CACHING"></a>Caching in-memory data structures</h3>
<div class="paragraph">
<p>To speed up Direct Memory Access (DMA) translations, the IOMMU may make use of
translation caches to hold entries from device-directory-table,
process-directory-table, first-stage and second-stage translation tables, and
MSI page tables. These caches are collectively referred to as the IOMMU Address
Translation Caches (IOATC).</p>
</div>
<div class="paragraph">
<p>This specification does not allow the caching of first/second-stage PTEs whose
<code>V</code> (valid) bit is clear, non-leaf DDT entries whose <code>V</code> (valid) bit is clear,
Device-context whose <code>V</code> (valid) bit is clear, non-leaf PDT entries whose <code>V</code>
(valid) bit is clear, Process-context whose <code>V</code> (valid) bit is clear, or MSI
PTEs whose <code>V</code> bit is clear.</p>
</div>
<div class="paragraph">
<p>These IOATC do not observe modifications to the in-memory data structures using
explicit loads and stores by RISC-V harts or by device DMA. Software must use
the IOMMU commands to invalidate the cached data structure entries using IOMMU
commands to synchronize the IOMMU operations to observe updates to in-memory
data structures. A simpler implementation may not implement IOATC for some or
any of the in-memory data structures. The IOMMU commands may use one or
more IDs to tag the cached entries to identify a specific entry or a
group of entries.</p>
</div>
<table class="tableblock frame-all grid-all fit-content center">
<caption class="title">Table 5. Identifiers used to tag IOATC entries</caption>
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">Data Structure cached</th>
<th class="tableblock halign-center valign-top">IDs used to tag entries</th>
<th class="tableblock halign-center valign-top">Invalidation command</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Device Directory Table</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>device_id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#IDDT">IODIR.INVAL_DDT</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Process Directory Table</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>device_id</code>, <code>process_id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#IPDT">IODIR.INVAL_PDT</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">First-stage page table
 (when second-stage is
  not Bare)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GSCID</code>, <code>PSCID</code>, and IOVA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#IVMA">IOTINVAL.VMA</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">First-stage page table
 (when second-stage is
  Bare)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PSCID</code>, and IOVA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#IVMA">IOTINVAL.VMA</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Second-stage page table</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GSCID</code>, <code>GPA</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#IGVMA">IOTINVAL.GVMA</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MSI page table</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GSCID</code>, <code>GPA</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#IGVMA">IOTINVAL.GVMA</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="updating-in-memory-data-structure-entries"><a class="anchor" href="#updating-in-memory-data-structure-entries"></a>Updating in-memory data structure entries</h3>
<div class="paragraph">
<p>The RISC-V memory model requires memory access from a hart to be single-copy
atomic. When RV32 is implemented the size of a single-copy atomic memory access
is up to 32-bits. When RV64 is implemented the size of a single-copy atomic
memory access is up to 64-bits. The size of a single-copy atomic memory access
implemented by the IOMMU is <code>UNSPECIFIED</code> but is required to be at least 32-bits
if all of the harts in the system implement RV32 and is required to be at least
64-bits if any of the harts in the system implement RV64.</p>
</div>
<div class="paragraph">
<p>The IOMMU data structure entries have a <code>V</code> bit that when set to 1 indicates
that the entry is valid.</p>
</div>
<div class="paragraph">
<p>Software is allowed to make updates to a data structure entry that has the <code>V</code>
bit set to 1. However, some rules as outlined below must be followed.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It is generally unsafe for software to update fields of a valid data structure
entry using a set of stores of width less than the minimal single-copy atomic
memory access supported by an IOMMU as it is legal for an IOMMU to read the
entry at any time, including when only some of the partial stores have taken
effect.<br></p>
</li>
<li>
<p>For an update to an IOMMU data structure entry to be atomic, software must use
a single store of width equal to the minimal single-copy atomic memory access
supported by an IOMMU.<br></p>
</li>
<li>
<p>If the update to a field will make the field inconsistent with another field
of the entry then software must first set the <code>V</code> field to 0 and use the commands
outlined in <a href="#CACHING">Caching in-memory data structures</a> to invalidate any previous copies of that entry that
may be in IOMMU caches before updating other fields of that entry.<br></p>
</li>
<li>
<p>The IOMMU is not required to immediately observe the software update to an
entry. Software must use the commands outlined in <a href="#CACHING">Caching in-memory data structures</a> to invalidate
any previous copies of that entry that may be in IOMMU caches to synchronize
the updates to the entry with the operation of the IOMMU.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If a data structure entry is changed, the IOMMU may use the old value of the
entry or the new value of the entry and the choice is unpredictable until
software uses the commands outlined in <a href="#CACHING">Caching in-memory data structures</a> to invalidate any previous
copies of that entry that may be in IOMMU caches to synchronize updates to the
entry with the operation of the IOMMU. These are the only behaviors expected.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="endianness-of-in-memory-data-structures"><a class="anchor" href="#endianness-of-in-memory-data-structures"></a>Endianness of in-memory data structures</h3>
<div class="paragraph">
<p>The RISC-V memory model specifies byte-invariance for the entire address space.
When mixed-endian mode of operation is supported, the IO bridge and the IOMMU
must implement byte-invariant addressing such that a byte access to a given
address accesses the same memory location in both little-endian and big-endian
mode of operation.</p>
</div>
<div class="paragraph">
<p>The endianness of implicit memory access to in-memory data structures is
determined by <code>fctl.BE</code> or by <code>DC.tc.SBE</code> as follows:</p>
</div>
<table id="ENDIAN_CONFIG" class="tableblock frame-all grid-all fit-content center">
<caption class="title">Table 6. Endianness of memory access to data structures</caption>
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">Data Structure</th>
<th class="tableblock halign-center valign-top">Controlled by</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Device directory table</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fctl.BE</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Second-stage page table</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fctl.BE</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MSI page table</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fctl.BE</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Process directory Table</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DC.tc.SBE</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">First-stage page table</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DC.tc.SBE</code></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>PSCID</code> field of first-stage context, along with the <code>GSCID</code> (when two-stage
address translation is active), identifies an address space. Configuring an
identical <code>GSCID</code> and <code>PSCID</code> in two DC but with different <code>SBE</code> is not expected
and if done may lead to the IOMMU interpreting a first-stage PTE as big-endian
or little-endian. These are the only behaviors expected.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Software must use an appropriate software sequence to swap bytes as necessary to
create a mutually agreed to data representation when sharing data with an IO
agent that does not share its endianness. Software must use an LR/SC sequence to
perform atomic operations in non-native endian format when the data shared with
such IO agents must be accessed atomically.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="iommu_intro.html">Introduction</a></span>
  <span class="next"><a href="iommu_in_memory_queues.html">In-memory queue interface</a></span>
</nav>
</article>  </div>
</main>
<div class="modal micromodal-slide" id="modal-versions" aria-hidden="true">
    <div class="modal__overlay" tabindex="-1" data-micromodal-close>
        <div class="modal__container" role="dialog" aria-modal="true">
            <main class="modal__content" id="modal-versions-content">
              <button data-micromodal-close class="modal-versions-close">
                <svg width="28px" height="28px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><defs><style>.cls-1h{fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:2px;}</style></defs><title/><g id="cross"><line class="cls-1h" x1="7" x2="25" y1="7" y2="25"/><line class="cls-1h" x1="7" x2="25" y1="25" y2="7"/></g></svg>
              </button>
                  <ul class="nav-versions">
                      <li class="component">
                        <div>
                          <a class="title" href="../../ffh/v1.0/index.html">ACPI Functional Fixed Hardware</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="../../ffh/v1.0/index.html">
      v1.0
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                      <li class="component">
                        <div>
                          <a class="title" href="../../aia/v1.0/index.html">Advanced Interrupt Architecture</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="../../aia/v1.0/index.html">
      v1.0
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                      <li class="component">
                        <div>
                          <a class="title" href="../../etrace/v1.0/index.html">E-Trace Encapsulation Specification</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="../../etrace/v1.0/index.html">
      v1.0
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                      <li class="component">
                        <div>
                          <a class="title" href="../../psabi/v1.0/index.html">ELF psABI Specification</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="../../psabi/v1.0/index.html">
      v1.0
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                      <li class="component">
                        <div>
                          <a class="title" href="index.html">IOMMU Architecture</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="index.html">
      v1.0
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                      <li class="component">
                        <div>
                          <a class="title" href="../../isa/index.html">ISA Specifications</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="../../isa/index.html">
      default
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                      <li class="component">
                        <div>
                          <a class="title" href="../../reri/v1.0/index.html">RERI Architecture</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="../../reri/v1.0/index.html">
      v1.0
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                      <li class="component">
                        <div>
                          <a class="title" href="../../qos/v1.0/index.html">RISC-V Capacity and Bandwidth QoS Register Interface</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="../../qos/v1.0/index.html">
      v1.0
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                      <li class="component">
                        <div>
                          <a class="title" href="../../plic/v1.0.0/index.html">RISC-V Platform-Level Interrupt Controller</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="../../plic/v1.0.0/index.html">
      v1.0.0
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                      <li class="component">
                        <div>
                          <a class="title" href="../../semihost/v1.0/index.html">semihosting</a>
                        </div>                        <div class="version-item is-active">
                          <div>
                            <button class="version-toggle" type="button">
                              <span></span>
                              Stable
                            </button>
                          </div>
                          <ul class="versions">
  <li class="version">
    <a href="../../semihost/v1.0/index.html">
      v1.0
    </a>
  </li>
</ul>                        </div>
                        
                      </li>
                  </ul>
            </main>
        </div>
    </div>
</div>

</div>
<footer class="hidden">
</footer><script src="../../_/js/vendor/import.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
<script async src="../../_/js/vendor/spring-tabs.js" data-sync-storage-key="docs:preferred-tab"></script>
  </body>
</html>
